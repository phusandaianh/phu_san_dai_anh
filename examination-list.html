<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Danh sách khám - Phòng khám Phụ Sản Đại Anh</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="utilities.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .appointment-row .actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }
        #appointments-body tr:hover {
            background-color: #e3f2fd;
            cursor: pointer;
        }
        .btn.danger-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 5px;
        }
        .btn.danger-btn:hover {
            background-color: #c82333;
        }
        .btn.danger-btn i {
            margin-right: 4px;
        }
        
        .speak-btn {
            background: #ff7043;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .speak-btn:hover {
            background: #f4511e;
        }
        
        .speak-btn i {
            margin-right: 4px;
        }
        
        .zalo-btn {
            background: #0068ff;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
            font-size: 0.9rem;
        }
        
        .zalo-btn:hover {
            background: #0056cc;
        }
        
        .settings-btn {
            background: #607d8b;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        
        .settings-btn:hover {
            background: #546e7a;
        }
        
        .settings-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        }
        
        .settings-modal.active {
            display: flex;
        }
        
        .settings-card {
            background: #fff;
            border-radius: 14px;
            padding: 1.2rem;
            width: 95%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
        }
        
        .settings-row { display: grid; grid-template-columns: 160px 1fr; gap: 1rem; align-items: start; }
        .settings-row + .settings-row { margin-top: 0.9rem; }
        .settings-actions { display: flex; gap: 0.6rem; justify-content: flex-end; margin-top: 1rem; }
        .btn { border: none; padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; }
        .btn.primary { background: #1565c0; color: #fff; }
        .btn.secondary { background: #e0e0e0; }
        .btn.warn { background: #ef5350; color: #fff; }
        
        /* Tab styling */
        .tab-btn.active {
            background: #1565c0 !important;
            color: white !important;
            font-weight: bold;
        }
        
        .tab-content {
            min-height: 200px;
        }
        
        /* Range input styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #1565c0;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #1565c0;
            cursor: pointer;
            border: none;
        }
        
        /* Search suggestions styling */
        .suggestion-item:hover {
            background-color: #f5f5f5;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        /* Nút đóng đặc biệt cho modal phiếu chỉ định */
        #clinical-form-modal .close-btn {
            background-color: #dc3545 !important; 
            color: white !important; 
            border: none !important; 
            border-radius: 50% !important; 
            width: 60px !important; 
            height: 60px !important; 
            font-size: 30px !important; 
            cursor: pointer !important; 
            display: flex !important; 
            align-items: center !important; 
            justify-content: center !important;
            font-weight: bold !important;
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3) !important;
            transition: all 0.3s ease !important;
        }
        
        #clinical-form-modal .close-btn:hover {
            background-color: #c82333 !important;
            transform: scale(1.1) !important;
        }

        /* Full screen layout like patient-records.html */
        .admin-header {
            background-color: white;
            color: #2196F3;
            padding: 1rem 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #2196F3;
        }
        .admin-header .logo img {
            height: 50px;
            margin-right: 10px;
        }
        .admin-header .logo {
            display: flex;
            align-items: center;
        }
        .admin-header nav {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        .admin-header .nav-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .admin-header .back-link {
            color: #2196F3;
            text-decoration: none;
            display: flex;
            align-items: center;
        }
        .admin-header .back-link.btn.secondary-btn {
            background-color: transparent;
            border: 1px solid #2196F3;
            color: #2196F3;
        }
        .admin-main {
            padding: 20px;
        }
        .examination-list {
            padding: 0;
        }
        .examination-list h2 {
            text-align: left;
            margin-bottom: 0;
        }
        .appointments-container {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="logo">
            <img src="logo_phu_san_dai_anh.PNG" alt="Logo Phòng khám Đại Anh">
            <div>
                <h1>Danh sách khám</h1>
                <p style="margin: 0; font-size: 0.9rem; color: #666;">Quản lý lịch khám bệnh nhân</p>
            </div>
        </div>
        <nav>
            <div class="nav-row">
                <a href="index.html" class="back-link btn secondary-btn">
                    <i class="fas fa-home"></i> Trang chủ
                </a>
                <a href="patient-records.html" class="back-link btn secondary-btn">
                    <i class="fas fa-users"></i> Hồ sơ bệnh nhân
                </a>
                <a href="admin.html" class="back-link btn secondary-btn">
                    <i class="fas fa-cog"></i> Quản trị
                </a>
            </div>
        </nav>
    </header>

    <main class="admin-main">
        <section class="examination-list">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                <h2 style="margin: 0;">Danh sách khám ngày hôm nay</h2>
                <a class="btn primary-btn" href="patient-records.html"><i class="fas fa-users"></i> Danh sách bệnh nhân</a>
                <a class="btn primary-btn" href="booking.html"><i class="fas fa-plus"></i> Đặt lịch khám mới</a>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <div style="display:flex; align-items:center; gap:.5rem;">
                    <label for="filter-date" style="font-weight: 500;">Ngày khám:</label>
                    <input type="date" id="filter-date" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" />
                    <button id="btn-today" class="btn secondary-btn" type="button">Hôm nay</button>
                </div>
            </div>
            
            <div class="appointments-container">
                <div class="appointments-list">
                    <div class="search-box" style="position: relative;">
                        <input type="text" id="search-patient" placeholder="Tìm kiếm theo tên hoặc số điện thoại..." style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <div id="search-suggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <!-- Suggestions will be populated here -->
                        </div>
                    </div>
                    <div class="appointments-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>PID</th>
                                    <th>Họ tên</th>
                                    <th>Năm sinh</th>
                                    <th>Điện thoại</th>
                                    <th>Giờ hẹn</th>
                                    <th>Lý do khám</th>
                                    <th>Chẩn đoán</th>
                                    <th>Trạng thái</th>
                                    <th>Phiếu khám</th>
                                    <th>Phiếu chỉ định</th>
                                    <th>Thao tác
                                        <div style="margin-top:6px; display:flex; gap:6px; justify-content:flex-start;">
                                            <button id="header-edit-btn" class="btn primary-btn" disabled>Sửa</button>
                                            <button id="header-delete-btn" class="btn danger-btn" disabled>Xóa</button>
                                        </div>
                                    </th>
                                    <th style="text-align:right;">Gọi
                                        <button class="settings-btn" style="margin-left: 8px;" onclick="openAnnouncementSettings()">
                                            <i class="fas fa-cog"></i>
                                        </button>
                                    </th>
                                </tr>
                            </thead>
                        <tbody id="appointments-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="clinical-services">
                    <h3>Dịch vụ cận lâm sàng của bệnh nhân</h3>
                <div class="services-list" id="services-list"></div>
                    <div class="selected-services">
                        <h4>Dịch vụ đã chọn</h4>
                    <div id="selected-services-list"></div>
                        <div class="total-amount">
                            <span>Tổng cộng:</span>
                            <span id="total-amount">0đ</span>
                        </div>
                        <button id="print-clinical-service" class="btn primary-btn" disabled>
                            <i class="fas fa-print"></i> In phiếu chỉ định
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2026 Phòng khám chuyên khoa Phụ Sản Đại Anh. All rights reserved.</p>
        </div>
    </footer>

    <!-- Modal chọn dịch vụ -->
    <div id="service-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Thêm dịch vụ cho bệnh nhân</h2>
            <div class="service-categories">
                <div class="service-category">
                    <input type="radio" id="ultrasound-pregnancy" name="service-type" value="Siêu âm thai">
                    <label for="ultrasound-pregnancy">Siêu âm thai</label>
                </div>
                <div class="service-category">
                    <input type="radio" id="ultrasound-other" name="service-type" value="Siêu âm khác">
                    <label for="ultrasound-other">Siêu âm khác</label>
                </div>
                <div class="service-category">
                    <input type="radio" id="blood-test" name="service-type" value="Xét nghiệm máu">
                    <label for="blood-test">Xét nghiệm máu</label>
                </div>
                <div class="service-category">
                    <input type="radio" id="fluid-test" name="service-type" value="Xét nghiệm dịch">
                    <label for="fluid-test">Xét nghiệm dịch</label>
                </div>
                <div class="service-category">
                    <input type="radio" id="other-services" name="service-type" value="Các dịch vụ khác">
                    <label for="other-services">Các dịch vụ khác</label>
                </div>
                <div class="service-category">
                    <input type="radio" id="all-services" name="service-type" value="Tất cả các dịch vụ">
                    <label for="all-services">Tất cả các dịch vụ</label>
                </div>
                <div class="service-category">
                    <input type="radio" id="package-services" name="service-type" value="Gói cận lâm sàng">
                    <label for="package-services">Gói cận lâm sàng</label>
                </div>
            </div>
        <div id="service-list" class="service-list"></div>
            <div class="modal-actions">
                <button id="save-services" class="btn primary-btn">Lưu</button>
                <button id="close-service-modal" class="btn secondary-btn">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Modal sửa thông tin bệnh nhân -->
    <div id="patient-edit-modal" class="modal hidden">
        <div class="modal-content" style="max-width:520px;">
            <h2>Sửa thông tin bệnh nhân</h2>
            <div style="display:grid; grid-template-columns: 120px 1fr; gap: 10px; align-items:center;">
                <label for="edit-name">Họ tên</label>
                <input id="edit-name" type="text" />
                <label for="edit-phone">Điện thoại</label>
                <input id="edit-phone" type="text" />
                <label for="edit-dob">Ngày sinh</label>
                <input id="edit-dob" type="date" />
                <label for="edit-address">Địa chỉ</label>
                <input id="edit-address" type="text" />
                <label for="edit-reason">Lý do khám</label>
                <input id="edit-reason" type="text" />
                <label for="edit-diagnosis">Chẩn đoán</label>
                <input id="edit-diagnosis" type="text" />
                <label for="edit-notes">Ghi chú</label>
                <input id="edit-notes" type="text" />
                <label for="edit-doctor">Bác sĩ chỉ định</label>
                <select id="edit-doctor">
                    <option value="PK Đại Anh">PK Đại Anh</option>
                </select>
            </div>
            <div class="modal-actions" style="margin-top:16px;">
                <button id="save-patient-btn" class="btn primary-btn">Lưu</button>
                <button id="close-patient-modal" class="btn secondary-btn">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Modal nhập kết quả cận lâm sàng (chung cho tất cả dịch vụ) -->
    <div id="clinical-result-modal" class="modal hidden">
        <div class="modal-content" style="max-width:900px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2><i class="fas fa-file-medical"></i> Nhập kết quả cận lâm sàng</h2>
                <button class="close-modal" onclick="closeClinicalResultModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
            </div>
            <div id="clinical-result-content">
                <!-- Content will be loaded dynamically based on service type -->
            </div>
        </div>
    </div>

    <!-- Modal nhập kết quả siêu âm (giữ lại để tương thích) -->
    <div id="ultrasound-result-modal" class="modal hidden">
        <div class="modal-content" style="max-width:900px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2><i class="fas fa-file-medical"></i> Nhập kết quả siêu âm</h2>
                <button class="close-modal" onclick="closeUltrasoundModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
            </div>
            <form id="ultrasound-result-form">
                <input type="hidden" id="ultrasound-appointment-id" />
                <input type="hidden" id="ultrasound-patient-id" />
                <input type="hidden" id="ultrasound-result-id" />
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div>
                        <label for="ultrasound-exam-date">Ngày siêu âm *</label>
                        <input type="datetime-local" id="ultrasound-exam-date" required />
                    </div>
                    <div>
                        <label for="ultrasound-gestational-age">Tuổi thai (tuần)</label>
                        <input type="number" id="ultrasound-gestational-age" step="0.1" min="0" max="42" />
                    </div>
                </div>

                <h3 style="margin:20px 0 10px 0; color:#2196F3;">Chỉ số thai nhi</h3>
                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px; margin-bottom:15px;">
                    <div>
                        <label for="ultrasound-bpd">BPD (mm)</label>
                        <input type="number" id="ultrasound-bpd" step="0.1" />
                    </div>
                    <div>
                        <label for="ultrasound-hc">HC (mm)</label>
                        <input type="number" id="ultrasound-hc" step="0.1" />
                    </div>
                    <div>
                        <label for="ultrasound-ac">AC (mm)</label>
                        <input type="number" id="ultrasound-ac" step="0.1" />
                    </div>
                    <div>
                        <label for="ultrasound-fl">FL (mm)</label>
                        <input type="number" id="ultrasound-fl" step="0.1" />
                    </div>
                </div>

                <h3 style="margin:20px 0 10px 0; color:#2196F3;">Chỉ số Doppler</h3>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:15px;">
                    <div>
                        <label for="ultrasound-ri-umbilical">RI động mạch rốn</label>
                        <input type="number" id="ultrasound-ri-umbilical" step="0.01" min="0" max="1" />
                    </div>
                    <div>
                        <label for="ultrasound-sd-ratio">S/D ratio</label>
                        <input type="number" id="ultrasound-sd-ratio" step="0.1" />
                    </div>
                    <div>
                        <label for="ultrasound-mca-pi">MCA PI</label>
                        <input type="number" id="ultrasound-mca-pi" step="0.01" />
                    </div>
                </div>

                <h3 style="margin:20px 0 10px 0; color:#2196F3;">Thông tin khác</h3>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:15px;">
                    <div>
                        <label for="ultrasound-cervical-length">Chiều dài cổ tử cung (mm)</label>
                        <input type="number" id="ultrasound-cervical-length" step="0.1" />
                    </div>
                    <div>
                        <label for="ultrasound-afi">AFI (cm)</label>
                        <input type="number" id="ultrasound-afi" step="0.1" />
                    </div>
                    <div>
                        <label for="ultrasound-estimated-weight">Cân nặng ước tính (g)</label>
                        <input type="number" id="ultrasound-estimated-weight" step="1" />
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div>
                        <label for="ultrasound-fetal-position">Ngôi thai</label>
                        <select id="ultrasound-fetal-position">
                            <option value="">-- Chọn --</option>
                            <option value="Ngôi đầu">Ngôi đầu</option>
                            <option value="Ngôi mông">Ngôi mông</option>
                            <option value="Ngôi ngang">Ngôi ngang</option>
                        </select>
                    </div>
                    <div>
                        <label for="ultrasound-placenta-position">Vị trí nhau</label>
                        <input type="text" id="ultrasound-placenta-position" />
                    </div>
                </div>

                <div style="margin-bottom:15px;">
                    <label for="ultrasound-amniotic-fluid">Nước ối</label>
                    <select id="ultrasound-amniotic-fluid">
                        <option value="">-- Chọn --</option>
                        <option value="Bình thường">Bình thường</option>
                        <option value="Dư ối">Dư ối</option>
                        <option value="Thiếu ối">Thiếu ối</option>
                        <option value="Đa ối">Đa ối</option>
                    </select>
                </div>

                <div style="margin-bottom:15px;">
                    <label for="ultrasound-findings">Nhận xét / Phát hiện</label>
                    <textarea id="ultrasound-findings" rows="4" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;"></textarea>
                </div>

                <div style="margin-bottom:20px;">
                    <label for="ultrasound-recommendations">Khuyến nghị</label>
                    <textarea id="ultrasound-recommendations" rows="3" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn secondary-btn" onclick="closeUltrasoundModal()">Hủy</button>
                    <button type="button" class="btn success-btn" onclick="printUltrasoundResult()" id="print-ultrasound-btn" style="display:none;">
                        <i class="fas fa-print"></i> In kết quả
                    </button>
                    <button type="submit" class="btn primary-btn">
                        <i class="fas fa-save"></i> Lưu kết quả
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal for Announcement -->
    <div id="announcement-settings" class="settings-modal" role="dialog" aria-modal="true">
        <div class="settings-card">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 0.6rem;">
                <div style="color: #1565c0; font-size: 1.2rem; font-weight: bold;">Cài đặt âm thanh thông báo</div>
                <button class="btn secondary" onclick="closeAnnouncementSettings()">Đóng</button>
            </div>

            <!-- Tab Navigation -->
            <div style="display: flex; border-bottom: 1px solid #ddd; margin-bottom: 1rem;">
                <button class="tab-btn active" onclick="switchTab('voice', this)" style="flex: 1; padding: 0.5rem; border: none; background: #f5f5f5; cursor: pointer;">Giọng đọc</button>
                <button class="tab-btn" onclick="switchTab('sound', this)" style="flex: 1; padding: 0.5rem; border: none; background: #f5f5f5; cursor: pointer;">Âm thanh</button>
                <button class="tab-btn" onclick="switchTab('template', this)" style="flex: 1; padding: 0.5rem; border: none; background: #f5f5f5; cursor: pointer;">Mẫu</button>
                <button class="tab-btn" onclick="switchTab('voluson', this)" style="flex: 1; padding: 0.5rem; border: none; background: #f5f5f5; cursor: pointer;">Voluson</button>
            </div>

            <!-- Voice Tab -->
            <div id="voice-tab" class="tab-content">
                <div class="settings-row">
                    <label for="voice-select" style="font-weight:600; color:#1565c0;">Giọng đọc</label>
                    <div>
                        <select id="voice-select" style="width:100%; padding:0.5rem; border-radius:8px; border:1px solid #ddd;"></select>
                        <div style="font-size:0.9rem; color:#666; margin-top:0.3rem;">Ưu tiên giọng nữ tiếng Việt (vi-VN).</div>
                        <div id="voice-instructions" style="font-size:0.8rem; color:#e65100; margin-top:0.5rem; padding:0.5rem; background:#fff3e0; border-radius:4px; border-left:3px solid #ff9800;">
                            <strong>Hướng dẫn cài đặt giọng đọc tiếng Việt NỮ:</strong><br>
                            <strong>Windows:</strong> Settings → Time & Language → Language → Vietnamese → Options → Add voice → Chọn giọng nữ<br>
                            <strong>Hoặc Control Panel:</strong> Speech → Text to Speech → Voice selection → Add more voices<br>
                            <strong>Chrome:</strong> chrome://settings/languages → Thêm Vietnamese → Install voice pack<br>
                            <strong>Edge:</strong> edge://settings/languages → Vietnamese → Download speech
                        </div>
                        <button type="button" onclick="refreshVoices()" style="margin-top:0.5rem; padding:0.3rem 0.8rem; background:#4caf50; color:white; border:none; border-radius:4px; cursor:pointer; font-size:0.8rem;">
                            <i class="fas fa-sync-alt"></i> Làm mới danh sách giọng
                        </button>
                    </div>
                </div>

                <div class="settings-row">
                    <label style="font-weight:600; color:#1565c0;">Tốc độ & Cao độ</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.6rem;">
                        <div>
                            <div style="font-size:0.9rem; color:#444;">Tốc độ đọc</div>
                            <input id="rate-input" type="range" min="0.6" max="1.4" step="0.1" value="1" style="width:100%;" />
                            <div style="font-size:0.8rem; color:#888; text-align:center;" id="rate-value">1.0</div>
                        </div>
                        <div>
                            <div style="font-size:0.9rem; color:#444;">Cao độ</div>
                            <input id="pitch-input" type="range" min="0.6" max="1.4" step="0.1" value="1" style="width:100%;" />
                            <div style="font-size:0.8rem; color:#888; text-align:center;" id="pitch-value">1.0</div>
                        </div>
                    </div>
                </div>

                <div class="settings-row">
                    <label style="font-weight:600; color:#1565c0;">Âm lượng</label>
                    <div>
                        <input id="volume-input" type="range" min="0" max="1" step="0.1" value="1" style="width:100%;" />
                        <div style="font-size:0.8rem; color:#888; text-align:center;" id="volume-value">100%</div>
                    </div>
                </div>
            </div>

            <!-- Sound Tab -->
            <div id="sound-tab" class="tab-content" style="display: none;">
                <div class="settings-row">
                    <label style="font-weight:600; color:#1565c0;">Âm thanh thông báo</label>
                    <div>
                        <select id="notification-sound" style="width:100%; padding:0.5rem; border-radius:8px; border:1px solid #ddd;">
                            <option value="none">Không có âm thanh</option>
                            <option value="beep">Tiếng bíp</option>
                            <option value="bell">Tiếng chuông</option>
                            <option value="chime">Tiếng chuông nhẹ</option>
                            <option value="custom">Âm thanh tùy chỉnh</option>
                        </select>
                    </div>
                </div>

                <div class="settings-row">
                    <label style="font-weight:600; color:#1565c0;">Tần số âm thanh</label>
                    <div>
                        <input id="sound-frequency" type="range" min="200" max="2000" step="50" value="800" style="width:100%;" />
                        <div style="font-size:0.8rem; color:#888; text-align:center;" id="frequency-value">800 Hz</div>
                    </div>
                </div>

                <div class="settings-row">
                    <label style="font-weight:600; color:#1565c0;">Thời lượng âm thanh</label>
                    <div>
                        <input id="sound-duration" type="range" min="0.1" max="2" step="0.1" value="0.5" style="width:100%;" />
                        <div style="font-size:0.8rem; color:#888; text-align:center;" id="duration-value">0.5 giây</div>
                    </div>
                </div>

                <div class="settings-row">
                    <label style="font-weight:600; color:#1565c0;">Lặp lại âm thanh</label>
                    <div>
                        <input id="sound-repeat" type="range" min="1" max="5" step="1" value="1" style="width:100%;" />
                        <div style="font-size:0.8rem; color:#888; text-align:center;" id="repeat-value">1 lần</div>
                    </div>
                </div>
            </div>

            <!-- Template Tab -->
            <div id="template-tab" class="tab-content" style="display: none;">
                <div class="settings-row">
                    <label for="announcement-template" style="font-weight:600; color:#1565c0;">Mẫu nội dung</label>
                    <div>
                        <textarea id="announcement-template" rows="3" style="width:100%; padding:0.6rem; border-radius:8px; border:1px solid #ddd;" placeholder="Mời khách hàng {name}, phiếu khám số {queue}, vào phòng khám."></textarea>
                        <div style="font-size:0.9rem; color:#666; margin-top:0.3rem;">
                            Biến có thể dùng: {name}, {queue}, {time}, {doctor}
                        </div>
                    </div>
                </div>

                <div class="settings-row">
                    <label style="font-weight:600; color:#1565c0;">Mẫu có sẵn</label>
                    <div>
                        <select id="template-presets" style="width:100%; padding:0.5rem; border-radius:8px; border:1px solid #ddd;" onchange="loadTemplatePreset()">
                            <option value="">Chọn mẫu có sẵn...</option>
                            <option value="basic">Mẫu cơ bản</option>
                            <option value="polite">Mẫu lịch sự</option>
                            <option value="detailed">Mẫu chi tiết</option>
                            <option value="urgent">Mẫu khẩn cấp</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Voluson Tab -->
            <div id="voluson-tab" class="tab-content" style="display: none;">
                <div class="settings-row">
                    <label style="font-weight:600; color:#1565c0;">Đồng bộ với Voluson E10</label>
                    <div>
                        <label style="display:flex; align-items:center; gap:0.5rem;">
                            <input type="checkbox" id="voluson-sync-enabled" style="transform: scale(1.2);">
                            <span>Tự động đồng bộ dịch vụ siêu âm với máy Voluson E10</span>
                        </label>
                        <div style="font-size:0.9rem; color:#666; margin-top:0.3rem;">
                            Khi bật, các dịch vụ siêu âm sẽ tự động được gửi đến worklist của máy siêu âm
                        </div>
                    </div>
                </div>

                <div class="settings-row">
                    <label style="font-weight:600; color:#1565c0;">Cấu hình kết nối</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.6rem;">
                        <div>
                            <div style="font-size:0.9rem; color:#444;">IP máy Voluson</div>
                            <input id="voluson-ip" type="text" value="10.17.2.1" style="width:100%; padding:0.4rem; border-radius:4px; border:1px solid #ddd;" />
                        </div>
                        <div>
                            <div style="font-size:0.9rem; color:#444;">Cổng DICOM</div>
                            <input id="voluson-port" type="number" value="104" style="width:100%; padding:0.4rem; border-radius:4px; border:1px solid #ddd;" />
                        </div>
                    </div>
                </div>

                <div class="settings-row">
                    <label style="font-weight:600; color:#1565c0;">Trạng thái kết nối</label>
                    <div>
                        <div id="voluson-status" style="padding:0.5rem; border-radius:4px; background:#f5f5f5; font-size:0.9rem;">
                            <span id="voluson-status-text">Chưa kiểm tra</span>
                        </div>
                        <button type="button" onclick="testVolusonConnection()" style="margin-top:0.5rem; padding:0.3rem 0.8rem; background:#2196f3; color:white; border:none; border-radius:4px; cursor:pointer; font-size:0.8rem;">
                            <i class="fas fa-network-wired"></i> Kiểm tra kết nối
                        </button>
                    </div>
                </div>

                <div class="settings-row">
                    <label style="font-weight:600; color:#1565c0;">Dịch vụ tự động đồng bộ</label>
                    <div>
                        <div style="font-size:0.9rem; color:#666; margin-bottom:0.5rem;">
                            Các dịch vụ có nhóm chứa "siêu âm" sẽ được tự động đồng bộ:
                        </div>
                        <div id="ultrasound-services" style="max-height:150px; overflow-y:auto; border:1px solid #ddd; border-radius:4px; padding:0.5rem; background:#f9f9f9;">
                            <div style="font-style:italic; color:#888;">Đang tải danh sách...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-actions">
                <button class="btn" onclick="testAnnouncementSample()"><i class="fas fa-volume-up"></i> Phát thử</button>
                <button class="btn" onclick="testNotificationSound()"><i class="fas fa-bell"></i> Thử âm thanh</button>
                <button class="btn warn" onclick="resetAnnouncementDefaults()">Mặc định</button>
                <button class="btn primary" onclick="saveAnnouncementSettings()">Lưu</button>
            </div>
        </div>
    </div>

    <script>
    // API endpoints
        const API_ENDPOINTS = {
        APPOINTMENTS_TODAY: '/api/appointments/today',
        APPOINTMENTS_BY_DATE: d => `/api/appointments/by-date?date=${encodeURIComponent(d)}`,
            CLINICAL_SERVICES: '/api/clinical-services',
        APPOINTMENT_SERVICES: id => `/api/appointments/${id}/clinical-services`
    };

    // State
    const state = { currentAppointmentId: null, selectedServices: new Set(), allServices: [], pollTimer: null, lastAppointmentsData: null };

    // Utils
    const formatCurrency = n => (n || 0).toLocaleString('vi-VN') + 'đ';
    const showError = msg => { console.error(msg); alert(msg); };

        const api = {
            async get(url) {
                const r = await fetch(url);
                if (!r.ok) {
                    let text = await r.text().catch(()=>'');
                    throw new Error(`${r.status} ${text}`);
                }
                return r.json();
            },
            async post(url, data) {
                const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (!r.ok) {
                    let text = await r.text().catch(()=>'');
                    throw new Error(`${r.status} ${text}`);
                }
                return r.json();
            }
    };

    // Load dịch vụ của bệnh nhân
        async function loadPatientClinicalServices(appointmentId) {
                const services = await api.get(API_ENDPOINTS.APPOINTMENT_SERVICES(appointmentId));
        const list = document.getElementById('services-list');
        const selectedList = document.getElementById('selected-services-list');
        if (!services.length) {
            list.innerHTML = '<i>Chưa có dịch vụ nào.</i>';
            if (selectedList) selectedList.innerHTML = '<i>Chưa chọn dịch vụ nào.</i>';
                } else {
            // Render each service with delete button on the left and print button on the right
            list.innerHTML = services.map(s => {
                const isUltrasound = (s.service_group && s.service_group.toLowerCase().includes('siêu âm')) || 
                                     (s.name && s.name.toLowerCase().includes('siêu âm'));
                // Bỏ hiển thị nút nhập kết quả cho các dịch vụ thuộc nhóm "Các dịch vụ khác"
                // Theo clinical-services-admin.html, giá trị trong DB là "dịch vụ khác" (không có "Các")
                const serviceGroupLower = (s.service_group || '').toLowerCase().trim();
                
                // Kiểm tra chính xác: giá trị trong DB là "dịch vụ khác"
                // Cũng kiểm tra các biến thể có thể có
                const isOtherService = serviceGroupLower === 'dịch vụ khác' || 
                                      serviceGroupLower === 'các dịch vụ khác' ||
                                      (serviceGroupLower.includes('dịch vụ khác') && serviceGroupLower.length <= 20); // Tránh match nhầm với các chuỗi dài
                
                const showResultBtn = !isOtherService;
                
                return `
                <div class="service-item" data-link-id="${s.id}" data-service-id="${s.service_id}" style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding:8px; border-bottom:1px solid #eee;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <button class="btn danger-btn service-delete-btn" data-appointment-id="${appointmentId}" data-service-id="${s.service_id}" title="Xóa dịch vụ">
                            <i class="fas fa-trash"></i>
                        </button>
                        <div class="service-info">
                            <h4 style="margin:0">${s.name}</h4>
                            <p style="margin:0">${s.description || ''}</p>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        ${showResultBtn ? `
                        <button class="btn primary-btn service-result-btn" data-appointment-id="${appointmentId}" data-service-id="${s.service_id}" data-service-name="${s.name}" data-is-ultrasound="${isUltrasound}" title="Nhập kết quả">
                            <i class="fas fa-file-medical"></i> Nhập kết quả
                        </button>
                        ` : ''}
                        <button class="btn success-btn service-print-btn" data-appointment-id="${appointmentId}" data-service-id="${s.service_id}" title="In phiếu cho dịch vụ">
                            <i class="fas fa-print"></i>
                        </button>
                    </div>
                </div>
            `;
            }).join('');
            if (selectedList) {
                selectedList.innerHTML = services.map(s => `
                    <div class="selected-service-item">
                        <span>${s.name}</span>
                        <span>${formatCurrency(s.price)}</span>
                    </div>
                `).join('');
            }
            // Delete button event handlers are now handled in the actions column
        }
        const total = services.reduce((sum, s) => sum + (s.price || 0), 0);
        document.getElementById('total-amount').textContent = formatCurrency(total);
        const printBtn = document.getElementById('print-clinical-service');
        if (printBtn) printBtn.disabled = services.length === 0;
    }

    // Load dịch vụ đã chọn
    async function loadSelectedServices() {
        const services = await api.get(API_ENDPOINTS.APPOINTMENT_SERVICES(state.currentAppointmentId));
        state.selectedServices.clear();
        services.forEach(s => state.selectedServices.add(s.service_id));
        const printBtn = document.getElementById('print-clinical-service');
        if (printBtn) printBtn.disabled = services.length === 0;
    }

    // Lưu dịch vụ đã chọn
    async function saveSelectedServices() {
        if (!state.currentAppointmentId) {
            alert('Vui lòng chọn bệnh nhân trước khi lưu dịch vụ');
            return;
        }
        try {
            const appointmentId = state.currentAppointmentId;
            const current = await api.get(API_ENDPOINTS.APPOINTMENT_SERVICES(appointmentId));
            // current contains: id (link id), service_id (master id)
            const currentServiceIds = current.map(s => s.service_id);
            const newServiceIds = [...state.selectedServices]; // these are master service ids (ClinicalServiceSetting.id)
            const toDelete = current.filter(s => !newServiceIds.includes(s.service_id));
            const toAdd = newServiceIds.filter(id => !currentServiceIds.includes(id));

            // Delete using master service_id (backend expects /.../clinical-services/<service_id>)
            for (const s of toDelete) {
                const resp = await fetch(`${API_ENDPOINTS.APPOINTMENT_SERVICES(appointmentId)}/${s.service_id}`, { method: 'DELETE' });
                if (!resp.ok) {
                    const txt = await resp.text().catch(()=>'');
                    throw new Error(`Lỗi khi xóa dịch vụ: ${txt || resp.status}`);
                }
            }
            // Add by posting master service_id
            for (const id of toAdd) {
                await api.post(API_ENDPOINTS.APPOINTMENT_SERVICES(appointmentId), { service_id: id });
            }

            alert('Đã lưu dịch vụ!');
            closeServiceModal();
            // Reload: appointments table and selected services panel
            await loadAppointments();
            if (appointmentId) await loadPatientClinicalServices(appointmentId);
            
            // Tự động đồng bộ sang lab-tests.html và lab-tests-dai-anh.html
            await syncToLabTestsPages(appointmentId);
        } catch (error) {
            console.error('Lỗi khi lưu dịch vụ:', error);
            alert('Có lỗi xảy ra khi lưu dịch vụ: ' + (error.message || error));
        }
    }

    // Hàm đồng bộ tự động sang các trang lab-tests
    async function syncToLabTestsPages(appointmentId) {
        try {
            // Lấy thông tin appointment để lấy ngày
            const appointment = await api.get(`/api/appointments/${appointmentId}`);
            if (!appointment || !appointment.appointment_date) return;
            
            const appointmentDate = new Date(appointment.appointment_date);
            const dateStr = appointmentDate.toISOString().slice(0, 10); // YYYY-MM-DD
            
            // Đồng bộ theo ngày của appointment
            const syncResponse = await fetch('/api/lab-orders/sync-range', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ start: dateStr, end: dateStr })
            });
            
            if (syncResponse.ok) {
                const syncData = await syncResponse.json();
                console.log('Đã đồng bộ tự động:', syncData);
                
                // Thông báo các tab khác (lab-tests.html, lab-tests-dai-anh.html) tự động refresh
                notifyLabTestsPages();
            }
        } catch (error) {
            console.error('Lỗi khi đồng bộ tự động:', error);
            // Không hiển thị lỗi cho user, chỉ log
        }
    }

    // Thông báo các trang lab-tests tự động refresh
    function notifyLabTestsPages() {
        try {
            // Sử dụng BroadcastChannel để thông báo giữa các tab
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('lab-tests-sync');
                channel.postMessage({ type: 'sync-request', timestamp: Date.now() });
                channel.close();
            }
            
            // Fallback: sử dụng localStorage event
            const event = new Event('lab-tests-sync');
            localStorage.setItem('lab-tests-sync-trigger', Date.now().toString());
            window.dispatchEvent(event);
        } catch (error) {
            console.error('Lỗi khi thông báo các trang lab-tests:', error);
        }
    }

    // Thông báo các trang xem kết quả cận lâm sàng tự động refresh
    function notifyClinicalResultsPages(appointmentId) {
        try {
            // Sử dụng BroadcastChannel để thông báo giữa các tab
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('clinical-results-sync');
                channel.postMessage({ 
                    type: 'service-deleted', 
                    appointmentId: appointmentId,
                    timestamp: Date.now() 
                });
                channel.close();
            }
            
            // Fallback: sử dụng localStorage event
            localStorage.setItem('clinical-results-sync-trigger', JSON.stringify({
                type: 'service-deleted',
                appointmentId: appointmentId,
                timestamp: Date.now()
            }));
            window.dispatchEvent(new Event('clinical-results-sync'));
        } catch (error) {
            console.error('Lỗi khi thông báo các trang kết quả cận lâm sàng:', error);
        }
    }

    // Modal dịch vụ
    async function openServiceModal(id) {
        state.currentAppointmentId = id;
        document.getElementById('service-modal').classList.remove('hidden');
        if (!state.allServices.length) state.allServices = await api.get(API_ENDPOINTS.CLINICAL_SERVICES);
                await loadSelectedServices();
        const first = document.querySelector('input[name="service-type"]');
        if (first) { first.checked = true; filterServices(first.value); }
    }
        function closeServiceModal() {
        document.getElementById('service-modal').classList.add('hidden');
            state.currentAppointmentId = null;
            state.selectedServices.clear();
        }

    // Lọc dịch vụ
        function filterServices(category) {
        const list = document.getElementById('service-list');
        const map = { 'Siêu âm thai':'siêu âm thai','Siêu âm khác':'siêu âm khác','Xét nghiệm máu':'xét nghiệm máu','Xét nghiệm dịch':'xét nghiệm dịch','Các dịch vụ khác':'dịch vụ khác' };
        let filtered = [];
        if (category === 'Tất cả các dịch vụ') filtered = state.allServices;
        else if (category === 'Gói cận lâm sàng')
            filtered = state.allServices.filter(s => (s.name||'').toLowerCase().includes('gói') || (s.description||'').toLowerCase().includes('gói'));
        else filtered = state.allServices.filter(s => (s.service_group||'').toLowerCase() === map[category]);

        if (!filtered.length) { list.innerHTML = '<i>Không có dịch vụ.</i>'; return; }
        list.innerHTML = filtered.map(s => `
                    <div class="service-item">
                        <label>
                    <input type="checkbox" class="service-checkbox" value="${s.id}" ${state.selectedServices.has(s.id) ? 'checked' : ''}>
                    ${s.name} <span class="service-price">${formatCurrency(s.price)}</span>
                        </label>
                    </div>
                `).join('');
        list.querySelectorAll('.service-checkbox').forEach(cb => {
            cb.onchange = () => {
                const id = parseInt(cb.value);
                if (cb.checked) state.selectedServices.add(id);
                else state.selectedServices.delete(id);
            };
        });
    }

    // Xóa bệnh nhân
    async function deleteAppointment(appointmentId) {
        // Tìm thông tin bệnh nhân để hiển thị trong cảnh báo
        const dateInput = document.getElementById('filter-date');
        const selected = dateInput && dateInput.value ? dateInput.value : null;
        const appointments = selected ? await api.get(API_ENDPOINTS.APPOINTMENTS_BY_DATE(selected)) : await api.get(API_ENDPOINTS.APPOINTMENTS_TODAY);
        const appointment = appointments.find(a => a.id == appointmentId);
        
        if (!appointment) {
            alert('Không tìm thấy thông tin bệnh nhân!');
            return;
        }

        // Hiển thị cảnh báo với thông tin chi tiết
        const confirmMessage = `Bạn có chắc chắn muốn xóa bệnh nhân này?\n\n` +
                              `Họ tên: ${appointment.patient_name}\n` +
                              `Số điện thoại: ${appointment.patient_phone}\n` +
                              `Giờ hẹn: ${new Date(appointment.appointment_date).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', hour12: false })}\n` +
                              `Dịch vụ: ${appointment.service_type}\n\n` +
                              `⚠️ Lưu ý: Khung giờ này sẽ được giải phóng và có thể đăng ký lại.`;
        
        if (!confirm(confirmMessage)) {
            return;
        }

        try {
            // Gọi API xóa bệnh nhân
            const response = await fetch(`/api/appointments/${appointmentId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Không thể xóa bệnh nhân');
            }

            const result = await response.json();
            
            // Reload danh sách bệnh nhân
            await loadAppointments();
            
            // Clear dịch vụ nếu đang xem bệnh nhân bị xóa
            if (state.currentAppointmentId == appointmentId) {
                document.getElementById('services-list').innerHTML = '<i>Chọn bệnh nhân để xem dịch vụ.</i>';
                document.getElementById('total-amount').textContent = '0đ';
                state.currentAppointmentId = null;
            }

        } catch (error) {
            console.error('Lỗi khi xóa bệnh nhân:', error);
            alert('Có lỗi xảy ra khi xóa bệnh nhân: ' + error.message);
        }
    }

    // Load appointments
    async function loadAppointments() {
        const dateInput = document.getElementById('filter-date');
        const selected = dateInput && dateInput.value ? dateInput.value : null;
        // Build server-side search query (search by name or phone)
        const searchInputEl = document.getElementById('search-patient');
        const q = searchInputEl ? (searchInputEl.value || '').trim() : '';
        let url;
        if (selected) {
            url = `/api/appointments/by-date?date=${encodeURIComponent(selected)}` + (q ? `&q=${encodeURIComponent(q)}` : '');
        } else {
            url = `/api/appointments/today` + (q ? `?q=${encodeURIComponent(q)}` : '');
        }
        const appts = await api.get(url);
        
        // Compare with last data to avoid unnecessary re-rendering
        const currentDataKey = JSON.stringify(appts.map(a => ({
            id: a.id,
            status: a.status,
            service_type: a.service_type,
            diagnosis: a.diagnosis,
            notes: a.notes
        })));
        
        // Only re-render if data actually changed
        if (state.lastAppointmentsData === currentDataKey) {
            // Data unchanged, just update cache for suggestions
            allAppointments = appts;
            return;
        }
        
        // Update cache
        state.lastAppointmentsData = currentDataKey;
        allAppointments = appts;
        const tbody = document.getElementById('appointments-body');
        tbody.innerHTML = appts.map((a,i)=>`
            <tr data-appointment-id="${a.id}">
                <td>${i+1}</td><td>${a.patient_pid || a.patient_phone}</td><td>${a.patient_name}</td><td>${a.patient_dob ? new Date(a.patient_dob).getFullYear() : ''}</td><td>${a.patient_phone}</td>
                <td>${new Date(a.appointment_date).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', hour12: false })}</td>
                <td>${a.service_type}</td>
                <td class="diagnosis-cell" data-appointment-id="${a.id}"><i>nhấp để nhập</i></td>
                <td>${a.status}</td>
                <td>
                    <button class="btn primary-btn print-examination-btn" data-appointment-id="${a.id}" data-service-type="${a.service_type || ''}" title="Sửa phiếu khám">
                        <i class="fas fa-edit"></i> Sửa phiếu khám
                    </button>
                </td>
                <td>
                    <button class="btn success-btn print-clinical-btn" data-appointment-id="${a.id}" title="In phiếu chỉ định cận lâm sàng">
                        <i class="fas fa-print"></i> In phiếu
                    </button>
                </td>
                <td>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <button class="btn primary-btn add-service-btn" data-appointment-id="${a.id}">Thêm dịch vụ</button>
                        <button class="btn danger-btn delete-service-btn" data-appointment-id="${a.id}">Xóa dịch vụ</button>
                    </div>
                </td>
                <td style="text-align:right;">
                    <div style="display: flex; flex-direction: column; gap: 5px; align-items: flex-end;">
                        <button class="speak-btn" title="Gọi vào phòng" data-name="${a.patient_name}" data-queue="${i+1}">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <button class="zalo-btn" title="Mở Zalo" data-phone="${a.patient_phone}">
                            Zalo
                        </button>
                    </div>
                </td>
            </tr>`).join('');
        // Helper: update header action buttons disabled state
        const updateHeaderActionState = () => {
            const hasSelection = !!state.currentAppointmentId;
            const editBtn = document.getElementById('header-edit-btn');
            const delBtn = document.getElementById('header-delete-btn');
            if (editBtn) editBtn.disabled = !hasSelection;
            if (delBtn) delBtn.disabled = !hasSelection;
        };

        // Row click to load services and set selection
        tbody.querySelectorAll('tr').forEach(tr=>{
            const id=tr.dataset.appointmentId;
            tr.onclick=e=>{ 
                if (!e.target.classList.contains('add-service-btn')) {
                    state.currentAppointmentId = id;
                    loadPatientClinicalServices(id); 
                    updateHeaderActionState();
                }
            };
        });
        // Populate diagnosis values async (read-only display)
        tbody.querySelectorAll('.diagnosis-cell').forEach(cell => {
            const id = cell.dataset.appointmentId;
            fetch(`/api/appointments/${id}/diagnosis`).then(r=>r.ok?r.json():Promise.reject()).then(js=>{
                const text = (js && js.diagnosis) ? js.diagnosis : '';
                cell.textContent = text || '—';
            }).catch(()=>{ cell.textContent = '—'; });
            // Remove click functionality - diagnosis can only be edited through the patient edit modal
            cell.style.cursor = 'default';
            cell.title = 'Chẩn đoán - chỉnh sửa qua modal Sửa thông tin bệnh nhân';
        });
        
        tbody.querySelectorAll('.add-service-btn').forEach(btn=>{
            btn.onclick=e=>{ e.stopPropagation(); openServiceModal(btn.dataset.appointmentId); };
        });
        
        // Add event handler for delete service button
        tbody.querySelectorAll('.delete-service-btn').forEach(btn=>{
            btn.onclick=async e=>{ 
                e.stopPropagation(); 
                const appointmentId = btn.dataset.appointmentId;
                if (!confirm('Bạn có chắc chắn muốn xóa tất cả dịch vụ cận lâm sàng của bệnh nhân này?')) return;
                
                try {
                    // Get current services for this appointment
                    const services = await api.get(API_ENDPOINTS.APPOINTMENT_SERVICES(appointmentId));
                    if (!services.length) {
                        alert('Bệnh nhân chưa có dịch vụ cận lâm sàng nào.');
                        return;
                    }
                    
                    // Delete all services
                    for (const service of services) {
                        const resp = await fetch(`${API_ENDPOINTS.APPOINTMENT_SERVICES(appointmentId)}/${service.service_id}`, { method: 'DELETE' });
                        if (!resp.ok) {
                            let txt = await resp.text().catch(()=>'');
                            alert('Không thể xóa dịch vụ: ' + (txt || resp.status));
                            return;
                        }
                    }
                    
                    alert('Đã xóa tất cả dịch vụ cận lâm sàng của bệnh nhân.');
                    await loadPatientClinicalServices(appointmentId);
                } catch (error) {
                    console.error('Lỗi khi xóa dịch vụ:', error);
                    alert('Có lỗi xảy ra khi xóa dịch vụ: ' + error.message);
                }
            };
        });
        // Header action buttons
        const headerEdit = document.getElementById('header-edit-btn');
        const headerDelete = document.getElementById('header-delete-btn');
        if (headerEdit) headerEdit.onclick = async (e) => {
            e.stopPropagation();
            if (!state.currentAppointmentId) { alert('Vui lòng chọn bệnh nhân.'); return; }
            try {
                // Lấy thông tin bệnh nhân từ bản ghi lịch hẹn hiện tại để biết patient_id
                const dateInput = document.getElementById('filter-date');
                const selected = dateInput && dateInput.value ? dateInput.value : null;
                const appts = selected ? await api.get(API_ENDPOINTS.APPOINTMENTS_BY_DATE(selected)) : await api.get(API_ENDPOINTS.APPOINTMENTS_TODAY);
                const appt = appts.find(a => String(a.id) === String(state.currentAppointmentId));
                if (!appt) { alert('Không tìm thấy bệnh nhân.'); return; }
                const patientId = appt.patient_id;
                const p = await api.get(`/api/patients/${patientId}`);
                
                // Load doctors list
                const doctorsResponse = await api.get('/api/doctors');
                const doctorSelect = document.getElementById('edit-doctor');
                doctorSelect.innerHTML = '';
                doctorsResponse.doctors.forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor;
                    option.textContent = doctor;
                    doctorSelect.appendChild(option);
                });
                
                // Get current diagnosis
                let currentDiagnosis = '';
                try {
                    const diagnosisResponse = await fetch(`/api/appointments/${state.currentAppointmentId}/diagnosis`);
                    if (diagnosisResponse.ok) {
                        const diagnosisData = await diagnosisResponse.json();
                        currentDiagnosis = diagnosisData.diagnosis || '';
                    }
                } catch (err) {
                    console.error('Lỗi tải chẩn đoán:', err);
                }
                
                // Get current notes
                let currentNotes = '';
                try {
                    const notesResponse = await fetch(`/api/appointments/${state.currentAppointmentId}/notes`);
                    if (notesResponse.ok) {
                        const notesData = await notesResponse.json();
                        currentNotes = notesData.notes || '';
                    }
                } catch (err) {
                    console.error('Lỗi tải ghi chú:', err);
                }
                
                // Prefill modal
                document.getElementById('edit-name').value = p.name || '';
                document.getElementById('edit-phone').value = p.phone || '';
                document.getElementById('edit-dob').value = p.date_of_birth || '';
                document.getElementById('edit-address').value = p.address || '';
                document.getElementById('edit-reason').value = appt.service_type || '';
                document.getElementById('edit-diagnosis').value = currentDiagnosis;
                document.getElementById('edit-notes').value = currentNotes;
                document.getElementById('edit-doctor').value = appt.doctor_name || 'PK Đại Anh';
                document.getElementById('patient-edit-modal').classList.remove('hidden');
                // Save handler
                const saveBtn = document.getElementById('save-patient-btn');
                saveBtn.onclick = async () => {
                    try {
                        console.log('Bắt đầu lưu thông tin bệnh nhân...');
                        const payload = {
                            name: document.getElementById('edit-name').value.trim(),
                            phone: document.getElementById('edit-phone').value.trim(),
                            date_of_birth: document.getElementById('edit-dob').value || null,
                            address: document.getElementById('edit-address').value.trim()
                        };
                        console.log('Payload bệnh nhân:', payload);
                        const r = await fetch(`/api/patients/${patientId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!r.ok) {
                            const t = await r.text().catch(()=> '');
                            console.error('Lỗi cập nhật bệnh nhân:', r.status, r.statusText, t);
                            alert('Cập nhật thất bại: ' + (t || r.status));
                            return;
                        }
                        console.log('Cập nhật bệnh nhân thành công');
                        // Update lý do khám, chẩn đoán, ghi chú và bác sĩ chỉ định
                        const reason = document.getElementById('edit-reason').value.trim();
                        const diagnosis = document.getElementById('edit-diagnosis').value.trim();
                        const notes = document.getElementById('edit-notes').value.trim();
                        const doctor = (document.getElementById('edit-doctor').value || 'PK Đại Anh').trim() || 'PK Đại Anh';
                        
                        console.log('Dữ liệu cập nhật:', { reason, diagnosis, notes, doctor });
                        
                        // Update appointment (reason and doctor)
                        console.log('Cập nhật appointment...');
                        const r2 = await fetch(`/api/appointments/${state.currentAppointmentId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ service_type: reason, doctor_name: doctor }) });
                        if (!r2.ok) {
                            const t2 = await r2.text().catch(()=> '');
                            console.error('Lỗi cập nhật appointment:', r2.status, r2.statusText, t2);
                            alert('Cập nhật lịch khám thất bại: ' + (t2 || r2.status));
                            return;
                        }
                        console.log('Cập nhật appointment thành công');
                        
                        // Update diagnosis
                        console.log('Cập nhật chẩn đoán...');
                        const r3 = await fetch(`/api/appointments/${state.currentAppointmentId}/diagnosis`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ diagnosis: diagnosis }) });
                        if (!r3.ok) {
                            const t3 = await r3.text().catch(()=> '');
                            console.error('Lỗi cập nhật chẩn đoán:', r3.status, r3.statusText, t3);
                            alert('Cập nhật chẩn đoán thất bại: ' + (t3 || r3.status));
                            return;
                        }
                        console.log('Cập nhật chẩn đoán thành công');
                        
                        // Update notes
                        console.log('Cập nhật ghi chú...');
                        const r4 = await fetch(`/api/appointments/${state.currentAppointmentId}/notes`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ notes: notes }) });
                        if (!r4.ok) {
                            const t4 = await r4.text().catch(()=> '');
                            console.error('Lỗi cập nhật ghi chú:', r4.status, r4.statusText, t4);
                            alert('Cập nhật ghi chú thất bại: ' + (t4 || r4.status));
                            return;
                        }
                        console.log('Cập nhật ghi chú thành công');
                        
                        console.log('Tất cả cập nhật thành công!');
                        document.getElementById('patient-edit-modal').classList.add('hidden');
                        await loadAppointments();
                    } catch (error) {
                        console.error('Lỗi trong quá trình lưu:', error);
                        alert('Có lỗi xảy ra khi lưu thông tin: ' + error.message);
                    }
                };
                document.getElementById('close-patient-modal').onclick = () => {
                    document.getElementById('patient-edit-modal').classList.add('hidden');
                };
            } catch(err) {
                console.error(err);
                alert('Không thể tải thông tin bệnh nhân.');
            }
        };
        if (headerDelete) headerDelete.onclick = (e) => {
            e.stopPropagation();
            if (!state.currentAppointmentId) { alert('Vui lòng chọn bệnh nhân.'); return; }
            deleteAppointment(state.currentAppointmentId);
        };
        updateHeaderActionState();
    }

    // DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            // Đảm bảo voices được load khi trang khởi động
            ensureVoicesLoaded(() => {
                const voices = window.speechSynthesis.getVoices();
                console.log('Voices loaded on page init:', voices.length);
                const viVoices = voices.filter(v => {
                    const lang = (v.lang || '').toLowerCase();
                    return lang.startsWith('vi') || lang.includes('vietnamese');
                });
                if (viVoices.length > 0) {
                    console.log('Vietnamese voices found:', viVoices.map(v => `${v.name} (${v.lang})`));
                    // Tự động chọn giọng nữ tiếng Việt đầu tiên nếu chưa có giọng được lưu
                    if (!localStorage.getItem(VOICE_KEY)) {
                        const femaleVi = viVoices.find(v => {
                            const name = (v.name || '').toLowerCase();
                            return /female|nu|nữ|my|hoaimy|woman|girl/i.test(name);
                        });
                        if (femaleVi) {
                            localStorage.setItem(VOICE_KEY, femaleVi.name);
                            console.log('Auto-selected Vietnamese female voice:', femaleVi.name);
                        }
                    }
                } else {
                    console.warn('No Vietnamese voices found. Please install Vietnamese language pack.');
                }
            });
            
            loadAppointments();
        document.getElementById('services-list').innerHTML='<i>Chọn bệnh nhân để xem dịch vụ.</i>';
        document.getElementById('save-services').onclick=saveSelectedServices;
        document.getElementById('close-service-modal').onclick=closeServiceModal;
        document.querySelectorAll('input[name="service-type"]').forEach(r=>r.onchange=()=>filterServices(r.value));
            // Auto refresh periodically and on focus
            const startPolling = () => {
                if (state.pollTimer) clearInterval(state.pollTimer);
                state.pollTimer = setInterval(() => { loadAppointments().catch(()=>{}); }, 8000);
            };
            startPolling();
            document.addEventListener('visibilitychange', () => { if (!document.hidden) loadAppointments(); });
            const fd = document.getElementById('filter-date');
            const todayBtn = document.getElementById('btn-today');
            if (fd) fd.onchange = () => { state.lastAppointmentsData = null; loadAppointments(); };
            if (todayBtn) todayBtn.onclick = () => { const t = new Date().toISOString().split('T')[0]; fd.value = t; state.lastAppointmentsData = null; loadAppointments(); };
            
            // Search input: allow search by patient name or registered phone number
            const searchInput = document.getElementById('search-patient');
            
            // Reset cache when search changes
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        state.lastAppointmentsData = null;
                        loadAppointments();
                    }, 300);
                });
            }
            const suggestionsDiv = document.getElementById('search-suggestions');
            let allAppointments = []; // Cache for suggestions
            
            // Load all appointments for suggestions
            async function loadAllAppointmentsForSuggestions() {
                try {
                    const dateInput = document.getElementById('filter-date');
                    const selected = dateInput && dateInput.value ? dateInput.value : null;
                    let url;
                    if (selected) {
                        url = `/api/appointments/by-date?date=${encodeURIComponent(selected)}`;
                    } else {
                        url = `/api/appointments/today`;
                    }
                    allAppointments = await api.get(url);
                } catch (error) {
                    console.error('Error loading appointments for suggestions:', error);
                    allAppointments = [];
                }
            }
            
            // Show search suggestions
            function showSuggestions(query) {
                if (!query || query.length < 2) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                
                const filtered = allAppointments.filter(apt => 
                    (apt.patient_name && apt.patient_name.toLowerCase().includes(query.toLowerCase())) ||
                    (apt.patient_phone && apt.patient_phone.includes(query))
                );
                
                if (filtered.length === 0) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                
                suggestionsDiv.innerHTML = filtered.slice(0, 5).map(apt => `
                    <div class="suggestion-item" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;" 
                         onclick="selectSuggestion('${apt.patient_name}', '${apt.patient_phone}')">
                        <div style="font-weight: bold;">${apt.patient_name}</div>
                        <div style="font-size: 12px; color: #666;">${apt.patient_phone} - ${new Date(apt.appointment_date).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', hour12: false })}</div>
                    </div>
                `).join('');
                
                suggestionsDiv.style.display = 'block';
            }
            
            // Select suggestion
            window.selectSuggestion = function(name, phone) {
                searchInput.value = name;
                suggestionsDiv.style.display = 'none';
                loadAppointments();
            };
            
            // Debounced server-side search: typing triggers loadAppointments() which passes q to API
            if (searchInput) {
                let searchDebounce = null;
                searchInput.addEventListener('input', () => {
                    const query = searchInput.value.trim();
                    
                    // Show suggestions
                    showSuggestions(query);
                    
                    // Debounced search
                    if (searchDebounce) clearTimeout(searchDebounce);
                    searchDebounce = setTimeout(() => {
                        loadAppointments().catch(()=>{});
                        searchDebounce = null;
                    }, 350);
                });
                
                // Hide suggestions when clicking outside
                document.addEventListener('click', (e) => {
                    if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                        suggestionsDiv.style.display = 'none';
                    }
                });
                
                // Load suggestions on focus
                searchInput.addEventListener('focus', () => {
                    if (allAppointments.length === 0) {
                        loadAllAppointmentsForSuggestions();
                    }
                });
            }
        
        // Khởi tạo cài đặt âm thanh thông báo
        initializeAnnouncementSettings();
        
        // Add event listeners for range inputs to update display values
        document.addEventListener('input', function(e) {
            if (e.target.type === 'range') {
                updateRangeValues();
            }
        });
        });
        
        // ================= Thông báo giọng nói =================
        const ANNOUNCE_KEY = 'examination_announce_template_v2';
        const VOICE_KEY = 'examination_announce_voice_v2';
        const RATE_KEY = 'examination_announce_rate_v2';
        const PITCH_KEY = 'examination_announce_pitch_v2';
        const VOLUME_KEY = 'examination_announce_volume_v2';
        const SOUND_KEY = 'examination_announce_sound_v2';
        const FREQUENCY_KEY = 'examination_announce_frequency_v2';
        const DURATION_KEY = 'examination_announce_duration_v2';
        const REPEAT_KEY = 'examination_announce_repeat_v2';
        const VOLUSON_SYNC_KEY = 'voluson_sync_enabled_v1';
        const VOLUSON_IP_KEY = 'voluson_ip_v1';
        const VOLUSON_PORT_KEY = 'voluson_port_v1';

        function getDefaultTemplate() {
            return 'Mời khách hàng {name}, phiếu khám số {queue}, vào phòng khám.';
        }

        let voiceLoadRetryTimer = null;
        function openAnnouncementSettings() {
            document.getElementById('announcement-settings').classList.add('active');
            
            // Show detailed instructions
            console.log('Opening announcement settings...');
            console.log('Browser:', navigator.userAgent);
            console.log('Speech synthesis supported:', 'speechSynthesis' in window);
            
            // Đợi một chút để đảm bảo modal đã render
            setTimeout(() => {
                // Re-populate voices on open (some browsers only expose voices after user gesture)
                populateVoices();
                // If still empty, retry a few times
                tryEnsureVoicesLoaded();
            }, 50);
            
            // Tự động chọn giọng nữ tốt nhất nếu chưa có lựa chọn
            setTimeout(() => {
                const voiceSelect = document.getElementById('voice-select');
                if (voiceSelect && voiceSelect.value === '' && voiceSelect.options.length > 1) {
                    const bestFemaleVoice = Array.from(voiceSelect.options).find(opt => 
                        opt.value && (opt.textContent.includes('Nữ') || opt.textContent.includes('Female'))
                    );
                    if (bestFemaleVoice) {
                        voiceSelect.value = bestFemaleVoice.value;
                        localStorage.setItem(VOICE_KEY, bestFemaleVoice.value);
                        console.log('Auto-selected voice:', bestFemaleVoice.value);
                    }
                }
            }, 500);
        }
        
        function closeAnnouncementSettings() {
            document.getElementById('announcement-settings').classList.remove('active');
            if (voiceLoadRetryTimer) {
                clearTimeout(voiceLoadRetryTimer);
                voiceLoadRetryTimer = null;
            }
        }

        function initializeAnnouncementSettings() {
            // Template
            const saved = localStorage.getItem(ANNOUNCE_KEY) || getDefaultTemplate();
            document.getElementById('announcement-template').value = saved;
            
            // Voice settings
            const savedRate = parseFloat(localStorage.getItem(RATE_KEY) || '1');
            const savedPitch = parseFloat(localStorage.getItem(PITCH_KEY) || '1');
            const savedVolume = parseFloat(localStorage.getItem(VOLUME_KEY) || '1');
            document.getElementById('rate-input').value = savedRate;
            document.getElementById('pitch-input').value = savedPitch;
            document.getElementById('volume-input').value = savedVolume;
            
            // Sound settings
            const savedSound = localStorage.getItem(SOUND_KEY) || 'beep';
            const savedFrequency = parseInt(localStorage.getItem(FREQUENCY_KEY) || '800');
            const savedDuration = parseFloat(localStorage.getItem(DURATION_KEY) || '0.5');
            const savedRepeat = parseInt(localStorage.getItem(REPEAT_KEY) || '1');
            
            document.getElementById('notification-sound').value = savedSound;
            document.getElementById('sound-frequency').value = savedFrequency;
            document.getElementById('sound-duration').value = savedDuration;
            document.getElementById('sound-repeat').value = savedRepeat;
            
            // Voluson settings
            const savedVolusonSync = localStorage.getItem(VOLUSON_SYNC_KEY) === 'true';
            const savedVolusonIP = localStorage.getItem(VOLUSON_IP_KEY) || '10.17.2.1';
            const savedVolusonPort = localStorage.getItem(VOLUSON_PORT_KEY) || '104';
            
            document.getElementById('voluson-sync-enabled').checked = savedVolusonSync;
            document.getElementById('voluson-ip').value = savedVolusonIP;
            document.getElementById('voluson-port').value = savedVolusonPort;
            
            // Update display values
            updateRangeValues();
            
            // Load ultrasound services
            loadUltrasoundServices();
            
            // Load voices
            populateVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoices;
            }
            // Fallback retry in case onvoiceschanged doesn't fire
            tryEnsureVoicesLoaded();
        }
        
        // Tab switching function
        function switchTab(tabName, element) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // Add active class to clicked button
            if (element) {
                element.classList.add('active');
            }
        }
        
        // Update range input display values
        function updateRangeValues() {
            const rateValue = document.getElementById('rate-input').value;
            const pitchValue = document.getElementById('pitch-input').value;
            const volumeValue = document.getElementById('volume-input').value;
            const frequencyValue = document.getElementById('sound-frequency').value;
            const durationValue = document.getElementById('sound-duration').value;
            const repeatValue = document.getElementById('sound-repeat').value;
            
            document.getElementById('rate-value').textContent = parseFloat(rateValue).toFixed(1);
            document.getElementById('pitch-value').textContent = parseFloat(pitchValue).toFixed(1);
            document.getElementById('volume-value').textContent = Math.round(volumeValue * 100) + '%';
            document.getElementById('frequency-value').textContent = frequencyValue + ' Hz';
            document.getElementById('duration-value').textContent = durationValue + ' giây';
            document.getElementById('repeat-value').textContent = repeatValue + ' lần';
        }
        
        // Load template presets
        function loadTemplatePreset() {
            const preset = document.getElementById('template-presets').value;
            const templateTextarea = document.getElementById('announcement-template');
            
            const presets = {
                basic: 'Mời khách hàng {name}, phiếu khám số {queue}, vào phòng khám.',
                polite: 'Xin mời khách hàng {name}, phiếu khám số {queue}, vào phòng khám. Cảm ơn quý khách.',
                detailed: 'Xin mời khách hàng {name}, phiếu khám số {queue}, vào phòng khám lúc {time}. Bác sĩ {doctor} sẽ khám cho quý khách.',
                urgent: 'Khẩn cấp! Mời khách hàng {name}, phiếu khám số {queue}, vào phòng khám ngay lập tức.'
            };
            
            if (presets[preset]) {
                templateTextarea.value = presets[preset];
            }
        }

        function populateVoices() {
            const voiceSelect = document.getElementById('voice-select');
            if (!voiceSelect) {
                console.log('voice-select element not found!');
                return;
            }
            const selected = localStorage.getItem(VOICE_KEY) || '';
            const voices = window.speechSynthesis.getVoices();
            
            console.log('Available voices:', voices.length);
            console.log('voice-select options before:', voiceSelect.options.length);
            voices.forEach(v => console.log(`- ${v.name} (${v.lang})`));
            
            // Ưu tiên giọng nữ tiếng Việt
            const femaleViPatterns = [
                /Microsoft\s+HoaiMy/i, // Edge - vi-VN female
                /Microsoft\s+My/i,
                /Google\s+Ti(ếng|eng)\s*Vi(ệt|et)/i, // Chrome - Google Vietnamese
                /Google\s+Vietnamese/i,
                /Vietnamese.*Female/i,
                /vi.*female/i,
                /female.*vi/i,
                /nữ.*vi/i,
                /vi.*nữ/i,
                /vi-vn/i,
                /vietnamese/i
            ];
            
            const isVi = v => {
                const lang = (v.lang || '').toLowerCase();
                const name = (v.name || '').toLowerCase();
                return lang.startsWith('vi') || 
                       lang.includes('vietnamese') || 
                       name.includes('vietnamese') ||
                       name.includes('vi-') ||
                       name.includes('hoaimy') ||
                       name.includes('my');
            };
            
            const isFemale = v => {
                const name = (v.name || '').toLowerCase();
                return /female|nu|nữ|my|hoaimy|woman|girl/i.test(name);
            };
            
            const isEnglish = v => {
                const lang = (v.lang || '').toLowerCase();
                return lang.startsWith('en') || lang.includes('english');
            };
            
            const isChinese = v => {
                const lang = (v.lang || '').toLowerCase();
                return lang.startsWith('zh') || lang.includes('chinese');
            };
            
            // Chỉ hiển thị giọng tiếng Việt, tiếng Anh, tiếng Trung
            let viVoices = voices.filter(v => isVi(v) || isEnglish(v) || isChinese(v));
            console.log('Filtered voices (vi, en, zh):', viVoices.length);
            
            const vendorScore = v => {
                for (let i = 0; i < femaleViPatterns.length; i++) {
                    if (femaleViPatterns[i].test(v.name)) return femaleViPatterns.length - i;
                }
                return 0;
            };
            
            const sorted = viVoices.slice().sort((a, b) => {
                const va = vendorScore(a);
                const vb = vendorScore(b);
                if (va !== vb) return vb - va;
                
                // Ưu tiên giọng nữ
                const fA = isFemale(a) ? 1 : 0;
                const fB = isFemale(b) ? 1 : 0;
                if (fA !== fB) return fB - fA;
                
                // Ưu tiên tiếng Việt
                const viA = isVi(a) ? 1 : 0;
                const viB = isVi(b) ? 1 : 0;
                if (viA !== viB) return viB - viA;
                
                return a.name.localeCompare(b.name);
            });
            
            console.log('Sorted voices:', sorted.length);
            
            voiceSelect.innerHTML = '';
            
            // Thêm option đầu tiên với hướng dẫn
            const instructionOpt = document.createElement('option');
            instructionOpt.value = '';
            instructionOpt.textContent = '-- Chọn giọng đọc --';
            voiceSelect.appendChild(instructionOpt);
            
            if (sorted.length) {
                sorted.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.name;
                    const isFemaleVoice = isFemale(v);
                    const isVietnamese = isVi(v);
                    let label = v.name;
                    if (isFemaleVoice && isVietnamese) {
                        label += ' ⭐ (Nữ - Tiếng Việt)';
                    } else if (isFemaleVoice) {
                        label += ' (Nữ)';
                    } else if (isVietnamese) {
                        label += ' (Tiếng Việt)';
                    }
                    opt.textContent = `${label} (${v.lang})`;
                    if (v.name === selected) opt.selected = true;
                    voiceSelect.appendChild(opt);
                });
                
                // Nếu giọng đã lưu không còn trong danh sách, xóa lựa chọn
                if (!Array.from(voiceSelect.options).some(o => o.value === selected)) {
                    localStorage.removeItem(VOICE_KEY);
                }
                
                // Hiển thị thông báo nếu không có giọng Việt
                if (voices.filter(isVi).length === 0) {
                    const warningDiv = document.getElementById('voice-instructions');
                    if (warningDiv) {
                        warningDiv.style.display = 'block';
                        warningDiv.innerHTML = `
                            <strong>⚠️ Không tìm thấy giọng đọc tiếng Việt!</strong><br>
                            <strong>Chrome:</strong> chrome://settings/languages → Add Vietnamese → Install voice pack<br>
                            <strong>Edge:</strong> edge://settings/languages → Add Vietnamese → Download speech<br>
                            <strong>Firefox:</strong> Cần cài đặt gói ngôn ngữ từ Windows Settings
                        `;
                    }
                } else {
                    const warningDiv = document.getElementById('voice-instructions');
                    if (warningDiv) {
                        warningDiv.style.display = 'none';
                    }
                }
            } else {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'Không có giọng đọc nào. Vui lòng kiểm tra trình duyệt.';
                voiceSelect.appendChild(opt);
            }
            console.log('voice-select options after:', voiceSelect.options.length);
        }

        function tryEnsureVoicesLoaded(attempt = 0) {
            const maxAttempts = 10;
            const delayMs = 300;
            const voices = window.speechSynthesis.getVoices();
            if (voices && voices.length) {
                populateVoices();
                return;
            }
            if (attempt >= maxAttempts) return;
            voiceLoadRetryTimer = setTimeout(() => {
                populateVoices();
                tryEnsureVoicesLoaded(attempt + 1);
            }, delayMs);
        }
        
        // Refresh voices function
        function refreshVoices() {
            console.log('Refreshing voices...');
            populateVoices();
            tryEnsureVoicesLoaded();
        }

        function saveAnnouncementSettings() {
            // Template
            const tmpl = document.getElementById('announcement-template').value.trim() || getDefaultTemplate();
            localStorage.setItem(ANNOUNCE_KEY, tmpl);
            
            // Voice settings
            const voiceName = document.getElementById('voice-select').value || '';
            const rate = parseFloat(document.getElementById('rate-input').value || '1');
            const pitch = parseFloat(document.getElementById('pitch-input').value || '1');
            const volume = parseFloat(document.getElementById('volume-input').value || '1');
            
            localStorage.setItem(VOICE_KEY, voiceName);
            localStorage.setItem(RATE_KEY, String(rate));
            localStorage.setItem(PITCH_KEY, String(pitch));
            localStorage.setItem(VOLUME_KEY, String(volume));
            
            // Sound settings
            const sound = document.getElementById('notification-sound').value || 'beep';
            const frequency = parseInt(document.getElementById('sound-frequency').value || '800');
            const duration = parseFloat(document.getElementById('sound-duration').value || '0.5');
            const repeat = parseInt(document.getElementById('sound-repeat').value || '1');
            
            localStorage.setItem(SOUND_KEY, sound);
            localStorage.setItem(FREQUENCY_KEY, String(frequency));
            localStorage.setItem(DURATION_KEY, String(duration));
            localStorage.setItem(REPEAT_KEY, String(repeat));
            
            // Voluson settings
            const volusonSync = document.getElementById('voluson-sync-enabled').checked;
            const volusonIP = document.getElementById('voluson-ip').value || '10.17.2.1';
            const volusonPort = document.getElementById('voluson-port').value || '104';
            
            localStorage.setItem(VOLUSON_SYNC_KEY, String(volusonSync));
            localStorage.setItem(VOLUSON_IP_KEY, volusonIP);
            localStorage.setItem(VOLUSON_PORT_KEY, volusonPort);
            
            closeAnnouncementSettings();
        }

        function resetAnnouncementDefaults() {
            document.getElementById('announcement-template').value = getDefaultTemplate();
            document.getElementById('rate-input').value = 1;
            document.getElementById('pitch-input').value = 1;
            document.getElementById('volume-input').value = 1;
            document.getElementById('notification-sound').value = 'beep';
            document.getElementById('sound-frequency').value = 800;
            document.getElementById('sound-duration').value = 0.5;
            document.getElementById('sound-repeat').value = 1;
            updateRangeValues();
        }
        
        // Generate notification sound
        function playNotificationSound() {
            const soundType = localStorage.getItem(SOUND_KEY) || 'beep';
            const frequency = parseInt(localStorage.getItem(FREQUENCY_KEY) || '800');
            const duration = parseFloat(localStorage.getItem(DURATION_KEY) || '0.5');
            const repeat = parseInt(localStorage.getItem(REPEAT_KEY) || '1');
            
            if (soundType === 'none') return;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            for (let i = 0; i < repeat; i++) {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    // Set frequency based on sound type
                    let freq = frequency;
                    if (soundType === 'bell') freq = frequency * 1.5;
                    else if (soundType === 'chime') freq = frequency * 0.8;
                    
                    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                    oscillator.type = soundType === 'chime' ? 'sine' : 'square';
                    
                    // Set volume envelope
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + duration);
                }, i * (duration * 1000 + 100));
            }
        }
        
        // Test notification sound
        function testNotificationSound() {
            playNotificationSound();
        }
        
        // Voluson functions
        async function loadUltrasoundServices() {
            try {
                const response = await fetch('/api/clinical-services');
                const services = await response.json();
                
                const ultrasoundServices = services.filter(s => 
                    s.service_group && s.service_group.toLowerCase().includes('siêu âm')
                );
                
                const container = document.getElementById('ultrasound-services');
                if (ultrasoundServices.length > 0) {
                    container.innerHTML = ultrasoundServices.map(s => `
                        <div style="padding:0.3rem; border-bottom:1px solid #eee; font-size:0.9rem;">
                            <strong>${s.name}</strong> - ${s.service_group}
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="font-style:italic; color:#888;">Không có dịch vụ siêu âm nào</div>';
                }
            } catch (error) {
                console.error('Error loading ultrasound services:', error);
                document.getElementById('ultrasound-services').innerHTML = '<div style="color:red;">Lỗi tải danh sách dịch vụ</div>';
            }
        }
        
        async function testVolusonConnection() {
            const statusDiv = document.getElementById('voluson-status');
            const statusText = document.getElementById('voluson-status-text');
            
            statusText.textContent = 'Đang kiểm tra...';
            statusDiv.style.background = '#fff3cd';
            
            try {
                const ip = document.getElementById('voluson-ip').value;
                const port = document.getElementById('voluson-port').value;
                
                const response = await fetch('/api/test-voluson-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip, port: parseInt(port) })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusText.textContent = 'Kết nối thành công';
                    statusDiv.style.background = '#d4edda';
                } else {
                    statusText.textContent = `Lỗi: ${result.error}`;
                    statusDiv.style.background = '#f8d7da';
                }
            } catch (error) {
                statusText.textContent = `Lỗi kết nối: ${error.message}`;
                statusDiv.style.background = '#f8d7da';
            }
        }

        function buildAnnouncement(name, queue, time = null, doctor = null) {
            const tmpl = localStorage.getItem(ANNOUNCE_KEY) || getDefaultTemplate();
            const currentTime = time || new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', hour12: false });
            const doctorName = doctor || 'PK Đại Anh';
            
            return tmpl
                .replace(/\{name\}/g, name || '')
                .replace(/\{queue\}/g, String(queue || ''))
                .replace(/\{time\}/g, currentTime)
                .replace(/\{doctor\}/g, doctorName)
                .replace(/\s+/g, ' ')
                .trim();
        }

        // Đảm bảo voices được load trước khi sử dụng
        let voicesLoaded = false;
        function ensureVoicesLoaded(callback) {
            if (voicesLoaded && window.speechSynthesis.getVoices().length > 0) {
                callback();
                return;
            }
            
            const voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
                voicesLoaded = true;
                callback();
            } else {
                // Đợi voices load
                window.speechSynthesis.onvoiceschanged = () => {
                    voicesLoaded = true;
                    callback();
                };
                // Timeout fallback
                setTimeout(() => {
                    if (!voicesLoaded) {
                        voicesLoaded = true;
                        callback();
                    }
                }, 1000);
            }
        }

        function getPreferredVoice() {
            const voices = window.speechSynthesis.getVoices();
            const savedName = localStorage.getItem(VOICE_KEY) || '';
            
            const isVi = v => {
                const lang = (v.lang || '').toLowerCase();
                const name = (v.name || '').toLowerCase();
                return lang.startsWith('vi') || 
                       lang === 'vi-vn' ||
                       lang.includes('vietnamese') || 
                       name.includes('vietnamese') ||
                       name.includes('vi-') ||
                       name.includes('hoaimy') ||
                       name.includes('my') ||
                       name.includes('viet nam');
            };
            
            const isFemale = v => {
                const name = (v.name || '').toLowerCase();
                const lang = (v.lang || '').toLowerCase();
                // Kiểm tra female, nữ, và các giọng nữ phổ biến
                return /female|nu|nữ|my|hoaimy|woman|girl|lan|mai|linh|ha|an/i.test(name) ||
                       (lang.includes('vi') && !/male|nam|man|boy/i.test(name));
            };
            
            console.log('Getting preferred voice from', voices.length, 'voices');
            
            // Log tất cả giọng tiếng Việt có sẵn
            const allViVoices = voices.filter(isVi);
            if (allViVoices.length > 0) {
                console.log('Available Vietnamese voices:', allViVoices.map(v => `${v.name} (${v.lang}) - ${isFemale(v) ? 'Nữ' : 'Nam'}`));
            }
            
            // Ưu tiên giọng đã lưu
            if (savedName) {
                let voice = voices.find(v => v.name === savedName);
                if (voice) {
                    console.log('Using saved voice:', voice.name);
                    return voice;
                }
            }
            
            // Tìm giọng nữ tiếng Việt ưu tiên (theo thứ tự từ cao xuống thấp)
            // 1. Microsoft HoaiMy (giọng nữ phổ biến trên Windows)
            let voice = voices.find(v => /Microsoft\s+HoaiMy/i.test(v.name) && isVi(v));
            if (voice) {
                console.log('Found Microsoft HoaiMy (Vietnamese Female):', voice.name);
                return voice;
            }
            
            // 2. Microsoft My (giọng nữ khác)
            voice = voices.find(v => /Microsoft\s+My/i.test(v.name) && isVi(v));
            if (voice) {
                console.log('Found Microsoft My (Vietnamese Female):', voice.name);
                return voice;
            }
            
            // 3. Google Vietnamese voices (thường có giọng nữ)
            voice = voices.find(v => {
                const name = v.name.toLowerCase();
                return (name.includes('google') || name.includes('chrome')) && 
                       isVi(v) && 
                       isFemale(v);
            });
            if (voice) {
                console.log('Found Google Vietnamese Female voice:', voice.name);
                return voice;
            }
            
            // 4. Các pattern khác cho giọng nữ tiếng Việt
            const femaleViPatterns = [
                /Vietnamese.*Female/i,
                /Female.*Vietnamese/i,
                /vi.*female/i,
                /female.*vi/i,
                /nữ.*vi/i,
                /vi.*nữ/i,
                /vi-vn.*female/i,
                /vietnamese.*woman/i
            ];
            
            for (const pattern of femaleViPatterns) {
                voice = voices.find(vv => pattern.test(vv.name) && isVi(vv) && isFemale(vv));
                if (voice) {
                    console.log('Found preferred Vietnamese female voice:', voice.name);
                    return voice;
                }
            }
            
            // Tìm giọng nữ tiếng Việt bất kỳ
            const viVoices = voices.filter(isVi);
            const femaleVi = viVoices.find(v => isFemale(v));
            if (femaleVi) {
                console.log('Found Vietnamese female voice:', femaleVi.name);
                return femaleVi;
            }
            
            // Tìm giọng tiếng Việt bất kỳ
            if (viVoices.length) {
                console.log('Found Vietnamese voice:', viVoices[0].name);
                return viVoices[0];
            }
            
            // Tìm giọng nữ bất kỳ
            const femaleVoices = voices.filter(isFemale);
            if (femaleVoices.length) {
                console.log('Found female voice:', femaleVoices[0].name);
                return femaleVoices[0];
            }
            
            // Fallback: giọng đầu tiên có sẵn
            if (voices.length) {
                console.log('Using fallback voice:', voices[0].name);
                return voices[0];
            }
            
            console.log('No voices available');
            return null;
        }

        function speakAnnouncement(name, queue, time = null, doctor = null) {
            try {
                const text = buildAnnouncement(name, queue, time, doctor);
                if (!('speechSynthesis' in window)) {
                    alert('Trình duyệt không hỗ trợ đọc văn bản (Speech Synthesis).');
                    return;
                }
                
                // Play notification sound first
                playNotificationSound();
                
                // Đảm bảo voices được load trước khi sử dụng
                ensureVoicesLoaded(() => {
                    window.speechSynthesis.cancel();
                    const utter = new SpeechSynthesisUtterance(text);
                    const voice = getPreferredVoice();
                    
                    if (voice) {
                        utter.voice = voice;
                        utter.lang = voice.lang || 'vi-VN';
                        console.log('Using voice:', voice.name, 'Language:', voice.lang, 'Gender:', voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('nữ') ? 'Nữ' : 'Unknown');
                    } else {
                        utter.lang = 'vi-VN';
                        console.warn('No preferred voice found, using default Vietnamese');
                    }
                    
                    // Thiết lập thông số âm thanh
                    // Rate: tốc độ nói (0.1 - 10)
                    utter.rate = parseFloat(localStorage.getItem(RATE_KEY) || '0.9');
                    
                    // Pitch: độ cao giọng (0 - 2), cao hơn = giọng nữ hơn
                    // Nếu không có giọng nữ rõ ràng, tăng pitch để giống nữ hơn
                    let pitch = parseFloat(localStorage.getItem(PITCH_KEY) || '1.1');
                    if (!voice || !(/female|nu|nữ|my|hoaimy|woman|girl/i.test(voice.name))) {
                        // Nếu không phải giọng nữ rõ ràng, tăng pitch lên một chút
                        pitch = Math.max(pitch, 1.15);
                    }
                    utter.pitch = pitch;
                    
                    // Volume: âm lượng (0 - 1)
                    utter.volume = parseFloat(localStorage.getItem(VOLUME_KEY) || '1');
                    
                    console.log('Speaking with settings:', {
                        voice: voice?.name || 'default',
                        lang: utter.lang,
                        rate: utter.rate,
                        pitch: utter.pitch,
                        volume: utter.volume,
                        text: text.substring(0, 50) + '...'
                    });
                    
                    window.speechSynthesis.speak(utter);
                    
                    // Event listeners để debug
                    utter.onstart = () => {
                        console.log('Speech started');
                    };
                    
                    utter.onend = () => {
                        console.log('Speech ended');
                    };
                    
                    utter.onerror = (e) => {
                        console.error('Speech error:', e);
                    };
                });
            } catch (e) {
                console.error('Speech error:', e);
                alert('Lỗi khi phát âm thanh: ' + e.message);
            }
        }

        function testAnnouncementSample() {
            const name = 'Nguyễn Thị A';
            const queue = 15;
            speakAnnouncement(name, queue);
        }

        // Delegate click on speak buttons
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('.speak-btn');
            if (btn) {
                const name = btn.getAttribute('data-name');
                const queue = btn.getAttribute('data-queue');
                speakAnnouncement(name, queue);
            }
        });

        // Delegate click on Zalo buttons
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('.zalo-btn');
            if (btn) {
                const phone = btn.getAttribute('data-phone');
                if (phone) {
                    // Xử lý số điện thoại - chỉ giữ lại số
                    const cleanPhone = phone.replace(/[^0-9]/g, '');
                    
                    // URL cho Zalo Desktop và Web
                    const zaloDesktopUrl = `zalo://conversation?phone=${cleanPhone}`;
                    const zaloWebUrl = `https://chat.zalo.me/?phone=${cleanPhone}`;
                    
                    // Thời điểm click
                    const clickTime = new Date().getTime();
                    
                    // Thử mở Zalo Desktop
                    window.location.href = zaloDesktopUrl;
                    
                    // Kiểm tra xem Zalo Desktop có được mở không
                    window.addEventListener('blur', function checkZalo() {
                        // Nếu cửa sổ bị blur trong vòng 500ms, có thể Zalo đã mở
                        if (new Date().getTime() - clickTime < 500) {
                            window.removeEventListener('blur', checkZalo);
                        }
                    });
                    
                    // Nếu sau 1 giây vẫn không mở được Zalo Desktop, mở Zalo Web
                    setTimeout(() => {
                        // Nếu trang vẫn active (Zalo Desktop không mở), mở Zalo Web
                        if (document.hasFocus()) {
                            window.open(zaloWebUrl, '_blank');
                        }
                    }, 1000);
                } else {
                    alert('Không có số điện thoại để mở Zalo');
                }
            }
        });

        // Examination form print functionality (pregnancy or gynecology)
        async function printExaminationForm(appointmentId, serviceType) {
            try {
                // Get full appointment data
                const appointmentResponse = await fetch(`/api/appointments/${appointmentId}/full-info`);
                if (!appointmentResponse.ok) {
                    alert('Không tìm thấy thông tin bệnh nhân!');
                    return;
                }
                const appointment = await appointmentResponse.json();
                
                // Determine form type based on service_type
                const isPregnancy = serviceType && (
                    serviceType.toLowerCase().includes('thai') || 
                    serviceType.toLowerCase().includes('siêu âm thai') ||
                    serviceType.toLowerCase().includes('pregnancy')
                );
                
                const formType = isPregnancy ? 'sản' : 'phụ khoa';
                
                // Get header template
                const headerResponse = await fetch('/api/clinical-form-header');
                const headerData = await headerResponse.json();
                
                // Create examination form HTML
                const formContent = createExaminationFormHTML(appointment, formType);
                const fullContent = headerData.header + formContent;
                
                // Show preview and print
                showExaminationFormPreview(fullContent, formType);
                
            } catch (error) {
                console.error('Error generating examination form:', error);
                alert('Lỗi khi tạo phiếu khám: ' + error.message);
            }
        }
        
        function createExaminationFormHTML(appointment, formType) {
            // Calculate age from date of birth
            let age = '';
            if (appointment.patient_dob) {
                const dob = new Date(appointment.patient_dob);
                const today = new Date();
                age = today.getFullYear() - dob.getFullYear();
                const monthDiff = today.getMonth() - dob.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
            }
            
            // Format date
            const today = new Date();
            const day = today.getDate().toString().padStart(2, '0');
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const year = today.getFullYear();
            const dateStr = `${day}/${month}/${year}`;
            
            // Format appointment time
            const appointmentDate = new Date(appointment.appointment_date);
            const timeStr = appointmentDate.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', hour12: false });
            
            const formTitle = formType === 'sản' ? 'PHIẾU KHÁM SẢN' : 'PHIẾU KHÁM PHỤ KHOA';
            
            return `
                <div style="padding: 20px; font-family: 'Times New Roman', serif;">
                    <h2 style="text-align: center; margin-bottom: 20px; text-transform: uppercase;">${formTitle}</h2>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #000; width: 30%;"><strong>Họ và tên:</strong></td>
                            <td style="padding: 8px; border: 1px solid #000;">${appointment.patient_name || ''}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #000;"><strong>Năm sinh:</strong></td>
                            <td style="padding: 8px; border: 1px solid #000;">${appointment.patient_dob ? new Date(appointment.patient_dob).getFullYear() : ''}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #000;"><strong>Tuổi:</strong></td>
                            <td style="padding: 8px; border: 1px solid #000;">${age || ''}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #000;"><strong>Địa chỉ:</strong></td>
                            <td style="padding: 8px; border: 1px solid #000;">${appointment.patient_address || ''}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #000;"><strong>Số điện thoại:</strong></td>
                            <td style="padding: 8px; border: 1px solid #000;">${appointment.patient_phone || ''}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #000;"><strong>Ngày khám:</strong></td>
                            <td style="padding: 8px; border: 1px solid #000;">${dateStr}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #000;"><strong>Giờ khám:</strong></td>
                            <td style="padding: 8px; border: 1px solid #000;">${timeStr}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #000;"><strong>Lý do khám:</strong></td>
                            <td style="padding: 8px; border: 1px solid #000;">${appointment.service_type || ''}</td>
                        </tr>
                    </table>
                    
                    ${formType === 'sản' ? `
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #000; width: 30%;"><strong>Tuần thai:</strong></td>
                            <td style="padding: 8px; border: 1px solid #000;"></td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #000;"><strong>Ngày kinh cuối:</strong></td>
                            <td style="padding: 8px; border: 1px solid #000;"></td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #000;"><strong>Ngày dự sinh:</strong></td>
                            <td style="padding: 8px; border: 1px solid #000;"></td>
                        </tr>
                    </table>
                    ` : ''}
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #000; width: 30%;"><strong>Triệu chứng:</strong></td>
                            <td style="padding: 8px; border: 1px solid #000; height: 60px;"></td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #000;"><strong>Khám lâm sàng:</strong></td>
                            <td style="padding: 8px; border: 1px solid #000; height: 60px;"></td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #000;"><strong>Chẩn đoán:</strong></td>
                            <td style="padding: 8px; border: 1px solid #000;">${appointment.diagnosis || ''}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #000;"><strong>Điều trị:</strong></td>
                            <td style="padding: 8px; border: 1px solid #000; height: 60px;"></td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #000;"><strong>Ghi chú:</strong></td>
                            <td style="padding: 8px; border: 1px solid #000;">${appointment.notes || ''}</td>
                        </tr>
                    </table>
                    
                    <div style="margin-top: 30px; display: flex; justify-content: space-between;">
                        <div style="text-align: center;">
                            <p style="margin: 5px 0;"><strong>Bệnh nhân</strong></p>
                            <p style="margin-top: 40px;">${appointment.patient_name || ''}</p>
                        </div>
                        <div style="text-align: center;">
                            <p style="margin: 5px 0;"><strong>Bác sĩ khám</strong></p>
                            <p style="margin-top: 40px;">${appointment.doctor_name || 'PK Đại Anh'}</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function showExaminationFormPreview(content, formType) {
            const modal = document.getElementById('clinical-form-modal');
            const previewContent = document.getElementById('clinical-form-preview');
            
            // Update modal title
            const modalTitle = document.querySelector('#clinical-form-modal h3');
            if (modalTitle) {
                modalTitle.textContent = `Xem trước phiếu khám ${formType}`;
            }
            
            previewContent.innerHTML = content;
            modal.style.display = 'block';
        }

        // Clinical form print functionality
        async function printClinicalForm(appointmentId) {
            try {
                // Get full appointment data including diagnosis and clinical services
                const appointmentResponse = await fetch(`/api/appointments/${appointmentId}/full-info`);
                if (!appointmentResponse.ok) {
                    alert('Không tìm thấy thông tin bệnh nhân!');
                    return;
                }
                const appointment = await appointmentResponse.json();
                
                // Debug: Log appointment data
                console.log('Appointment data:', appointment);
                console.log('Clinical services:', appointment.clinical_services);

                // Check if patient has clinical services
                if (!appointment.clinical_services || appointment.clinical_services.length === 0) {
                    alert('Bệnh nhân chưa có dịch vụ cận lâm sàng nào. Vui lòng thêm dịch vụ trước khi in phiếu chỉ định.');
                    return;
                }

                // Get clinical form template
                const templateResponse = await fetch('/api/clinical-form-template/lab-request');
                const templateData = await templateResponse.json();
                
                // Get header template from database (same as clinical-form-templates)
                const headerResponse = await fetch('/api/clinical-form-header');
                const headerData = await headerResponse.json();
                
                // Create forms for each clinical service
                const forms = [];
                console.log(`Tạo ${appointment.clinical_services.length} phiếu chỉ định cho ${appointment.clinical_services.length} dịch vụ`);
                
                for (const service of appointment.clinical_services) {
                    console.log(`Tạo phiếu cho dịch vụ: ${service.name}`);
                    const filledTemplate = fillClinicalFormTemplate(templateData.template, appointment, service);
                    const fullContent = headerData.header + filledTemplate;
                    forms.push({
                        service: service,
                        content: fullContent
                    });
                }
                
                console.log(`Đã tạo ${forms.length} phiếu chỉ định`);
                
                // Show preview modal with multiple forms
                showClinicalFormPreview(forms);
                
            } catch (error) {
                console.error('Error generating clinical form:', error);
                alert('Lỗi khi tạo phiếu chỉ định: ' + error.message);
            }
        }

        function fillClinicalFormTemplate(template, appointment, service = null) {
            // Replace placeholders with actual data
            let filledTemplate = template;
            
            console.log('fillClinicalFormTemplate called with:', { appointment, service });
            console.log('Template before filling:', filledTemplate.substring(0, 500) + '...');
            
            // Calculate age from date of birth
            let age = '';
            if (appointment.patient_dob) {
                const dob = new Date(appointment.patient_dob);
                const today = new Date();
                age = today.getFullYear() - dob.getFullYear();
            }
            
            // Replace specific fields with more precise targeting
            // 1. Họ tên (first occurrence in patient info table)
            filledTemplate = filledTemplate.replace(
                /<td style="padding:8px; border:1px solid #000; width:30%;">_________________<\/td>/,
                `<td style="padding:8px; border:1px solid #000; width:30%;">${appointment.patient_name || ''}</td>`
            );
            
            // 2. Tuổi (second occurrence in patient info table)
            filledTemplate = filledTemplate.replace(
                /<td style="padding:8px; border:1px solid #000; width:30%;">_________________<\/td>/,
                `<td style="padding:8px; border:1px solid #000; width:30%;">${age}</td>`
            );
            
            // 3. Địa chỉ (colspan=3 in address row)
            filledTemplate = filledTemplate.replace(
                /<td style="padding:8px; border:1px solid #000;" colspan="3">_________________<\/td>/,
                `<td style="padding:8px; border:1px solid #000;" colspan="3">${appointment.patient_address || ''}</td>`
            );
            
            // 4. Chẩn đoán và Ghi chú (now split into two columns)
            console.log('Filling diagnosis and notes:', { diagnosis: appointment.diagnosis, notes: appointment.notes });
            
            // Replace diagnosis - use a more flexible approach
            filledTemplate = filledTemplate.replace(
                /<td style="padding:8px; border:1px solid #000;"><strong>Chẩn đoán:<\/strong><\/td>\s*<td style="padding:8px; border:1px solid #000;">_________________<\/td>/,
                `<td style="padding:8px; border:1px solid #000;"><strong>Chẩn đoán:</strong></td>\n      <td style="padding:8px; border:1px solid #000;">${appointment.diagnosis || ''}</td>`
            );
            
            // Replace notes - use a more flexible approach  
            filledTemplate = filledTemplate.replace(
                /<td style="padding:8px; border:1px solid #000;"><strong>Ghi chú:<\/strong><\/td>\s*<td style="padding:8px; border:1px solid #000;">_________________<\/td>/,
                `<td style="padding:8px; border:1px solid #000;"><strong>Ghi chú:</strong></td>\n      <td style="padding:8px; border:1px solid #000;">${appointment.notes || ''}</td>`
            );
            
            // Fallback: If the above doesn't work, try a simpler approach
            if (filledTemplate.includes('_________________')) {
                console.log('Using fallback method for diagnosis and notes');
                // Replace any remaining placeholders with actual data
                filledTemplate = filledTemplate.replace(
                    /<td style="padding:8px; border:1px solid #000;">_________________<\/td>/g,
                    (match, offset) => {
                        // Count how many replacements we've made
                        const beforeReplace = filledTemplate.substring(0, offset);
                        const diagnosisCount = (beforeReplace.match(/Chẩn đoán:/g) || []).length;
                        const notesCount = (beforeReplace.match(/Ghi chú:/g) || []).length;
                        
                        if (diagnosisCount > 0 && notesCount === 0) {
                            return `<td style="padding:8px; border:1px solid #000;">${appointment.diagnosis || ''}</td>`;
                        } else if (notesCount > 0) {
                            return `<td style="padding:8px; border:1px solid #000;">${appointment.notes || ''}</td>`;
                        }
                        return match;
                    }
                );
            }
            
            // 5. Bác sĩ chỉ định (in the signature section) - layout mới
            console.log('Replacing doctor name:', appointment.doctor_name || 'PK Đại Anh');
            // Replace doctor name in the new layout (right side)
            filledTemplate = filledTemplate.replace(
                /<p style="margin-top:20px;">_________________<\/p>/,
                `<p style="margin-top:20px;">${appointment.doctor_name || 'PK Đại Anh'}</p>`
            );
            
            // 6. Update clinical service section if service is provided
            if (service) {
                console.log('Filling service information:', service);
                
                // Check if service is ultrasound based on service_group or name
                const serviceGroup = (service.service_group || '').toLowerCase();
                const serviceName = (service.name || '').toLowerCase();
                const isUltrasound = serviceGroup.includes('siêu âm') || 
                                    serviceGroup.includes('sieu am') || 
                                    serviceGroup.includes('ultrasound') ||
                                    serviceName.includes('siêu âm') ||
                                    serviceName.includes('sieu am');
                
                // Check specific ultrasound types
                const isPregnancyUltrasound = serviceName.includes('thai') || 
                                             serviceName.includes('pregnancy');
                const isPelvisUltrasound = serviceName.includes('tử cung') || 
                                         serviceName.includes('phần phụ') ||
                                         serviceName.includes('pelvis');
                const isAbdomenUltrasound = serviceName.includes('ổ bụng') || 
                                           serviceName.includes('abdomen');
                
                // Check if it's a lab test
                const isLabTest = serviceGroup.includes('xét nghiệm') || 
                                 serviceGroup.includes('xet nghiem') ||
                                 serviceName.includes('xét nghiệm') ||
                                 serviceName.includes('xet nghiem') ||
                                 serviceName.includes('máu') ||
                                 serviceName.includes('nước tiểu') ||
                                 serviceName.includes('nuoc tieu');
                
                // Update checkboxes in the service section
                // Match the div containing checkboxes (more flexible regex)
                const serviceSectionRegex = /<div style="border:1px solid #000; padding:10px; min-height:100px;">([\s\S]*?)<\/div>/;
                const serviceSectionMatch = filledTemplate.match(serviceSectionRegex);
                
                if (serviceSectionMatch) {
                    let serviceContent = serviceSectionMatch[0];
                    let innerContent = serviceSectionMatch[1];
                    
                    // Determine which service to display and create new content with only selected service
                    let selectedServiceText = '';
                    
                    if (isPregnancyUltrasound) {
                        // Display "Siêu âm thai" with full service name if different
                        selectedServiceText = `<p>☑ ${service.name}</p>`;
                    } else if (isPelvisUltrasound) {
                        // Display "Siêu âm tử cung phần phụ" with full service name if different
                        selectedServiceText = `<p>☑ ${service.name}</p>`;
                    } else if (isAbdomenUltrasound) {
                        // Display "Siêu âm ổ bụng" with full service name if different
                        selectedServiceText = `<p>☑ ${service.name}</p>`;
                    } else if (isLabTest) {
                        // Display lab test with full service name
                        selectedServiceText = `<p>☑ ${service.name}</p>`;
                    } else {
                        // Display in "Khác" format
                        selectedServiceText = `<p>☑ Khác: ${service.name}</p>`;
                    }
                    
                    // Replace entire content with only the selected service
                    innerContent = selectedServiceText;
                    
                    // Reconstruct the div with only selected service
                    serviceContent = `<div style="border:1px solid #000; padding:10px; min-height:100px;">${innerContent}</div>`;
                    
                    // Replace the service section in the template
                    filledTemplate = filledTemplate.replace(serviceSectionRegex, serviceContent);
                }
            }
            
            // Add current date
            const today = new Date();
            const day = today.getDate().toString().padStart(2, '0');
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const year = today.getFullYear();
            filledTemplate = filledTemplate.replace(/___\/___\/_____/g, `${day}/${month}/${year}`);
            
            console.log('Template after filling:', filledTemplate.substring(0, 1000) + '...');
            console.log('Final filled template length:', filledTemplate.length);
            
            return filledTemplate;
        }

        function showClinicalFormPreview(forms) {
            const modal = document.getElementById('clinical-form-modal');
            const previewContent = document.getElementById('clinical-form-preview');
            
            // Update modal title to show number of forms
            const modalTitle = document.querySelector('#clinical-form-modal h3');
            if (modalTitle && Array.isArray(forms)) {
                modalTitle.textContent = `Xem trước phiếu chỉ định cận lâm sàng (${forms.length} phiếu)`;
            }
            // Helper: remove the very first HTML node/line from a chunk of HTML.
            // This is useful when the header/template may contain an unwanted first line
            // (for example a stray character or image placeholder) that should not
            // appear in the preview or printed output.
            function stripFirstNode(html) {
                const tmp = document.createElement('div');
                tmp.innerHTML = html || '';
                if (tmp.firstChild) tmp.removeChild(tmp.firstChild);
                return tmp.innerHTML;
            }

            // If forms is an array, display multiple forms
            if (Array.isArray(forms)) {
                let html = '';
                forms.forEach((form, index) => {
                    const cleanedContent = stripFirstNode(form.content);
                    html += `
                        <div style="page-break-after: always; margin-bottom: 20px; border: 2px solid #007bff; padding: 10px;">
                            ${cleanedContent}
                        </div>
                    `;
                });
                previewContent.innerHTML = html;
            } else {
                // Single form (backward compatibility) - strip first node as well
                previewContent.innerHTML = stripFirstNode(forms);
            }

            modal.style.display = 'block';
        }

        function closeClinicalFormModal() {
            const modal = document.getElementById('clinical-form-modal');
            modal.style.display = 'none';
        }

        function printClinicalFormContent() {
            const content = document.getElementById('clinical-form-preview').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Phiếu chỉ định cận lâm sàng</title>
                        <style>
                            /* A5 size in millimeters */
                            @page {
                                size: 148mm 210mm;
                                margin: 10mm;
                            }
                            
                            body {
                                font-family: 'Times New Roman', serif;
                                margin: 0;
                                padding: 0;
                                font-size: 12pt;
                                width: 128mm; /* 148mm - 20mm margins */
                            }
                            
                            /* Adjust table sizes */
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-bottom: 8px;
                            }
                            
                            td {
                                padding: 4px;
                                font-size: 11pt;
                            }
                            
                            /* Adjust heading sizes */
                            h1, h2, h3 {
                                margin: 4px 0;
                                font-size: 13pt;
                            }
                            
                            /* Compact paragraphs */
                            p {
                                margin: 4px 0;
                                line-height: 1.2;
                            }
                            
                            /* Service section */
                            div[style*="border:1px solid #000"] {
                                margin: 8px 0;
                                padding: 6px;
                            }
                            
                            @media print { 
                                body { 
                                    width: 128mm;
                                    height: 190mm; /* 210mm - 20mm margins */
                                }
                                .page-break { 
                                    page-break-after: always; 
                                }
                                /* Ẩn tiêu đề preview khi in */
                                h3[style*="color: #0000cc"] { display: none; }
                                /* Ẩn tiêu đề phiếu chỉ định khi in */
                                h2[style*="color:#0000cc"] { display: none; }
                                /* Đảm bảo page break hoạt động */
                                div[style*="page-break-after: always"] {
                                    page-break-after: always !important;
                                }
                                /* Ẩn border preview khi in */
                                div[style*="border: 2px solid #007bff"] {
                                    border: none !important;
                                    padding: 0 !important;
                                }
                            }
                            /* Hiển thị tiêu đề khi xem trước */
                            h3[style*="color: #0000cc"] { margin-bottom: 8px; }
                        </style>
                    </head>
                    <body>
                        <div style="max-width:128mm;margin:0 auto;">
                            ${content}
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Print a single clinical service (by master service_id)
        async function printSingleClinicalForm(appointmentId, serviceId) {
            try {
                // Store current appointment ID for PDF generation
                window.currentAppointmentId = appointmentId;
                
                const appointmentResponse = await fetch(`/api/appointments/${appointmentId}/full-info`);
                if (!appointmentResponse.ok) {
                    alert('Không tìm thấy thông tin bệnh nhân!');
                    return;
                }
                const appointment = await appointmentResponse.json();
                if (!appointment.clinical_services || appointment.clinical_services.length === 0) {
                    alert('Bệnh nhân chưa có dịch vụ cận lâm sàng.');
                    return;
                }
                const svc = appointment.clinical_services.find(s => String(s.service_id) === String(serviceId) || String(s.id) === String(serviceId));
                if (!svc) {
                    alert('Không tìm thấy dịch vụ để in.');
                    return;
                }

                const templateResponse = await fetch('/api/clinical-form-template/lab-request');
                const templateData = await templateResponse.json();
                const headerResponse = await fetch('/api/clinical-form-header');
                const headerData = await headerResponse.json();

                const filledTemplate = fillClinicalFormTemplate(templateData.template, appointment, svc);
                const fullContent = headerData.header + filledTemplate;
                showClinicalFormPreview([{ service: svc, content: fullContent }]);
            } catch (error) {
                console.error('Error printing single clinical form:', error);
                alert('Lỗi khi in phiếu chỉ định: ' + error.message);
            }
        }

        // Event listeners for clinical form and per-service buttons (delete/print)
        document.addEventListener('click', function(e) {
            // Print examination form (pregnancy or gynecology)
            if (e.target.closest('.print-examination-btn')) {
                const btn = e.target.closest('.print-examination-btn');
                const appointmentId = btn.getAttribute('data-appointment-id');
                const serviceType = btn.getAttribute('data-service-type') || '';
                printExaminationForm(appointmentId, serviceType);
                return;
            }
            
            // Print whole appointment clinical forms
            if (e.target.closest('.print-clinical-btn')) {
                const appointmentId = e.target.closest('.print-clinical-btn').getAttribute('data-appointment-id');
                printClinicalForm(appointmentId);
                return;
            }

            // Delete a single clinical service
            const delBtn = e.target.closest('.service-delete-btn');
            if (delBtn) {
                const appointmentId = delBtn.getAttribute('data-appointment-id');
                const serviceId = delBtn.getAttribute('data-service-id');
                if (!confirm('Bạn có chắc chắn muốn xóa dịch vụ này?')) return;
                fetch(`/api/appointments/${appointmentId}/clinical-services/${serviceId}`, { method: 'DELETE' })
                    .then(async r => {
                        if (!r.ok) {
                            const txt = await r.text().catch(()=>null);
                            throw new Error(txt || 'Lỗi khi xóa dịch vụ');
                        }
                        return r.json().catch(()=>({}));
                    })
                    .then(async ()=>{
                        // Reload services and appointments
                        if (state.currentAppointmentId == appointmentId) loadPatientClinicalServices(appointmentId);
                        loadAppointments();
                        
                        // Tự động đồng bộ sang lab-tests.html và lab-tests-dai-anh.html
                        await syncToLabTestsPages(appointmentId);
                        
                        // Tự động đồng bộ sang các trang xem kết quả cận lâm sàng
                        notifyClinicalResultsPages(appointmentId);
                    })
                    .catch(err=>{ alert('Lỗi: ' + (err.message || err)); console.error(err); });
                return;
            }

            // Print a single clinical service
            const printBtn = e.target.closest('.service-print-btn');
            if (printBtn) {
                const appointmentId = printBtn.getAttribute('data-appointment-id');
                const serviceId = printBtn.getAttribute('data-service-id');
                printSingleClinicalForm(appointmentId, serviceId);
                return;
            }

            // Open result modal (for all clinical services)
            const resultBtn = e.target.closest('.service-result-btn');
            if (resultBtn) {
                const appointmentId = resultBtn.getAttribute('data-appointment-id');
                const serviceName = resultBtn.getAttribute('data-service-name');
                const isUltrasound = resultBtn.getAttribute('data-is-ultrasound') === 'true';
                openClinicalResultModal(appointmentId, serviceName, isUltrasound);
                return;
            }

        });

        // Function to save clinical form as PDF
        async function saveClinicalFormAsPDF() {
            try {
                // Get the current appointment data
                const currentAppointmentId = window.currentAppointmentId;
                if (!currentAppointmentId) {
                    alert('Không tìm thấy thông tin cuộc hẹn');
                    return;
                }

                // Get appointment details
                const response = await fetch(`/api/appointments/${currentAppointmentId}`);
                if (!response.ok) {
                    alert('Không thể lấy thông tin cuộc hẹn');
                    return;
                }
                const appointment = await response.json();

                // Get patient details
                const patientResponse = await fetch(`/api/patients/${appointment.patient_id}`);
                if (!patientResponse.ok) {
                    alert('Không thể lấy thông tin bệnh nhân');
                    return;
                }
                const patient = await patientResponse.json();

                // Generate filename based on patient info and current date
                const now = new Date();
                const day = now.getDate().toString().padStart(2, '0');
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const year = now.getFullYear();
                const birthYear = patient.date_of_birth ? new Date(patient.date_of_birth).getFullYear() : '';
                
                // Clean patient name for filename
                const cleanName = patient.name.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_');
                const filename = `${cleanName}_${birthYear}.${day}.${month}.${year}.pdf`;

                // Get the clinical form content
                const formContent = document.getElementById('clinical-form-preview').innerHTML;
                
                // Create PDF via API
                const pdfResponse = await fetch('/api/generate-clinical-form-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: formContent,
                        filename: filename,
                        appointment_id: currentAppointmentId
                    })
                });

                if (pdfResponse.ok) {
                    // Download the PDF
                    const blob = await pdfResponse.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    alert('Đã lưu file PDF thành công!');
                } else {
                    const error = await pdfResponse.text();
                    alert('Lỗi khi tạo PDF: ' + error);
                }
            } catch (error) {
                console.error('Error saving PDF:', error);
                alert('Có lỗi xảy ra khi lưu PDF: ' + error.message);
            }
        }
    </script>

    <!-- Clinical Form Preview Modal -->
    <div id="clinical-form-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 90%; max-height: 90%; overflow-y: auto;">
            <div class="modal-header">
                <h3>Xem trước phiếu chỉ định cận lâm sàng</h3>
                <button class="close-btn" onclick="closeClinicalFormModal()" style="
                    background-color: #dc3545; 
                    color: white; 
                    border: none; 
                    border-radius: 50%; 
                    width: 60px; 
                    height: 60px; 
                    font-size: 30px; 
                    cursor: pointer; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                    font-weight: bold;
                    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
                    transition: all 0.3s ease;
                " onmouseover="this.style.backgroundColor='#c82333'; this.style.transform='scale(1.1)'" onmouseout="this.style.backgroundColor='#dc3545'; this.style.transform='scale(1)'">&times;</button>
            </div>
            <div id="clinical-form-preview" style="background: white; padding: 20px; border: 1px solid #ddd;">
                <!-- Clinical form content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="btn primary-btn" onclick="printClinicalFormContent()">
                    <i class="fas fa-print"></i> In phiếu
                </button>
                <button class="btn success-btn" onclick="saveClinicalFormAsPDF()">
                    <i class="fas fa-file-pdf"></i> Lưu PDF
                </button>
                <button class="btn secondary-btn" onclick="closeClinicalFormModal()">Đóng</button>
            </div>
        </div>
    </div>
    
    <script>
        // Clinical Result Functions (for all services)
        async function openClinicalResultModal(appointmentId, serviceName, isUltrasound) {
            try {
                // Get appointment info
                const appointment = await api.get(`/api/appointments/${appointmentId}`);
                const patientId = appointment.patient_id;
                
                // If ultrasound, use the existing ultrasound form
                if (isUltrasound) {
                    await openUltrasoundResultModal(appointmentId, serviceName);
                    return;
                }
                
                // For other services, load template and create dynamic form
                const contentDiv = document.getElementById('clinical-result-content');
                contentDiv.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Đang tải mẫu phiếu...</div>';
                
                // Show modal first
                document.getElementById('clinical-result-modal').classList.remove('hidden');
                
                // Try to load template - tự động lấy mẫu phiếu kết quả cận lâm sàng trùng tên dịch vụ
                // BẮT BUỘC phải có mẫu kết quả trùng tên với dịch vụ
                let template = null;
                try {
                    // Thử tìm mẫu phiếu theo tên dịch vụ chính xác trước
                    let templateResponse = await fetch(`/api/lab-result-templates/by-name?name=${encodeURIComponent(serviceName)}`);
                    if (templateResponse.ok) {
                        template = await templateResponse.json();
                        console.log('Đã tìm thấy mẫu phiếu theo tên chính xác:', template.name);
                    } else {
                        // Nếu không tìm thấy, thử tìm tất cả mẫu phiếu và tìm theo tên gần giống
                        const allTemplatesResponse = await fetch('/api/lab-result-templates');
                        if (allTemplatesResponse.ok) {
                            const allTemplates = await allTemplatesResponse.json();
                            const serviceNameLower = serviceName.toLowerCase().trim();
                            
                            // Tìm mẫu phiếu có tên chứa tên dịch vụ hoặc ngược lại
                            template = allTemplates.find(t => {
                                const templateNameLower = (t.name || '').toLowerCase().trim();
                                return templateNameLower === serviceNameLower ||
                                       templateNameLower.includes(serviceNameLower) ||
                                       serviceNameLower.includes(templateNameLower);
                            });
                            
                            if (template) {
                                console.log('Đã tìm thấy mẫu phiếu theo tên gần giống:', template.name);
                            } else {
                                console.log('Không tìm thấy mẫu phiếu cho dịch vụ:', serviceName);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Lỗi khi tìm mẫu phiếu:', error);
                }
                
                // BẮT BUỘC phải có mẫu kết quả - nếu không có thì báo lỗi và đóng modal
                if (!template || !template.content_html) {
                    // Đóng modal
                    closeClinicalResultModal();
                    
                    // Hiển thị thông báo lỗi rõ ràng với hướng dẫn và tùy chọn mở trang tạo mẫu
                    const errorMessage = `⚠️ CHƯA CÓ MẪU KẾT QUẢ CHO DỊCH VỤ: "${serviceName}"\n\n` +
                                        `Vui lòng tạo mẫu kết quả cận lâm sàng với tên trùng với dịch vụ trước khi nhập kết quả.\n\n` +
                                        `Tên mẫu cần tạo: "${serviceName}"\n\n` +
                                        `Bạn có muốn mở trang tạo mẫu kết quả ngay bây giờ không?`;
                    
                    if (confirm(errorMessage)) {
                        // Mở trang quản lý mẫu phiếu kết quả trong tab mới
                        window.open('/clinical-form-templates.html', '_blank');
                    }
                    return;
                }
                
                // Nếu có mẫu, tạo form từ template
                await createFormFromTemplate(template, appointmentId, patientId, serviceName);
            } catch (error) {
                console.error('Error opening clinical result modal:', error);
                alert('Lỗi khi mở form nhập kết quả: ' + error.message);
            }
        }

        async function createFormFromTemplate(template, appointmentId, patientId, serviceName) {
            const contentDiv = document.getElementById('clinical-result-content');
            
            // Parse template HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(template.content_html, 'text/html');
            
            // Extract form fields from template
            const formFields = [];
            doc.querySelectorAll('[data-field]').forEach(el => {
                const fieldName = el.getAttribute('data-field');
                const fieldType = el.tagName.toLowerCase();
                const fieldValue = el.textContent.trim() || el.value || '';
                const isEditable = el.contentEditable === 'true' || fieldType === 'input' || fieldType === 'textarea' || fieldType === 'select';
                
                if (fieldName && isEditable) {
                    formFields.push({
                        name: fieldName,
                        type: fieldType,
                        label: el.previousElementSibling?.textContent.trim() || fieldName,
                        value: fieldValue,
                        element: el
                    });
                }
            });
            
            // Create form HTML
            let formHTML = `
                <form id="clinical-result-form">
                    <input type="hidden" id="clinical-appointment-id" value="${appointmentId}" />
                    <input type="hidden" id="clinical-patient-id" value="${patientId}" />
                    <input type="hidden" id="clinical-service-name" value="${serviceName}" />
                    <input type="hidden" id="clinical-template-id" value="${template.id}" />
                    
                    <div style="margin-bottom:15px;">
                        <label><strong>Dịch vụ:</strong> ${serviceName}</label>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label for="clinical-exam-date">Ngày khám *</label>
                        <input type="datetime-local" id="clinical-exam-date" required style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;" />
                    </div>
                    
                    <div id="template-fields-container" style="display:grid; gap:15px; margin-bottom:20px;">
            `;
            
            // Add fields from template
            formFields.forEach(field => {
                const fieldId = `clinical-field-${field.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
                if (field.type === 'textarea' || (field.element && field.element.tagName.toLowerCase() === 'div' && field.element.contentEditable === 'true')) {
                    formHTML += `
                        <div>
                            <label for="${fieldId}">${field.label}</label>
                            <textarea id="${fieldId}" name="${field.name}" rows="3" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">${field.value}</textarea>
                        </div>
                    `;
                } else if (field.type === 'select' || (field.element && field.element.tagName.toLowerCase() === 'select')) {
                    const options = Array.from(field.element.options || []).map(opt => 
                        `<option value="${opt.value}" ${opt.selected ? 'selected' : ''}>${opt.text}</option>`
                    ).join('');
                    formHTML += `
                        <div>
                            <label for="${fieldId}">${field.label}</label>
                            <select id="${fieldId}" name="${field.name}" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">${options}</select>
                        </div>
                    `;
                } else {
                    formHTML += `
                        <div>
                            <label for="${fieldId}">${field.label}</label>
                            <input type="text" id="${fieldId}" name="${field.name}" value="${field.value}" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;" />
                        </div>
                    `;
                }
            });
            
            formHTML += `
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label>File PDF kết quả</label>
                        <div id="clinical-pdf-upload-area" style="border:2px dashed #ddd; border-radius:8px; padding:15px; text-align:center; background:#f9f9f9;">
                            <input type="file" id="clinical-pdf-file" accept=".pdf" style="display:none;" onchange="handlePdfUpload(event)" />
                            <button type="button" class="btn secondary-btn" onclick="document.getElementById('clinical-pdf-file').click()" style="margin-bottom:10px;">
                                <i class="fas fa-upload"></i> Tải lên PDF
                            </button>
                            <div id="clinical-pdf-preview" style="margin-top:10px;"></div>
                        </div>
                    </div>
                    
                    <div class="modal-actions" style="display:flex; gap:10px; justify-content:flex-end;">
                        <button type="button" class="btn secondary-btn" onclick="closeClinicalResultModal()">Hủy</button>
                        <button type="button" class="btn secondary-btn" onclick="document.getElementById('clinical-pdf-file').click()">
                            <i class="fas fa-file-pdf"></i> Tải lên PDF
                        </button>
                        <button type="submit" class="btn primary-btn">
                            <i class="fas fa-save"></i> Lưu kết quả
                        </button>
                    </div>
                </form>
            `;
            
            contentDiv.innerHTML = formHTML;
            
            // Attach form submit handler
            document.getElementById('clinical-result-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveClinicalResult(appointmentId, patientId, serviceName, template.id);
            });
            
            // Set default date
            const now = new Date();
            document.getElementById('clinical-exam-date').value = now.toISOString().slice(0, 16);
            
            // Load existing PDF if any
            loadExistingPdf(appointmentId, serviceName);
        }

        function createDefaultResultForm(appointmentId, patientId, serviceName) {
            const contentDiv = document.getElementById('clinical-result-content');
            contentDiv.innerHTML = `
                <form id="clinical-result-form">
                    <input type="hidden" id="clinical-appointment-id" value="${appointmentId}" />
                    <input type="hidden" id="clinical-patient-id" value="${patientId}" />
                    <input type="hidden" id="clinical-service-name" value="${serviceName}" />
                    
                    <div style="margin-bottom:15px;">
                        <label><strong>Dịch vụ:</strong> ${serviceName}</label>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label for="clinical-exam-date">Ngày khám *</label>
                        <input type="datetime-local" id="clinical-exam-date" required style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;" />
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label for="clinical-result-text">Kết quả <span style="color:#999; font-size:0.9em;">(hoặc tải file PDF)</span></label>
                        <textarea id="clinical-result-text" rows="3" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-family:'Times New Roman', Times, serif;" placeholder="Nhập kết quả cận lâm sàng..."></textarea>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label for="clinical-notes">Ghi chú</label>
                        <textarea id="clinical-notes" rows="2" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-family:'Times New Roman', Times, serif;" placeholder="Ghi chú thêm..."></textarea>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label>File PDF kết quả</label>
                        <div id="clinical-pdf-upload-area" style="border:2px dashed #ddd; border-radius:8px; padding:15px; text-align:center; background:#f9f9f9;">
                            <input type="file" id="clinical-pdf-file" accept=".pdf" style="display:none;" onchange="handlePdfUpload(event)" />
                            <button type="button" class="btn secondary-btn" onclick="document.getElementById('clinical-pdf-file').click()" style="margin-bottom:10px;">
                                <i class="fas fa-upload"></i> Tải lên PDF
                            </button>
                            <div id="clinical-pdf-preview" style="margin-top:10px;"></div>
                        </div>
                    </div>
                    
                    <div class="modal-actions" style="display:flex; gap:10px; justify-content:flex-end;">
                        <button type="button" class="btn secondary-btn" onclick="closeClinicalResultModal()">Hủy</button>
                        <button type="button" class="btn secondary-btn" onclick="document.getElementById('clinical-pdf-file').click()">
                            <i class="fas fa-file-pdf"></i> Tải lên PDF
                        </button>
                        <button type="submit" class="btn primary-btn">
                            <i class="fas fa-save"></i> Lưu kết quả
                        </button>
                    </div>
                </form>
            `;
            
            // Set default date
            const now = new Date();
            document.getElementById('clinical-exam-date').value = now.toISOString().slice(0, 16);
            
            // Attach form submit handler
            document.getElementById('clinical-result-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveClinicalResult(appointmentId, patientId, serviceName);
            });
            
            // Load existing PDF if any
            loadExistingPdf(appointmentId, serviceName);
        }

        function closeClinicalResultModal() {
            document.getElementById('clinical-result-modal').classList.add('hidden');
        }

        // Biến lưu file PDF đã upload
        let uploadedPdfFile = null;
        let uploadedPdfUrl = null;

        // Xử lý upload PDF
        async function handlePdfUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type !== 'application/pdf') {
                alert('Vui lòng chọn file PDF!');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) { // 10MB
                alert('File PDF không được vượt quá 10MB!');
                return;
            }
            
            try {
                // Tạo URL để preview
                uploadedPdfFile = file;
                uploadedPdfUrl = URL.createObjectURL(file);
                
                // Hiển thị preview
                const previewDiv = document.getElementById('clinical-pdf-preview');
                const pdfUrlForView = uploadedPdfUrl; // Lưu URL để dùng trong event listener
                previewDiv.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; padding:10px; background:#fff; border-radius:4px; border:1px solid #ddd;">
                        <i class="fas fa-file-pdf" style="font-size:24px; color:#dc3545;"></i>
                        <div style="flex:1;">
                            <div style="font-weight:bold;">${file.name}</div>
                            <div style="font-size:0.9rem; color:#666;">${(file.size / 1024).toFixed(2)} KB</div>
                        </div>
                        <button type="button" class="btn secondary-btn view-pdf-btn" style="padding:6px 12px; cursor:pointer;">
                            <i class="fas fa-eye"></i> Xem
                        </button>
                        <button type="button" class="btn danger-btn remove-pdf-btn" style="padding:6px 12px; cursor:pointer;">
                            <i class="fas fa-times"></i> Xóa
                        </button>
                    </div>
                `;
                
                // Attach event listeners
                previewDiv.querySelector('.view-pdf-btn').addEventListener('click', function() {
                    viewPdfPreview(uploadedPdfUrl);
                });
                previewDiv.querySelector('.remove-pdf-btn').addEventListener('click', function() {
                    removePdfUpload();
                });
            } catch (error) {
                console.error('Error handling PDF upload:', error);
                alert('Lỗi khi xử lý file PDF: ' + error.message);
            }
        }

        // Xem PDF preview - hàm global để có thể gọi từ onclick
        window.viewPdfPreview = function(pdfUrl) {
            console.log('Opening PDF viewer with URL:', pdfUrl);
            
            if (!pdfUrl) {
                alert('Không có URL PDF để hiển thị!');
                return;
            }
            
            // Kiểm tra xem có phải blob URL không - nếu là blob URL, mở trực tiếp trong tab mới
            if (pdfUrl.startsWith('blob:')) {
                // Với blob URL, mở trực tiếp trong tab mới vì embed/iframe thường không hoạt động
                window.open(pdfUrl, '_blank');
                return;
            }
            
            // Xóa modal cũ nếu có
            const oldModal = document.getElementById('pdf-viewer-modal');
            if (oldModal) {
                oldModal.remove();
            }
            
            // Tạo modal để xem PDF
            const modal = document.createElement('div');
            modal.id = 'pdf-viewer-modal';
            modal.className = 'modal';
            modal.style.cssText = 'position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.9); z-index:10000; display:flex; align-items:center; justify-content:center;';
            
            const closeBtnId = 'close-pdf-viewer-' + Date.now();
            const containerId = 'pdf-container-' + Date.now();
            const loadingDivId = 'pdf-loading-' + Date.now();
            
            // Kiểm tra xem URL có phải là blob URL không
            const isBlobUrl = pdfUrl.startsWith('blob:');
            
            modal.innerHTML = `
                <div style="position:relative; width:95vw; height:95vh; background:#fff; border-radius:8px; padding:20px; display:flex; flex-direction:column; box-shadow:0 4px 20px rgba(0,0,0,0.5);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-shrink:0;">
                        <h3 style="margin:0; color:#333; font-size:18px;">Xem PDF kết quả</h3>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <a href="${pdfUrl}" target="_blank" download style="padding:8px 15px; background:#28a745; color:white; text-decoration:none; border-radius:4px; font-size:14px;">
                                <i class="fas fa-download"></i> Tải xuống
                            </a>
                            <button id="${closeBtnId}" style="background:#dc3545; color:white; border:none; border-radius:50%; width:40px; height:40px; font-size:24px; cursor:pointer; transition:all 0.3s;" onmouseover="this.style.backgroundColor='#c82333'; this.style.transform='scale(1.1)'" onmouseout="this.style.backgroundColor='#dc3545'; this.style.transform='scale(1)'">&times;</button>
                        </div>
                    </div>
                    <div id="${containerId}" style="flex:1; position:relative; min-height:0; overflow:hidden; border:1px solid #ddd; border-radius:4px; background:#f5f5f5;">
                        <div id="${loadingDivId}" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center; color:#666; background:rgba(255,255,255,0.95); padding:30px; border-radius:8px; z-index:10;">
                            <i class="fas fa-spinner fa-spin" style="font-size:32px; margin-bottom:15px; color:#007bff;"></i>
                            <div style="font-size:16px; font-weight:bold;">Đang tải PDF...</div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            const container = document.getElementById(containerId);
            const loadingDiv = document.getElementById(loadingDivId);
            
            // Tạo iframe hoặc embed để hiển thị PDF
            if (isBlobUrl) {
                // Với blob URL, thử dùng embed tag trước
                const embedTag = document.createElement('embed');
                embedTag.src = pdfUrl + '#toolbar=1&navpanes=1&scrollbar=1';
                embedTag.type = 'application/pdf';
                embedTag.style.cssText = 'width:100%; height:100%; border:none;';
                container.appendChild(embedTag);
                
                // Kiểm tra sau 1 giây xem có hiển thị được không
                setTimeout(function() {
                    // Nếu vẫn không thấy, hiển thị fallback
                    const checkDisplay = embedTag.offsetHeight > 0 && embedTag.offsetWidth > 0;
                    if (!checkDisplay || container.querySelector('embed').offsetHeight < 50) {
                        container.innerHTML = '';
                        const fallbackDiv = document.createElement('div');
                        fallbackDiv.style.cssText = 'width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px; text-align:center;';
                        fallbackDiv.innerHTML = `
                            <i class="fas fa-file-pdf" style="font-size:64px; color:#dc3545; margin-bottom:20px;"></i>
                            <div style="font-size:18px; font-weight:bold; margin-bottom:10px; color:#333;">PDF không thể hiển thị trực tiếp</div>
                            <div style="font-size:14px; color:#666; margin-bottom:30px;">Vui lòng click vào nút bên dưới để mở PDF trong tab mới</div>
                            <a href="${pdfUrl}" target="_blank" style="padding:12px 30px; background:#007bff; color:white; text-decoration:none; border-radius:6px; font-size:16px; display:inline-block;">
                                <i class="fas fa-external-link-alt"></i> Mở PDF trong tab mới
                            </a>
                        `;
                        container.appendChild(fallbackDiv);
                    }
                    if (loadingDiv) {
                        loadingDiv.style.display = 'none';
                    }
                }, 1500);
            } else {
                // Với HTTP URL, dùng iframe
                const iframe = document.createElement('iframe');
                iframe.src = pdfUrl;
                iframe.style.cssText = 'width:100%; height:100%; border:none;';
                iframe.frameBorder = '0';
                iframe.allow = 'fullscreen';
                container.appendChild(iframe);
                
                let loaded = false;
                
                iframe.onload = function() {
                    console.log('PDF iframe loaded successfully');
                    loaded = true;
                    if (loadingDiv) {
                        loadingDiv.style.display = 'none';
                    }
                };
                
                iframe.onerror = function() {
                    console.error('PDF iframe load error');
                    if (loadingDiv) {
                        loadingDiv.innerHTML = `
                            <div style="color:#dc3545; text-align:center;">
                                <i class="fas fa-exclamation-triangle" style="font-size:32px; margin-bottom:15px;"></i>
                                <div style="font-size:16px; font-weight:bold; margin-bottom:10px;">Không thể tải PDF</div>
                                <a href="${pdfUrl}" target="_blank" style="padding:10px 20px; background:#007bff; color:white; text-decoration:none; border-radius:4px; display:inline-block; margin-top:10px;">
                                    <i class="fas fa-external-link-alt"></i> Mở trong tab mới
                                </a>
                            </div>
                        `;
                    }
                };
                
                // Fallback: kiểm tra sau 3 giây
                setTimeout(function() {
                    if (!loaded) {
                        // Kiểm tra xem iframe có nội dung không
                        try {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            if (!iframeDoc || iframeDoc.body.innerHTML.trim() === '') {
                                // Iframe trống, hiển thị fallback
                                container.innerHTML = '';
                                const fallbackDiv = document.createElement('div');
                                fallbackDiv.style.cssText = 'width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px; text-align:center;';
                                fallbackDiv.innerHTML = `
                                    <i class="fas fa-file-pdf" style="font-size:64px; color:#dc3545; margin-bottom:20px;"></i>
                                    <div style="font-size:18px; font-weight:bold; margin-bottom:10px; color:#333;">PDF không thể hiển thị trực tiếp</div>
                                    <div style="font-size:14px; color:#666; margin-bottom:30px;">Vui lòng click vào nút bên dưới để mở PDF trong tab mới</div>
                                    <a href="${pdfUrl}" target="_blank" style="padding:12px 30px; background:#007bff; color:white; text-decoration:none; border-radius:6px; font-size:16px; display:inline-block;">
                                        <i class="fas fa-external-link-alt"></i> Mở PDF trong tab mới
                                    </a>
                                `;
                                container.appendChild(fallbackDiv);
                            }
                        } catch (e) {
                            // CORS error hoặc không truy cập được, hiển thị fallback
                            console.warn('Cannot access iframe content:', e);
                            container.innerHTML = '';
                            const fallbackDiv = document.createElement('div');
                            fallbackDiv.style.cssText = 'width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px; text-align:center;';
                            fallbackDiv.innerHTML = `
                                <i class="fas fa-file-pdf" style="font-size:64px; color:#dc3545; margin-bottom:20px;"></i>
                                <div style="font-size:18px; font-weight:bold; margin-bottom:10px; color:#333;">PDF không thể hiển thị trực tiếp</div>
                                <div style="font-size:14px; color:#666; margin-bottom:30px;">Vui lòng click vào nút bên dưới để mở PDF trong tab mới</div>
                                <a href="${pdfUrl}" target="_blank" style="padding:12px 30px; background:#007bff; color:white; text-decoration:none; border-radius:6px; font-size:16px; display:inline-block;">
                                    <i class="fas fa-external-link-alt"></i> Mở PDF trong tab mới
                                </a>
                            `;
                            container.appendChild(fallbackDiv);
                        }
                    }
                    if (loadingDiv) {
                        loadingDiv.style.display = 'none';
                    }
                }, 3000);
            }
            
            // Attach close button event
            document.getElementById(closeBtnId).addEventListener('click', function() {
                closePdfViewer();
            });
            
            // Đóng modal khi click ra ngoài
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closePdfViewer();
                }
            });
            
            // Đóng modal khi nhấn ESC
            const escHandler = function(e) {
                if (e.key === 'Escape') {
                    closePdfViewer();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        };

        window.closePdfViewer = function() {
            const modal = document.getElementById('pdf-viewer-modal');
            if (modal) {
                modal.remove();
            }
        };

        // Xóa PDF đã upload
        function removePdfUpload() {
            if (uploadedPdfUrl) {
                URL.revokeObjectURL(uploadedPdfUrl);
            }
            uploadedPdfFile = null;
            uploadedPdfUrl = null;
            document.getElementById('clinical-pdf-file').value = '';
            document.getElementById('clinical-pdf-preview').innerHTML = '';
        }

        // Load PDF đã có sẵn
        async function loadExistingPdf(appointmentId, serviceName) {
            try {
                const response = await fetch(`/api/clinical-results?appointment_id=${appointmentId}&service_name=${encodeURIComponent(serviceName)}`);
                if (response.ok) {
                    const results = await response.json();
                    if (results && results.length > 0) {
                        const result = results[0];
                        if (result.pdf_file_path) {
                            // Hiển thị PDF đã có
                            const previewDiv = document.getElementById('clinical-pdf-preview');
                            const fileName = result.pdf_file_path.split('/').pop() || 'File PDF đã lưu';
                            const pdfViewUrl = `/api/clinical-results/pdf/${result.id}`;
                            previewDiv.innerHTML = `
                                <div style="display:flex; align-items:center; gap:10px; padding:10px; background:#fff; border-radius:4px; border:1px solid #ddd; cursor:pointer;" class="pdf-preview-item">
                                    <i class="fas fa-file-pdf" style="font-size:24px; color:#dc3545;"></i>
                                    <div style="flex:1;">
                                        <div style="font-weight:bold;">${fileName}</div>
                                        <div style="font-size:0.9rem; color:#666;">Click để xem</div>
                                    </div>
                                    <button type="button" class="btn secondary-btn view-pdf-btn" style="padding:6px 12px; cursor:pointer;">
                                        <i class="fas fa-eye"></i> Xem
                                    </button>
                                    <button type="button" class="btn danger-btn delete-pdf-btn" style="padding:6px 12px; cursor:pointer;">
                                        <i class="fas fa-trash"></i> Xóa
                                    </button>
                                </div>
                            `;
                            
                            // Attach event listeners
                            const pdfItem = previewDiv.querySelector('.pdf-preview-item');
                            const viewBtn = previewDiv.querySelector('.view-pdf-btn');
                            const deleteBtn = previewDiv.querySelector('.delete-pdf-btn');
                            
                            pdfItem.addEventListener('click', function(e) {
                                if (e.target !== viewBtn && e.target !== deleteBtn && !viewBtn.contains(e.target) && !deleteBtn.contains(e.target)) {
                                    viewPdfPreview(pdfViewUrl);
                                }
                            });
                            
                            viewBtn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                viewPdfPreview(pdfViewUrl);
                            });
                            
                            deleteBtn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                deletePdfFile(result.id);
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading existing PDF:', error);
            }
        }

        // Xóa file PDF
        async function deletePdfFile(resultId) {
            if (!confirm('Bạn có chắc muốn xóa file PDF này?')) return;
            
            try {
                const response = await fetch(`/api/clinical-results/${resultId}/pdf`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Đã xóa file PDF thành công!');
                    // Reload PDF preview
                    const appointmentId = document.getElementById('clinical-appointment-id').value;
                    const serviceName = document.getElementById('clinical-service-name').value;
                    loadExistingPdf(appointmentId, serviceName);
                } else {
                    const error = await response.json();
                    alert('Lỗi khi xóa file PDF: ' + (error.message || 'Lỗi không xác định'));
                }
            } catch (error) {
                console.error('Error deleting PDF:', error);
                alert('Lỗi khi xóa file PDF: ' + error.message);
            }
        }

        async function saveClinicalResult(appointmentId, patientId, serviceName, templateId) {
            try {
                const examDate = document.getElementById('clinical-exam-date').value;
                const form = document.getElementById('clinical-result-form');
                
                // Kiểm tra: phải có nội dung trong ô kết quả HOẶC có file PDF
                let hasResultText = false;
                let hasFields = false;
                
                // Kiểm tra ô kết quả (default form)
                const resultTextEl = document.getElementById('clinical-result-text');
                if (resultTextEl && resultTextEl.value.trim()) {
                    hasResultText = true;
                }
                
                // Kiểm tra các field từ template
                form.querySelectorAll('input[name], textarea[name], select[name]').forEach(el => {
                    if (el.id !== 'clinical-appointment-id' && el.id !== 'clinical-patient-id' && el.id !== 'clinical-service-name' && el.id !== 'clinical-template-id') {
                        if (el.value && el.value.trim()) {
                            hasFields = true;
                        }
                    }
                });
                
                // Kiểm tra file PDF
                const hasPdf = uploadedPdfFile !== null;
                
                // Nếu không có nội dung và không có PDF, không cho phép lưu
                if (!hasResultText && !hasFields && !hasPdf) {
                    alert('Vui lòng nhập kết quả hoặc tải lên file PDF!');
                    return;
                }
                
                // Collect all field values
                const resultData = {
                    appointment_id: appointmentId,
                    patient_id: parseInt(patientId),
                    service_name: serviceName,
                    exam_date: examDate,
                    template_id: templateId || null,
                    fields: {}
                };
                
                // Get all input/textarea/select values
                form.querySelectorAll('input[name], textarea[name], select[name]').forEach(el => {
                    if (el.id !== 'clinical-appointment-id' && el.id !== 'clinical-patient-id' && el.id !== 'clinical-service-name' && el.id !== 'clinical-template-id') {
                        resultData.fields[el.name] = el.value;
                    }
                });
                
                // For default form
                if (document.getElementById('clinical-result-text')) {
                    resultData.result_text = document.getElementById('clinical-result-text').value || '';
                    resultData.notes = document.getElementById('clinical-notes').value || '';
                }
                
                // Upload PDF if exists
                if (uploadedPdfFile) {
                    const formData = new FormData();
                    formData.append('pdf_file', uploadedPdfFile);
                    formData.append('result_data', JSON.stringify(resultData));
                    
                    const response = await fetch('/api/clinical-results/with-pdf', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        alert('Đã lưu kết quả và file PDF thành công!');
                        closeClinicalResultModal();
                        // Clean up
                        if (uploadedPdfUrl) {
                            URL.revokeObjectURL(uploadedPdfUrl);
                        }
                        uploadedPdfFile = null;
                        uploadedPdfUrl = null;
                        // Reload services list to show updated result
                        if (window.loadServices) {
                            window.loadServices();
                        }
                    } else {
                        const errorText = await response.text();
                        let errorMessage = 'Lỗi không xác định';
                        try {
                            const errorJson = JSON.parse(errorText);
                            errorMessage = errorJson.message || errorMessage;
                        } catch (e) {
                            errorMessage = errorText || errorMessage;
                        }
                        alert('Lỗi khi lưu kết quả: ' + errorMessage);
                        console.error('Error response:', errorText);
                    }
                } else {
                    // Save without PDF
                    const response = await fetch('/api/clinical-results', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(resultData)
                    });
                    
                    if (response.ok) {
                        alert('Đã lưu kết quả thành công!');
                        closeClinicalResultModal();
                        // Reload services list to show updated result
                        if (window.loadServices) {
                            window.loadServices();
                        }
                    } else {
                        const errorText = await response.text();
                        let errorMessage = 'Lỗi không xác định';
                        try {
                            const errorJson = JSON.parse(errorText);
                            errorMessage = errorJson.message || errorMessage;
                        } catch (e) {
                            errorMessage = errorText || errorMessage;
                        }
                        alert('Lỗi khi lưu kết quả: ' + errorMessage);
                        console.error('Error response:', errorText);
                    }
                }
            } catch (error) {
                console.error('Error saving clinical result:', error);
                alert('Lỗi khi lưu kết quả: ' + error.message);
            }
        }

        // Ultrasound Result Functions (keep for backward compatibility)
        async function openUltrasoundResultModal(appointmentId, serviceName) {
            try {
                // Get appointment info
                const appointment = await api.get(`/api/appointments/${appointmentId}`);
                const patientId = appointment.patient_id;
                
                // Set appointment and patient IDs
                document.getElementById('ultrasound-appointment-id').value = appointmentId;
                document.getElementById('ultrasound-patient-id').value = patientId;
                document.getElementById('ultrasound-result-id').value = '';
                
                // Set default exam date to now
                const now = new Date();
                const examDateInput = document.getElementById('ultrasound-exam-date');
                examDateInput.value = now.toISOString().slice(0, 16);
                
                // Check if there's existing result
                const existingResults = await api.get(`/api/ultrasound-results?appointment_id=${appointmentId}`);
                if (existingResults && existingResults.length > 0) {
                    const result = existingResults[0];
                    document.getElementById('ultrasound-result-id').value = result.id;
                    loadUltrasoundResultData(result);
                    document.getElementById('print-ultrasound-btn').style.display = 'inline-block';
                } else {
                    // Clear form
                    document.getElementById('ultrasound-result-form').reset();
                    document.getElementById('ultrasound-appointment-id').value = appointmentId;
                    document.getElementById('ultrasound-patient-id').value = patientId;
                    document.getElementById('ultrasound-exam-date').value = now.toISOString().slice(0, 16);
                    document.getElementById('print-ultrasound-btn').style.display = 'none';
                    
                    // Try to load template data if service name is provided
                    if (serviceName) {
                        await loadTemplateDataToForm(serviceName);
                    }
                }
                
                // Show modal
                document.getElementById('ultrasound-result-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error opening ultrasound modal:', error);
                alert('Lỗi khi mở form nhập kết quả siêu âm: ' + error.message);
            }
        }

        // Load template data and fill form - tự động lấy mẫu phiếu kết quả cận lâm sàng trùng tên dịch vụ
        async function loadTemplateDataToForm(serviceName) {
            try {
                // Tìm mẫu phiếu theo tên dịch vụ - thử tìm chính xác trước
                let template = null;
                let response = await fetch(`/api/lab-result-templates/by-name?name=${encodeURIComponent(serviceName)}`);
                if (response.ok) {
                    template = await response.json();
                    console.log('Đã tìm thấy mẫu phiếu theo tên chính xác:', template.name);
                } else {
                    // Nếu không tìm thấy, thử tìm tất cả mẫu phiếu và tìm theo tên gần giống
                    const allTemplatesResponse = await fetch('/api/lab-result-templates');
                    if (allTemplatesResponse.ok) {
                        const allTemplates = await allTemplatesResponse.json();
                        const serviceNameLower = serviceName.toLowerCase().trim();
                        
                        // Tìm mẫu phiếu có tên chứa tên dịch vụ hoặc ngược lại
                        template = allTemplates.find(t => {
                            const templateNameLower = (t.name || '').toLowerCase().trim();
                            return templateNameLower === serviceNameLower ||
                                   templateNameLower.includes(serviceNameLower) ||
                                   serviceNameLower.includes(templateNameLower);
                        });
                        
                        if (template) {
                            console.log('Đã tìm thấy mẫu phiếu theo tên gần giống:', template.name);
                        } else {
                            console.log('Không tìm thấy mẫu phiếu cho dịch vụ:', serviceName);
                            return;
                        }
                    } else {
                        console.log('Không thể lấy danh sách mẫu phiếu');
                        return;
                    }
                }
                
                if (!template) {
                    console.log('Không tìm thấy mẫu phiếu cho dịch vụ:', serviceName);
                    return;
                }
                
                // Parse HTML template to extract ultrasound data
                const parser = new DOMParser();
                const doc = parser.parseFromString(template.content_html, 'text/html');
                
                // Extract data from template HTML
                // Look for data-field attributes or specific patterns
                const templateData = {};
                
                // Try to extract values from contenteditable elements with data-field
                doc.querySelectorAll('[data-field]').forEach(el => {
                    const field = el.getAttribute('data-field');
                    const value = el.textContent.trim();
                    if (value && field) {
                        templateData[field] = value;
                    }
                });
                
                // Try to extract from input fields
                doc.querySelectorAll('input[data-field], select[data-field], textarea[data-field]').forEach(el => {
                    const field = el.getAttribute('data-field');
                    const value = el.value || el.textContent.trim();
                    if (value && field) {
                        templateData[field] = value;
                    }
                });
                
                // Map template fields to ultrasound form fields
                const fieldMapping = {
                    'gestational_age': ['gestational_age', 'tuoi_thai', 'tuổi_thai', 'ga'],
                    'bpd': ['bpd', 'duong_kinh_luong_dinh'],
                    'hc': ['hc', 'chu_vi_dau', 'head_circumference'],
                    'ac': ['ac', 'chu_vi_bung', 'abdominal_circumference'],
                    'fl': ['fl', 'chieu_dai_xuong_dui', 'femur_length'],
                    'estimated_weight': ['estimated_weight', 'can_nang', 'cân_nặng', 'weight'],
                    'fetal_position': ['fetal_position', 'ngoi_thai', 'ngôi_thai'],
                    'placenta_position': ['placenta_position', 'vi_tri_nhau', 'vị_trí_nhau'],
                    'amniotic_fluid': ['amniotic_fluid', 'nuoc_oi', 'nước_ối'],
                    'afi': ['afi'],
                    'cervical_length': ['cervical_length', 'chieu_dai_co_tu_cung'],
                    'ri_umbilical': ['ri_umbilical', 'ri_dong_mach_ron'],
                    'sd_ratio': ['sd_ratio', 'sd_ratio'],
                    'mca_pi': ['mca_pi'],
                    'findings': ['findings', 'nhan_xet', 'nhận_xét', 'ket_qua', 'kết_quả'],
                    'recommendations': ['recommendations', 'khuyen_nghi', 'khuyến_nghị']
                };
                
                // Fill form with extracted data
                Object.keys(fieldMapping).forEach(formField => {
                    const possibleKeys = fieldMapping[formField];
                    for (const key of possibleKeys) {
                        if (templateData[key]) {
                            const formElement = document.getElementById(`ultrasound-${formField}`);
                            if (formElement) {
                                // Try to parse number values
                                if (['gestational_age', 'bpd', 'hc', 'ac', 'fl', 'estimated_weight', 'afi', 'cervical_length', 'ri_umbilical', 'sd_ratio', 'mca_pi'].includes(formField)) {
                                    const numValue = parseFloat(templateData[key]);
                                    if (!isNaN(numValue)) {
                                        formElement.value = numValue;
                                        break;
                                    }
                                } else {
                                    formElement.value = templateData[key];
                                    break;
                                }
                            }
                        }
                    }
                });
                
                console.log('Loaded template data:', templateData);
            } catch (error) {
                console.error('Error loading template data:', error);
                // Don't show error to user, just log it
            }
        }

        function loadUltrasoundResultData(result) {
            if (result.exam_date) {
                const examDate = new Date(result.exam_date);
                document.getElementById('ultrasound-exam-date').value = examDate.toISOString().slice(0, 16);
            }
            document.getElementById('ultrasound-gestational-age').value = result.gestational_age || '';
            document.getElementById('ultrasound-bpd').value = result.bpd || '';
            document.getElementById('ultrasound-hc').value = result.hc || '';
            document.getElementById('ultrasound-ac').value = result.ac || '';
            document.getElementById('ultrasound-fl').value = result.fl || '';
            document.getElementById('ultrasound-ri-umbilical').value = result.ri_umbilical || '';
            document.getElementById('ultrasound-sd-ratio').value = result.sd_ratio || '';
            document.getElementById('ultrasound-mca-pi').value = result.mca_pi || '';
            document.getElementById('ultrasound-cervical-length').value = result.cervical_length || '';
            document.getElementById('ultrasound-afi').value = result.afi || '';
            document.getElementById('ultrasound-estimated-weight').value = result.estimated_weight || '';
            document.getElementById('ultrasound-fetal-position').value = result.fetal_position || '';
            document.getElementById('ultrasound-placenta-position').value = result.placenta_position || '';
            document.getElementById('ultrasound-amniotic-fluid').value = result.amniotic_fluid || '';
            document.getElementById('ultrasound-findings').value = result.findings || '';
            document.getElementById('ultrasound-recommendations').value = result.recommendations || '';
        }

        function closeUltrasoundModal() {
            document.getElementById('ultrasound-result-modal').classList.add('hidden');
        }

        // Handle form submission
        document.getElementById('ultrasound-result-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const appointmentId = document.getElementById('ultrasound-appointment-id').value;
                const patientId = document.getElementById('ultrasound-patient-id').value;
                const resultId = document.getElementById('ultrasound-result-id').value;
                
                const formData = {
                    patient_id: parseInt(patientId),
                    appointment_id: parseInt(appointmentId),
                    exam_date: document.getElementById('ultrasound-exam-date').value,
                    gestational_age: parseFloat(document.getElementById('ultrasound-gestational-age').value) || null,
                    bpd: parseFloat(document.getElementById('ultrasound-bpd').value) || null,
                    hc: parseFloat(document.getElementById('ultrasound-hc').value) || null,
                    ac: parseFloat(document.getElementById('ultrasound-ac').value) || null,
                    fl: parseFloat(document.getElementById('ultrasound-fl').value) || null,
                    ri_umbilical: parseFloat(document.getElementById('ultrasound-ri-umbilical').value) || null,
                    sd_ratio: parseFloat(document.getElementById('ultrasound-sd-ratio').value) || null,
                    mca_pi: parseFloat(document.getElementById('ultrasound-mca-pi').value) || null,
                    cervical_length: parseFloat(document.getElementById('ultrasound-cervical-length').value) || null,
                    afi: parseFloat(document.getElementById('ultrasound-afi').value) || null,
                    estimated_weight: parseFloat(document.getElementById('ultrasound-estimated-weight').value) || null,
                    fetal_position: document.getElementById('ultrasound-fetal-position').value || null,
                    placenta_position: document.getElementById('ultrasound-placenta-position').value || null,
                    amniotic_fluid: document.getElementById('ultrasound-amniotic-fluid').value || null,
                    findings: document.getElementById('ultrasound-findings').value || null,
                    recommendations: document.getElementById('ultrasound-recommendations').value || null,
                    analysis_source: 'manual_input'
                };
                
                let response;
                if (resultId) {
                    // Update existing result
                    response = await fetch(`/api/ultrasound-results/${resultId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                } else {
                    // Create new result
                    response = await fetch('/api/ultrasound-results', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                }
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.id) {
                        document.getElementById('ultrasound-result-id').value = result.id;
                    }
                    document.getElementById('print-ultrasound-btn').style.display = 'inline-block';
                    alert('Đã lưu kết quả siêu âm thành công!');
                } else {
                    const error = await response.json();
                    alert('Lỗi khi lưu kết quả: ' + (error.message || 'Lỗi không xác định'));
                }
            } catch (error) {
                console.error('Error saving ultrasound result:', error);
                alert('Lỗi khi lưu kết quả siêu âm: ' + error.message);
            }
        });

        async function printUltrasoundResult() {
            const resultId = document.getElementById('ultrasound-result-id').value;
            const appointmentId = document.getElementById('ultrasound-appointment-id').value;
            
            if (!resultId) {
                alert('Vui lòng lưu kết quả trước khi in!');
                return;
            }
            
            try {
                // Open print window with ultrasound result
                window.open(`/api/print_ultrasound/${appointmentId}?result_id=${resultId}`, '_blank');
            } catch (error) {
                console.error('Error printing ultrasound result:', error);
                alert('Lỗi khi in kết quả: ' + error.message);
            }
        }
    </script>
    
    <!-- AI Assistant - Luôn hiển thị trên mọi trang -->
    <script src="ai-assistant.js"></script>
    <script src="footer-loader.js"></script>
</body>
</html> 
