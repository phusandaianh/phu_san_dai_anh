<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ sơ bệnh án - Phòng khám Phụ Sản Đại Anh</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-header {
            background-color: white;
            color: #2196F3;
            padding: 1rem 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #2196F3;
        }
        .admin-header .logo img {
            height: 50px;
            margin-right: 10px;
        }
        .admin-header .logo {
            display: flex;
            align-items: center;
        }
        .admin-header nav {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        .admin-header .nav-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .admin-header .back-link {
            color: #2196F3;
            text-decoration: none;
            display: flex;
            align-items: center;
        }
        .admin-header .back-link.btn.secondary-btn {
            background-color: transparent;
            border: 1px solid #2196F3;
            color: #2196F3;
        }
        .admin-main {
            padding: 20px;
        }
        .search-filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-filters input, .search-filters select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .search-filters input[type="text"] {
            min-width: 200px;
        }
        .search-filters input[type="date"] {
            min-width: 150px;
        }
        .search-filters select {
            min-width: 120px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-primary {
            background: #2196F3;
            color: white;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .records-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-header h3 {
            margin: 0;
            color: #333;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .hidden {
            display: none !important;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            min-width: 500px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .clinical-results-modal {
            width: 95vw;
            max-width: 95vw;
            height: 95vh;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
        }
        .clinical-results-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 20px;
        }
        .clinical-results-meta {
            font-size: 0.95rem;
            color: #555;
            line-height: 1.6;
        }
        .close-modal-btn {
            border: none;
            background: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        .clinical-results-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            flex-wrap: wrap;
        }
        .clinical-results-list {
            flex: 2;
            max-width: 100%;
        }
        .clinical-results-editor-wrapper {
            flex: 1.2;
            min-width: 320px;
            border-left: 1px solid #eee;
            padding-left: 20px;
        }
        @media (max-width: 992px) {
            .clinical-results-layout {
                flex-direction: column;
            }
            .clinical-results-editor-wrapper {
                border-left: none;
                border-top: 1px solid #eee;
                padding-left: 0;
                padding-top: 20px;
                width: 100%;
            }
        }
        .clinical-result-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            background: #fafafa;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }
        .clinical-result-card h4 {
            margin: 0;
            font-size: 1rem;
            color: #333;
        }
        .clinical-result-card small {
            color: #777;
        }
        .result-summary {
            margin: 10px 0;
            font-size: 0.95rem;
            white-space: pre-wrap;
        }
        .clinical-result-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .clinical-result-card .result-details {
            margin-top: 12px;
            display: none;
        }
        .clinical-result-card.active {
            border-color: #2196F3;
            background: #f0f8ff;
        }
        .clinical-result-card.active .result-details {
            display: block;
        }
        .clinical-result-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .card-header span {
            font-size: 0.85rem;
            color: #666;
        }
        .btn-outline {
            border: 1px solid #2196F3;
            color: #2196F3;
            background: transparent;
        }
        .btn-outline:hover {
            background: #2196F3;
            color: white;
        }
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #777;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .field-editor-group {
            margin-bottom: 12px;
        }
        .field-editor-group label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 4px;
            color: #555;
        }
        .field-editor-group input,
        .field-editor-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .clinical-group {
            margin-bottom: 24px;
        }
        .clinical-group-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .clinical-group-title span {
            font-size: 0.9rem;
            color: #777;
        }
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            background: #f5f5f5;
        }
        .group-header h4 {
            margin: 0;
        }
        .group-content {
            margin-top: 12px;
            display: none;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        .no-records {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        .pagination button:hover {
            background: #f8f9fa;
        }
        .pagination button.active {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .subheading-wrap {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .record-quick-links {
            margin-left: auto;
            display: inline-flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .record-quick-links .btn-outline {
            border: 1px solid #2196F3;
            color: #2196F3;
            background: transparent;
        }
        .record-quick-links .btn-outline:hover {
            background: #e3f2fd;
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="logo">
            <img src="logo_phu_san_dai_anh.PNG" alt="Logo Phòng khám Đại Anh">
            <div>
                <h1>Hồ sơ bệnh án</h1>
                <div class="subheading-wrap">
                    <p style="margin: 0;">Quản lý hồ sơ bệnh nhân</p>
                    <div class="record-quick-links">
                        <button type="button" class="btn btn-outline" onclick="openMedicalRecord('san')">Bệnh Án Sản</button>
                        <button type="button" class="btn btn-outline" onclick="openMedicalRecord('phu-khoa')">Bệnh Án Phụ Khoa</button>
                    </div>
                </div>
            </div>
        </div>
        <nav>
            <div class="nav-row">
                <a href="index.html" class="back-link btn secondary-btn">
                    <i class="fas fa-home"></i> Trang chủ
                </a>
                <a href="admin.html" class="back-link btn secondary-btn">
                    <i class="fas fa-cog"></i> Quản trị
                </a>
            </div>
        </nav>
    </header>

    <main class="admin-main">
        <!-- Search and Filters -->
        <div class="search-filters">
            <input type="text" id="search-name" placeholder="Tìm theo tên bệnh nhân">
            <input type="text" id="search-phone" placeholder="Tìm theo số điện thoại">
            <input type="date" id="search-date-from" placeholder="Từ ngày">
            <input type="date" id="search-date-to" placeholder="Đến ngày">
            <select id="filter-status">
                <option value="">Tất cả trạng thái</option>
                <option value="pending">Chờ khám</option>
                <option value="completed">Đã khám</option>
                <option value="cancelled">Đã hủy</option>
            </select>
            <button class="btn btn-primary" onclick="searchRecords()">
                <i class="fas fa-search"></i> Tìm kiếm
            </button>
            <button class="btn btn-secondary" onclick="clearFilters()">
                <i class="fas fa-times"></i> Xóa bộ lọc
            </button>
        </div>

        <!-- Records Table -->
        <div class="records-table">
            <div class="table-header">
                <h3><i class="fas fa-file-medical"></i> Danh sách hồ sơ bệnh án</h3>
                <button class="btn btn-success" onclick="openAddModal()">
                    <i class="fas fa-plus"></i> Thêm hồ sơ mới
                </button>
            </div>
            <div class="table-container">
                <table id="records-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Tên bệnh nhân</th>
                            <th>Số điện thoại</th>
                            <th>Ngày khám</th>
                            <th>Lý do khám</th>
                            <th>Bác sĩ</th>
                            <th>Trạng thái</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="records-tbody">
                        <!-- Records will be loaded here -->
                    </tbody>
                </table>
            </div>
            <div class="no-records" id="no-records" style="display: none;">
                <i class="fas fa-file-medical" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                <p>Không có hồ sơ nào</p>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination" style="display: none;">
            <button onclick="changePage(-1)" id="prev-page" disabled>
                <i class="fas fa-chevron-left"></i> Trước
            </button>
            <span id="page-info">Trang 1 / 1</span>
            <button onclick="changePage(1)" id="next-page" disabled>
                Sau <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </main>

    <!-- Add/Edit Modal -->
    <div id="record-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <h3 id="modal-title">Thêm hồ sơ bệnh án</h3>
            <form id="record-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="patient-name">Tên bệnh nhân *</label>
                        <input type="text" id="patient-name" required>
                    </div>
                    <div class="form-group">
                        <label for="patient-phone">Số điện thoại *</label>
                        <input type="tel" id="patient-phone" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="appointment-date">Ngày khám *</label>
                        <input type="datetime-local" id="appointment-date" required>
                    </div>
                    <div class="form-group">
                        <label for="doctor-name">Bác sĩ</label>
                        <input type="text" id="doctor-name">
                    </div>
                </div>
                <div class="form-group">
                    <label for="service-type">Lý do khám *</label>
                    <input type="text" id="service-type" required>
                </div>
                <div class="form-group">
                    <label for="status">Trạng thái</label>
                    <select id="status">
                        <option value="pending">Chờ khám</option>
                        <option value="completed">Đã khám</option>
                        <option value="cancelled">Đã hủy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="notes">Ghi chú</label>
                    <textarea id="notes" placeholder="Ghi chú thêm về bệnh nhân"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Hủy</button>
                    <button type="submit" class="btn btn-primary">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal nhập kết quả cận lâm sàng -->
    <div id="clinical-result-modal" class="modal hidden">
        <div class="modal-content" style="max-width:900px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2><i class="fas fa-file-medical"></i> Nhập kết quả cận lâm sàng</h2>
                <button class="close-modal" onclick="closeClinicalResultModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
            </div>
            <div id="clinical-result-content">
                <!-- Content will be loaded dynamically based on service type -->
            </div>
        </div>
    </div>

    <!-- Modal nhập kết quả siêu âm -->
    <div id="ultrasound-result-modal" class="modal hidden">
        <div class="modal-content" style="max-width:900px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2><i class="fas fa-file-medical"></i> Nhập kết quả siêu âm</h2>
                <button class="close-modal" onclick="closeUltrasoundModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
            </div>
            <form id="ultrasound-result-form">
                <input type="hidden" id="ultrasound-appointment-id" />
                <input type="hidden" id="ultrasound-patient-id" />
                <input type="hidden" id="ultrasound-result-id" />
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div>
                        <label for="ultrasound-exam-date">Ngày siêu âm *</label>
                        <input type="datetime-local" id="ultrasound-exam-date" required />
                    </div>
                    <div>
                        <label for="ultrasound-gestational-age">Tuổi thai (tuần)</label>
                        <input type="number" id="ultrasound-gestational-age" step="0.1" min="0" max="42" />
                    </div>
                </div>

                <h3 style="margin:20px 0 10px 0; color:#2196F3;">Chỉ số thai nhi</h3>
                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px; margin-bottom:15px;">
                    <div>
                        <label for="ultrasound-bpd">BPD (mm)</label>
                        <input type="number" id="ultrasound-bpd" step="0.1" />
                    </div>
                    <div>
                        <label for="ultrasound-hc">HC (mm)</label>
                        <input type="number" id="ultrasound-hc" step="0.1" />
                    </div>
                    <div>
                        <label for="ultrasound-ac">AC (mm)</label>
                        <input type="number" id="ultrasound-ac" step="0.1" />
                    </div>
                    <div>
                        <label for="ultrasound-fl">FL (mm)</label>
                        <input type="number" id="ultrasound-fl" step="0.1" />
                    </div>
                </div>

                <h3 style="margin:20px 0 10px 0; color:#2196F3;">Chỉ số Doppler</h3>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:15px;">
                    <div>
                        <label for="ultrasound-ri-umbilical">RI động mạch rốn</label>
                        <input type="number" id="ultrasound-ri-umbilical" step="0.01" min="0" max="1" />
                    </div>
                    <div>
                        <label for="ultrasound-sd-ratio">S/D ratio</label>
                        <input type="number" id="ultrasound-sd-ratio" step="0.1" />
                    </div>
                    <div>
                        <label for="ultrasound-mca-pi">MCA PI</label>
                        <input type="number" id="ultrasound-mca-pi" step="0.01" />
                    </div>
                </div>

                <h3 style="margin:20px 0 10px 0; color:#2196F3;">Thông tin khác</h3>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:15px;">
                    <div>
                        <label for="ultrasound-cervical-length">Chiều dài cổ tử cung (mm)</label>
                        <input type="number" id="ultrasound-cervical-length" step="0.1" />
                    </div>
                    <div>
                        <label for="ultrasound-afi">AFI (cm)</label>
                        <input type="number" id="ultrasound-afi" step="0.1" />
                    </div>
                    <div>
                        <label for="ultrasound-estimated-weight">Cân nặng ước tính (g)</label>
                        <input type="number" id="ultrasound-estimated-weight" step="1" />
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div>
                        <label for="ultrasound-fetal-position">Ngôi thai</label>
                        <select id="ultrasound-fetal-position">
                            <option value="">-- Chọn --</option>
                            <option value="Ngôi đầu">Ngôi đầu</option>
                            <option value="Ngôi mông">Ngôi mông</option>
                            <option value="Ngôi ngang">Ngôi ngang</option>
                        </select>
                    </div>
                    <div>
                        <label for="ultrasound-placenta-position">Vị trí nhau</label>
                        <input type="text" id="ultrasound-placenta-position" />
                    </div>
                </div>

                <div style="margin-bottom:15px;">
                    <label for="ultrasound-amniotic-fluid">Nước ối</label>
                    <select id="ultrasound-amniotic-fluid">
                        <option value="">-- Chọn --</option>
                        <option value="Bình thường">Bình thường</option>
                        <option value="Dư ối">Dư ối</option>
                        <option value="Thiếu ối">Thiếu ối</option>
                        <option value="Đa ối">Đa ối</option>
                    </select>
                </div>

                <div style="margin-bottom:15px;">
                    <label for="ultrasound-findings">Nhận xét / Phát hiện</label>
                    <textarea id="ultrasound-findings" rows="4" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;"></textarea>
                </div>

                <div style="margin-bottom:20px;">
                    <label for="ultrasound-recommendations">Khuyến nghị</label>
                    <textarea id="ultrasound-recommendations" rows="3" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeUltrasoundModal()">Hủy</button>
                    <button type="button" class="btn btn-success" onclick="printUltrasoundResult()" id="print-ultrasound-btn" style="display:none;">
                        <i class="fas fa-print"></i> In kết quả
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Lưu kết quả
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Clinical Results Modal -->
    <div id="clinical-results-modal" class="modal">
        <div class="modal-content clinical-results-modal">
            <div class="clinical-results-header">
                <div>
                    <h3 style="margin:0;">Kết quả phiên khám</h3>
                    <div class="clinical-results-meta">
                        <div><strong>Bệnh nhân:</strong> <span id="clinical-result-patient"></span></div>
                        <div><strong>Dịch vụ:</strong> <span id="clinical-result-service"></span></div>
                        <div><strong>Trạng thái:</strong> <span id="clinical-result-status"></span></div>
                    </div>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button class="btn btn-secondary" onclick="refreshClinicalResults()">Tải lại</button>
                    <button class="close-modal-btn" onclick="closeClinicalResultsModal()">&times;</button>
                </div>
            </div>
            <div id="clinical-result-message" class="empty-state" style="display:none;"></div>
            <div style="display:flex; gap:20px; margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:15px;">
                <button class="btn btn-primary" onclick="showServicesSection()" id="btn-show-services">
                    <i class="fas fa-list"></i> Dịch vụ đã chỉ định
                </button>
                <button class="btn btn-outline" onclick="showResultsSection()" id="btn-show-results">
                    <i class="fas fa-file-medical"></i> Kết quả đã có
                </button>
                <button class="btn btn-outline" onclick="showExaminationFormSection()" id="btn-show-examination-form">
                    <i class="fas fa-file-alt"></i> Phiếu khám
                </button>
            </div>
            <div id="services-section" style="display:none;">
                <h4 style="margin-bottom:15px;">Danh sách dịch vụ cận lâm sàng đã chỉ định</h4>
                <div id="clinical-services-list" style="max-height:400px; overflow-y:auto;">
                    <div class="empty-state">Đang tải danh sách dịch vụ...</div>
                </div>
            </div>
            <div id="results-section" class="clinical-results-layout" style="flex:1; overflow:hidden; display:none;">
                <div class="clinical-results-list" id="clinical-results-container"></div>
                <div class="clinical-results-editor-wrapper">
                    <div id="clinical-result-editor-empty" class="empty-state">
                        Chọn một kết quả để xem chi tiết và chỉnh sửa.
                    </div>
                    <div id="clinical-result-editor" class="hidden">
                        <h4 style="margin-top:0;">Sửa kết quả</h4>
                        <form id="clinical-result-edit-form">
                            <div class="form-group">
                                <label>Dịch vụ</label>
                                <input type="text" id="edit-service-name" readonly>
                            </div>
                            <div class="form-group">
                                <label for="edit-exam-date">Ngày thực hiện</label>
                                <input type="datetime-local" id="edit-exam-date">
                            </div>
                            <div class="form-group">
                                <label for="edit-result-text">Kết quả</label>
                                <textarea id="edit-result-text" rows="4" placeholder="Nhập kết quả cận lâm sàng..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="edit-notes">Ghi chú</label>
                                <textarea id="edit-notes" rows="3" placeholder="Ghi chú thêm..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Trường tùy chỉnh</label>
                                <div id="dynamic-field-list" style="max-height:220px; overflow-y:auto; border:1px solid #eee; padding:10px; border-radius:6px;"></div>
                            </div>
                            <div class="form-group">
                                <label>File PDF</label>
                                <div id="clinical-result-pdf-area" class="result-summary" style="font-size:0.9rem;"></div>
                            </div>
                            <div style="display:flex; gap:10px; justify-content:flex-end;">
                                <button type="button" class="btn btn-secondary" onclick="cancelClinicalResultEdit()">Hủy</button>
                                <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div id="examination-form-section" style="display:none; max-height:500px; overflow-y:auto; padding:20px; background:#f9f9f9; border-radius:8px;">
                <h4 style="margin-top:0; margin-bottom:20px; color:#2196F3;">PHIẾU KHÁM BỆNH</h4>
                <div id="examination-form-content">
                    <div class="empty-state">Đang tải phiếu khám...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let records = [];
        let currentPage = 1;
        let totalPages = 1;
        let currentEditId = null;
        let currentResultsRecord = null;
        let clinicalResults = [];
        let editingResultId = null;
        let clinicalServices = [];
        let uploadedPdfFile = null;
        let uploadedPdfUrl = null;

        function openMedicalRecord(type) {
            const routes = {
                'san': 'obstetric-records.html',
                'phu-khoa': 'gynecology-records.html'
            };
            const url = routes[type] || '#';
            if (url === '#') {
                alert('Chức năng đang được phát triển.');
                return;
            }
            window.open(url, '_blank');
        }

        // Load records from API
        async function loadRecords() {
            try {
                const response = await fetch('/api/patient-records');
                if (response.ok) {
                    records = await response.json();
                    renderRecords();
                } else {
                    console.error('Lỗi tải danh sách hồ sơ:', response.status);
                }
            } catch (error) {
                console.error('Lỗi tải danh sách hồ sơ:', error);
            }
        }

        // Render records table
        function renderRecords() {
            const tbody = document.getElementById('records-tbody');
            const noRecords = document.getElementById('no-records');
            
            if (records.length === 0) {
                tbody.innerHTML = '';
                noRecords.style.display = 'block';
                return;
            }

            noRecords.style.display = 'none';
            tbody.innerHTML = records.map((record, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${record.patient_name}</td>
                    <td>${record.patient_phone}</td>
                    <td>${formatDateTime(record.appointment_date)}</td>
                    <td>${record.service_type}</td>
                    <td>${record.doctor_name || 'Chưa xác định'}</td>
                    <td><span class="status-badge status-${record.status}">${getStatusText(record.status)}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-small" onclick="viewRecord(${record.id})" title="Kết quả phiên khám">
                                <i class="fas fa-folder"></i>
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="editRecord(${record.id})" title="Sửa">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteRecord(${record.id})" title="Xóa">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Format date time
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('vi-VN');
        }

        // Get status text
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Chờ khám',
                'completed': 'Đã khám',
                'cancelled': 'Đã hủy'
            };
            return statusMap[status] || status;
        }

        // Search records
        function searchRecords() {
            const name = document.getElementById('search-name').value;
            const phone = document.getElementById('search-phone').value;
            const dateFrom = document.getElementById('search-date-from').value;
            const dateTo = document.getElementById('search-date-to').value;
            const status = document.getElementById('filter-status').value;

            // Filter records based on search criteria
            let filteredRecords = records.filter(record => {
                const matchesName = !name || record.patient_name.toLowerCase().includes(name.toLowerCase());
                const matchesPhone = !phone || record.patient_phone.includes(phone);
                const matchesStatus = !status || record.status === status;
                
                let matchesDate = true;
                if (dateFrom || dateTo) {
                    const recordDate = new Date(record.appointment_date);
                    if (dateFrom) {
                        const fromDate = new Date(dateFrom);
                        matchesDate = matchesDate && recordDate >= fromDate;
                    }
                    if (dateTo) {
                        const toDate = new Date(dateTo);
                        toDate.setHours(23, 59, 59, 999);
                        matchesDate = matchesDate && recordDate <= toDate;
                    }
                }

                return matchesName && matchesPhone && matchesStatus && matchesDate;
            });

            // Update display
            const tbody = document.getElementById('records-tbody');
            const noRecords = document.getElementById('no-records');
            
            if (filteredRecords.length === 0) {
                tbody.innerHTML = '';
                noRecords.style.display = 'block';
            } else {
                noRecords.style.display = 'none';
                tbody.innerHTML = filteredRecords.map((record, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${record.patient_name}</td>
                        <td>${record.patient_phone}</td>
                        <td>${formatDateTime(record.appointment_date)}</td>
                        <td>${record.service_type}</td>
                        <td>${record.doctor_name || 'Chưa xác định'}</td>
                        <td><span class="status-badge status-${record.status}">${getStatusText(record.status)}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-small" onclick="viewRecord(${record.id})" title="Xem kết quả cận lâm sàng">
                                    <i class="fas fa-vials"></i>
                                </button>
                                <button class="btn btn-secondary btn-small" onclick="editRecord(${record.id})" title="Sửa">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteRecord(${record.id})" title="Xóa">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('search-name').value = '';
            document.getElementById('search-phone').value = '';
            document.getElementById('search-date-from').value = '';
            document.getElementById('search-date-to').value = '';
            document.getElementById('filter-status').value = '';
            renderRecords();
        }

        // Open add modal
        function openAddModal() {
            currentEditId = null;
            document.getElementById('modal-title').textContent = 'Thêm hồ sơ bệnh án';
            document.getElementById('record-form').reset();
            document.getElementById('record-modal').style.display = 'flex';
        }

        // Edit record
        function editRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;

            currentEditId = id;
            document.getElementById('modal-title').textContent = 'Sửa hồ sơ bệnh án';
            document.getElementById('patient-name').value = record.patient_name;
            document.getElementById('patient-phone').value = record.patient_phone;
            document.getElementById('appointment-date').value = record.appointment_date.replace(' ', 'T');
            document.getElementById('doctor-name').value = record.doctor_name || '';
            document.getElementById('service-type').value = record.service_type;
            document.getElementById('status').value = record.status;
            document.getElementById('notes').value = record.notes || '';
            document.getElementById('record-modal').style.display = 'flex';
        }

        // View record clinical results
        async function viewRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;
            await openClinicalResultsModal(record);
        }

        // Delete record
        async function deleteRecord(id) {
            if (!confirm('Bạn có chắc muốn xóa hồ sơ này?')) return;

            try {
                const response = await fetch(`/api/patient-records/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadRecords();
                    alert('Đã xóa hồ sơ thành công!');
                } else {
                    const result = await response.json();
                    alert('Lỗi xóa hồ sơ: ' + result.message);
                }
            } catch (error) {
                console.error('Lỗi xóa hồ sơ:', error);
                alert('Lỗi xóa hồ sơ!');
            }
        }

        async function openClinicalResultsModal(record) {
            currentResultsRecord = record;
            clinicalResults = [];
            clinicalServices = [];
            editingResultId = null;

            document.getElementById('clinical-result-patient').textContent = `${record.patient_name} (${record.patient_phone})`;
            document.getElementById('clinical-result-service').textContent = record.service_type || 'Chưa xác định';
            document.getElementById('clinical-result-status').textContent = getStatusText(record.status);
            document.getElementById('clinical-result-message').style.display = 'none';
            document.getElementById('clinical-results-container').innerHTML = '';
            showClinicalResultEditor(false);

            document.getElementById('clinical-results-modal').style.display = 'flex';
            
            // Show services section by default
            showServicesSection();
            
            // Load both services and results
            await Promise.all([
                loadClinicalServicesForRecord(record),
                loadClinicalResultsForRecord(record.id)
            ]);
        }
        
        function showServicesSection() {
            document.getElementById('services-section').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('examination-form-section').style.display = 'none';
            document.getElementById('btn-show-services').classList.add('btn-primary');
            document.getElementById('btn-show-services').classList.remove('btn-outline');
            document.getElementById('btn-show-results').classList.remove('btn-primary');
            document.getElementById('btn-show-results').classList.add('btn-outline');
            document.getElementById('btn-show-examination-form').classList.remove('btn-primary');
            document.getElementById('btn-show-examination-form').classList.add('btn-outline');
        }
        
        function showResultsSection() {
            document.getElementById('services-section').style.display = 'none';
            document.getElementById('results-section').style.display = 'flex';
            document.getElementById('examination-form-section').style.display = 'none';
            document.getElementById('btn-show-services').classList.remove('btn-primary');
            document.getElementById('btn-show-services').classList.add('btn-outline');
            document.getElementById('btn-show-results').classList.add('btn-primary');
            document.getElementById('btn-show-results').classList.remove('btn-outline');
            document.getElementById('btn-show-examination-form').classList.remove('btn-primary');
            document.getElementById('btn-show-examination-form').classList.add('btn-outline');
        }

        async function showExaminationFormSection() {
            document.getElementById('services-section').style.display = 'none';
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('examination-form-section').style.display = 'block';
            document.getElementById('btn-show-services').classList.remove('btn-primary');
            document.getElementById('btn-show-services').classList.add('btn-outline');
            document.getElementById('btn-show-results').classList.remove('btn-primary');
            document.getElementById('btn-show-results').classList.add('btn-outline');
            document.getElementById('btn-show-examination-form').classList.add('btn-primary');
            document.getElementById('btn-show-examination-form').classList.remove('btn-outline');
            
            await loadExaminationForm();
        }

        async function loadExaminationForm() {
            const contentDiv = document.getElementById('examination-form-content');
            if (!currentResultsRecord || !currentResultsRecord.appointment_id) {
                contentDiv.innerHTML = `
                    <div class="empty-state">
                        Hồ sơ này chưa liên kết với lịch hẹn. Không thể tải phiếu khám.
                    </div>
                `;
                return;
            }

            try {
                contentDiv.innerHTML = '<div class="empty-state">Đang tải phiếu khám...</div>';
                
                // Load appointment full info (includes patient, appointment, and medical record data)
                const fullInfoResponse = await fetch(`/api/appointments/${currentResultsRecord.appointment_id}/full-info`);
                let appointment = null;
                let patientName = currentResultsRecord.patient_name || 'Chưa có';
                let patientPhone = currentResultsRecord.patient_phone || 'Chưa có';
                let patientDob = 'Chưa có';
                let patientAddress = 'Chưa có';
                let appointmentDate = 'Chưa có';
                let doctorName = currentResultsRecord.doctor_name || 'Chưa có';
                let serviceType = currentResultsRecord.service_type || 'Chưa có';
                let diagnosis = 'Chưa có';
                let prescription = 'Chưa có';
                let notes = currentResultsRecord.notes || 'Chưa có';

                if (fullInfoResponse.ok) {
                    appointment = await fullInfoResponse.json();
                    // Use data from full-info endpoint
                    patientName = appointment.patient_name || patientName;
                    patientPhone = appointment.patient_phone || patientPhone;
                    patientDob = appointment.patient_dob ? new Date(appointment.patient_dob).toLocaleDateString('vi-VN') : 'Chưa có';
                    patientAddress = appointment.patient_address || 'Chưa có';
                    appointmentDate = appointment.appointment_date ? new Date(appointment.appointment_date).toLocaleString('vi-VN') : 'Chưa có';
                    doctorName = appointment.doctor_name || doctorName;
                    serviceType = appointment.service_type || serviceType;
                    diagnosis = appointment.diagnosis || 'Chưa có';
                    prescription = appointment.prescription || 'Chưa có';
                    notes = appointment.notes || notes;
                } else {
                    // Fallback: Load appointment details separately
                    const appointmentResponse = await fetch(`/api/appointments/${currentResultsRecord.appointment_id}`);
                    if (appointmentResponse.ok) {
                        appointment = await appointmentResponse.json();
                        appointmentDate = appointment.appointment_date ? new Date(appointment.appointment_date).toLocaleString('vi-VN') : 'Chưa có';
                        doctorName = appointment.doctor_name || doctorName;
                        serviceType = appointment.service_type || serviceType;
                    }
                }


                // Calculate age from DOB
                let age = 'Chưa có';
                if (appointment && appointment.patient_dob) {
                    const dob = new Date(appointment.patient_dob);
                    const today = new Date();
                    age = today.getFullYear() - dob.getFullYear();
                    const monthDiff = today.getMonth() - dob.getMonth();
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                        age--;
                    }
                }

                // Render examination form
                contentDiv.innerHTML = `
                    <div style="background:white; padding:24px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                        <div style="border-bottom:2px solid #2196F3; padding-bottom:12px; margin-bottom:24px;">
                            <h3 style="margin:0; color:#2196F3; text-align:center;">PHIẾU KHÁM BỆNH</h3>
                        </div>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
                            <div>
                                <label style="font-weight:bold; color:#555; display:block; margin-bottom:4px;">Họ và tên:</label>
                                <div style="padding:8px; background:#f5f5f5; border-radius:4px; min-height:20px;">${patientName}</div>
                            </div>
                            <div>
                                <label style="font-weight:bold; color:#555; display:block; margin-bottom:4px;">Tuổi:</label>
                                <div style="padding:8px; background:#f5f5f5; border-radius:4px; min-height:20px;">${age}</div>
                            </div>
                            <div>
                                <label style="font-weight:bold; color:#555; display:block; margin-bottom:4px;">Số điện thoại:</label>
                                <div style="padding:8px; background:#f5f5f5; border-radius:4px; min-height:20px;">${patientPhone}</div>
                            </div>
                            <div>
                                <label style="font-weight:bold; color:#555; display:block; margin-bottom:4px;">Ngày sinh:</label>
                                <div style="padding:8px; background:#f5f5f5; border-radius:4px; min-height:20px;">${patientDob}</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="font-weight:bold; color:#555; display:block; margin-bottom:4px;">Địa chỉ:</label>
                            <div style="padding:8px; background:#f5f5f5; border-radius:4px; min-height:20px;">${patientAddress}</div>
                        </div>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
                            <div>
                                <label style="font-weight:bold; color:#555; display:block; margin-bottom:4px;">Ngày khám:</label>
                                <div style="padding:8px; background:#f5f5f5; border-radius:4px; min-height:20px;">${appointmentDate}</div>
                            </div>
                            <div>
                                <label style="font-weight:bold; color:#555; display:block; margin-bottom:4px;">Bác sĩ khám:</label>
                                <div style="padding:8px; background:#f5f5f5; border-radius:4px; min-height:20px;">${doctorName}</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="font-weight:bold; color:#555; display:block; margin-bottom:4px;">Lý do khám:</label>
                            <div style="padding:8px; background:#f5f5f5; border-radius:4px; min-height:20px;">${serviceType}</div>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="font-weight:bold; color:#555; display:block; margin-bottom:4px;">Chẩn đoán:</label>
                            <div style="padding:12px; background:#fff3cd; border-left:4px solid #ffc107; border-radius:4px; min-height:40px; white-space:pre-wrap;">${diagnosis}</div>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="font-weight:bold; color:#555; display:block; margin-bottom:4px;">Đơn thuốc / Điều trị:</label>
                            <div style="padding:12px; background:#d1ecf1; border-left:4px solid #17a2b8; border-radius:4px; min-height:60px; white-space:pre-wrap;">${prescription}</div>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="font-weight:bold; color:#555; display:block; margin-bottom:4px;">Ghi chú:</label>
                            <div style="padding:12px; background:#f5f5f5; border-radius:4px; min-height:40px; white-space:pre-wrap;">${notes}</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Lỗi tải phiếu khám:', error);
                contentDiv.innerHTML = `
                    <div class="empty-state">
                        Lỗi tải phiếu khám: ${error.message}
                    </div>
                `;
            }
        }
        
        async function loadClinicalServicesForRecord(record) {
            try {
                if (!record.appointment_id) {
                    document.getElementById('clinical-services-list').innerHTML = `
                        <div class="empty-state">
                            Hồ sơ này chưa liên kết với lịch hẹn. Không thể tải danh sách dịch vụ.
                        </div>
                    `;
                    return;
                }
                
                const response = await fetch(`/api/appointments/${record.appointment_id}/clinical-services`);
                if (!response.ok) {
                    throw new Error('Không thể tải danh sách dịch vụ');
                }
                
                clinicalServices = await response.json();
                renderClinicalServicesList();
            } catch (error) {
                console.error('Lỗi tải danh sách dịch vụ:', error);
                document.getElementById('clinical-services-list').innerHTML = `
                    <div class="empty-state">
                        Lỗi tải danh sách dịch vụ: ${error.message}
                    </div>
                `;
            }
        }
        
        function renderClinicalServicesList() {
            const container = document.getElementById('clinical-services-list');
            
            if (!clinicalServices || clinicalServices.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        Chưa có dịch vụ cận lâm sàng nào được chỉ định cho bệnh nhân này.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = clinicalServices.map(s => {
                const isUltrasound = (s.service_group && s.service_group.toLowerCase().includes('siêu âm')) || 
                                     (s.name && s.name.toLowerCase().includes('siêu âm'));
                const serviceGroupLower = (s.service_group || '').toLowerCase().trim();
                const isOtherService = serviceGroupLower === 'dịch vụ khác' || 
                                      serviceGroupLower === 'các dịch vụ khác' ||
                                      (serviceGroupLower.includes('dịch vụ khác') && serviceGroupLower.length <= 20);
                const showResultBtn = !isOtherService;
                
                // Check if result already exists
                const hasResult = clinicalResults.some(r => r.service_name === s.name);
                
                return `
                    <div class="service-item" style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px; border-bottom:1px solid #eee; background:${hasResult ? '#f0f8ff' : '#fff'};">
                        <div style="display:flex; align-items:center; gap:8px; flex:1;">
                            <div class="service-info">
                                <h4 style="margin:0; font-size:1rem;">${s.name}</h4>
                                ${s.description ? `<p style="margin:4px 0 0 0; font-size:0.9rem; color:#666;">${s.description}</p>` : ''}
                                ${s.service_group ? `<small style="color:#999;">Nhóm: ${s.service_group}</small>` : ''}
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            ${hasResult ? `<span style="color:#28a745; font-size:0.9rem;"><i class="fas fa-check-circle"></i> Đã có kết quả</span>` : ''}
                            ${showResultBtn ? `
                            <button class="btn btn-primary btn-small" onclick="openClinicalResultModalForService(${currentResultsRecord.appointment_id}, '${s.name.replace(/'/g, "\\'")}', ${isUltrasound})" title="Nhập kết quả">
                                <i class="fas fa-file-medical"></i> ${hasResult ? 'Sửa kết quả' : 'Nhập kết quả'}
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadClinicalResultsForRecord(recordId) {
            try {
                const response = await fetch(`/api/patient-records/${recordId}/clinical-results`);
                if (!response.ok) {
                    const err = await response.json().catch(() => ({ message: 'Không thể tải dữ liệu' }));
                    throw new Error(err.message || 'Không thể tải dữ liệu');
                }
                clinicalResults = await response.json();
                renderClinicalResultsList();
                // Re-render services list to update "has result" status
                if (clinicalServices.length > 0) {
                    renderClinicalServicesList();
                }
            } catch (error) {
                console.error('Lỗi tải kết quả:', error);
                const msg = document.getElementById('clinical-result-message');
                msg.textContent = 'Lỗi tải kết quả: ' + error.message;
                msg.style.display = 'block';
            }
        }

        function slugifyGroupName(name, index) {
            return (`${name || 'group'}-${index}`).normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-zA-Z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '')
                .toLowerCase();
        }

        function renderClinicalResultsList() {
            const container = document.getElementById('clinical-results-container');
            if (!clinicalResults.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        Chưa có kết quả cận lâm sàng cho hồ sơ này.
                    </div>
                `;
                return;
            }

            const grouped = {};
            clinicalResults.forEach(result => {
                const groupName = result.service_group || 'Các dịch vụ khác';
                if (!grouped[groupName]) grouped[groupName] = [];
                grouped[groupName].push(result);
            });

            const sortedGroupNames = Object.keys(grouped).sort((a, b) =>
                a.localeCompare(b, 'vi', { sensitivity: 'base' })
            );

            container.innerHTML = sortedGroupNames.map((groupName, idx) => {
                const entries = grouped[groupName].sort((a, b) => {
                    const dateA = new Date(a.exam_date || 0);
                    const dateB = new Date(b.exam_date || 0);
                    return dateB - dateA;
                });
                const slug = slugifyGroupName(groupName, idx);
                const cards = entries.map(result => `
                    <div class="clinical-result-card" data-result-id="${result.id}" onclick="toggleResultDetails(event, ${result.id})">
                        <div class="card-header">
                            <h4>${result.service_name || 'Dịch vụ chưa xác định'}</h4>
                            <span>${formatDateTime(result.exam_date)}</span>
                        </div>
                        <div class="result-details" id="result-details-${result.id}">
                            <div class="result-summary">${getResultSummary(result)}</div>
                            <div class="clinical-result-actions">
                                ${result.pdf_file_path ? `<button class="btn btn-outline btn-small" type="button" onclick="event.stopPropagation(); openResultPdf(${result.id})"><i class="fas fa-file-pdf"></i> Xem PDF</button>` : ''}
                                <button class="btn btn-primary btn-small" type="button" onclick="event.stopPropagation(); startEditClinicalResult(${result.id})"><i class="fas fa-edit"></i> Sửa</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                return `
                    <div class="clinical-group">
                        <div class="group-header" onclick="toggleGroup('${slug}')">
                            <h4>${groupName}</h4>
                            <span>${entries.length} dịch vụ <i class="fas fa-chevron-down" id="group-icon-${slug}" style="margin-left:8px;"></i></span>
                        </div>
                        <div class="group-content hidden" id="group-content-${slug}">
                            ${cards}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getResultSummary(result) {
            if (result.result_text) {
                return result.result_text.length > 250 ? result.result_text.substring(0, 250) + '...' : result.result_text;
            }
            const fields = result.fields_data || {};
            const entries = Object.entries(fields);
            if (!entries.length) {
                return 'Chưa có ghi chú chi tiết.';
            }
            return entries.map(([key, value]) => `${key}: ${value}`).join('\n');
        }

        function startEditClinicalResult(resultId) {
            const result = clinicalResults.find(r => r.id === resultId);
            if (!result) return;
            editingResultId = resultId;

            document.getElementById('edit-service-name').value = result.service_name || '';
            document.getElementById('edit-exam-date').value = formatDateTimeLocal(result.exam_date);
            document.getElementById('edit-result-text').value = result.result_text || '';
            document.getElementById('edit-notes').value = result.notes || '';
            renderFieldsEditor(result.fields_data || {});

            const pdfArea = document.getElementById('clinical-result-pdf-area');
            if (result.pdf_file_path) {
                pdfArea.innerHTML = `<button class="btn btn-outline btn-small" type="button" onclick="openResultPdf(${result.id})"><i class="fas fa-file-pdf"></i> Xem file PDF</button>`;
            } else {
                pdfArea.textContent = 'Không có file PDF đính kèm.';
            }

            showClinicalResultEditor(true);
        }

        function renderFieldsEditor(fields) {
            const container = document.getElementById('dynamic-field-list');
            const entries = Object.entries(fields);
            if (!entries.length) {
                container.innerHTML = '<p style="margin:0; color:#777;">Không có trường tùy chỉnh.</p>';
                return;
            }
            container.innerHTML = entries.map(([key, value]) => `
                <div class="field-editor-group">
                    <label>${key}</label>
                    <textarea data-field-name="${key}" rows="2">${value || ''}</textarea>
                </div>
            `).join('');
        }

        function cancelClinicalResultEdit() {
            editingResultId = null;
            showClinicalResultEditor(false);
        }

        function showClinicalResultEditor(show) {
            const editor = document.getElementById('clinical-result-editor');
            const placeholder = document.getElementById('clinical-result-editor-empty');
            if (show) {
                editor.classList.remove('hidden');
                placeholder.style.display = 'none';
            } else {
                editor.classList.add('hidden');
                placeholder.style.display = 'block';
            }
        }

        function closeClinicalResultsModal() {
            document.getElementById('clinical-results-modal').style.display = 'none';
            clinicalResults = [];
            editingResultId = null;
            currentResultsRecord = null;
            showClinicalResultEditor(false);
        }

        function openResultPdf(resultId) {
            if (!resultId) return;
            window.open(`/api/clinical-results/pdf/${resultId}`, '_blank');
        }

        function formatDateTimeLocal(value) {
            if (!value) return '';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '';
            const offset = date.getTimezoneOffset();
            const local = new Date(date.getTime() - offset * 60000);
            return local.toISOString().slice(0, 16);
        }

        async function refreshClinicalResults() {
            if (!currentResultsRecord) return;
            await Promise.all([
                loadClinicalServicesForRecord(currentResultsRecord),
                loadClinicalResultsForRecord(currentResultsRecord.id)
            ]);
        }
        
        // Function to open clinical result modal for a service (similar to examination-list.html)
        async function openClinicalResultModalForService(appointmentId, serviceName, isUltrasound) {
            try {
                // Get appointment info
                const appointmentResponse = await fetch(`/api/appointments/${appointmentId}`);
                if (!appointmentResponse.ok) {
                    throw new Error('Không thể lấy thông tin lịch hẹn');
                }
                const appointment = await appointmentResponse.json();
                const patientId = appointment.patient_id;
                
                // If ultrasound, use the existing ultrasound form
                if (isUltrasound) {
                    await openUltrasoundResultModal(appointmentId, serviceName);
                    return;
                }
                
                // For other services, load template and create dynamic form
                const contentDiv = document.getElementById('clinical-result-content');
                contentDiv.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Đang tải mẫu phiếu...</div>';
                
                // Show modal first
                document.getElementById('clinical-result-modal').classList.remove('hidden');
                
                // Try to load template - tự động lấy mẫu phiếu kết quả cận lâm sàng trùng tên dịch vụ
                let template = null;
                try {
                    // Thử tìm mẫu phiếu theo tên dịch vụ chính xác trước
                    let templateResponse = await fetch(`/api/lab-result-templates/by-name?name=${encodeURIComponent(serviceName)}`);
                    if (templateResponse.ok) {
                        template = await templateResponse.json();
                        console.log('Đã tìm thấy mẫu phiếu theo tên chính xác:', template.name);
                    } else {
                        // Nếu không tìm thấy, thử tìm tất cả mẫu phiếu và tìm theo tên gần giống
                        const allTemplatesResponse = await fetch('/api/lab-result-templates');
                        if (allTemplatesResponse.ok) {
                            const allTemplates = await allTemplatesResponse.json();
                            const serviceNameLower = serviceName.toLowerCase().trim();
                            
                            // Tìm mẫu phiếu có tên chứa tên dịch vụ hoặc ngược lại
                            template = allTemplates.find(t => {
                                const templateNameLower = (t.name || '').toLowerCase().trim();
                                return templateNameLower === serviceNameLower ||
                                       templateNameLower.includes(serviceNameLower) ||
                                       serviceNameLower.includes(templateNameLower);
                            });
                            
                            if (template) {
                                console.log('Đã tìm thấy mẫu phiếu theo tên gần giống:', template.name);
                            } else {
                                console.log('Không tìm thấy mẫu phiếu cho dịch vụ:', serviceName);
                            }
                        }
                    }
                } catch (error) {
                    console.log('Lỗi khi tìm mẫu phiếu:', error);
                }
                
                // Create form from template or use default
                if (template && template.content_html) {
                    await createFormFromTemplate(template, appointmentId, patientId, serviceName);
                } else {
                    createDefaultResultForm(appointmentId, patientId, serviceName);
                }
            } catch (error) {
                console.error('Error opening clinical result modal:', error);
                alert('Lỗi khi mở form nhập kết quả: ' + error.message);
            }
        }
        
        async function createFormFromTemplate(template, appointmentId, patientId, serviceName) {
            const contentDiv = document.getElementById('clinical-result-content');
            
            // Parse template HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(template.content_html, 'text/html');
            
            // Extract form fields from template
            const formFields = [];
            doc.querySelectorAll('[data-field]').forEach(el => {
                const fieldName = el.getAttribute('data-field');
                const fieldType = el.tagName.toLowerCase();
                const fieldValue = el.textContent.trim() || el.value || '';
                const isEditable = el.contentEditable === 'true' || fieldType === 'input' || fieldType === 'textarea' || fieldType === 'select';
                
                if (fieldName && isEditable) {
                    formFields.push({
                        name: fieldName,
                        type: fieldType,
                        label: el.previousElementSibling?.textContent.trim() || fieldName,
                        value: fieldValue,
                        element: el
                    });
                }
            });
            
            // Create form HTML
            let formHTML = `
                <form id="clinical-result-form">
                    <input type="hidden" id="clinical-appointment-id" value="${appointmentId}" />
                    <input type="hidden" id="clinical-patient-id" value="${patientId}" />
                    <input type="hidden" id="clinical-service-name" value="${serviceName}" />
                    <input type="hidden" id="clinical-template-id" value="${template.id}" />
                    
                    <div style="margin-bottom:15px;">
                        <label><strong>Dịch vụ:</strong> ${serviceName}</label>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label for="clinical-exam-date">Ngày khám *</label>
                        <input type="datetime-local" id="clinical-exam-date" required style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;" />
                    </div>
                    
                    <div id="template-fields-container" style="display:grid; gap:15px; margin-bottom:20px;">
            `;
            
            // Add fields from template
            formFields.forEach(field => {
                const fieldId = `clinical-field-${field.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
                if (field.type === 'textarea' || (field.element && field.element.tagName.toLowerCase() === 'div' && field.element.contentEditable === 'true')) {
                    formHTML += `
                        <div>
                            <label for="${fieldId}">${field.label}</label>
                            <textarea id="${fieldId}" name="${field.name}" rows="3" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">${field.value}</textarea>
                        </div>
                    `;
                } else if (field.type === 'select' || (field.element && field.element.tagName.toLowerCase() === 'select')) {
                    const options = Array.from(field.element.options || []).map(opt => 
                        `<option value="${opt.value}" ${opt.selected ? 'selected' : ''}>${opt.text}</option>`
                    ).join('');
                    formHTML += `
                        <div>
                            <label for="${fieldId}">${field.label}</label>
                            <select id="${fieldId}" name="${field.name}" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">${options}</select>
                        </div>
                    `;
                } else {
                    formHTML += `
                        <div>
                            <label for="${fieldId}">${field.label}</label>
                            <input type="text" id="${fieldId}" name="${field.name}" value="${field.value}" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;" />
                        </div>
                    `;
                }
            });
            
            formHTML += `
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label>File PDF kết quả</label>
                        <div id="clinical-pdf-upload-area" style="border:2px dashed #ddd; border-radius:8px; padding:15px; text-align:center; background:#f9f9f9;">
                            <input type="file" id="clinical-pdf-file" accept=".pdf" style="display:none;" onchange="handlePdfUpload(event)" />
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('clinical-pdf-file').click()" style="margin-bottom:10px;">
                                <i class="fas fa-upload"></i> Tải lên PDF
                            </button>
                            <div id="clinical-pdf-preview" style="margin-top:10px;"></div>
                        </div>
                    </div>
                    
                    <div class="modal-actions" style="display:flex; gap:10px; justify-content:flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeClinicalResultModal()">Hủy</button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('clinical-pdf-file').click()">
                            <i class="fas fa-file-pdf"></i> Tải lên PDF
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Lưu kết quả
                        </button>
                    </div>
                </form>
            `;
            
            contentDiv.innerHTML = formHTML;
            
            // Attach form submit handler
            document.getElementById('clinical-result-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveClinicalResult(appointmentId, patientId, serviceName, template.id);
            });
            
            // Set default date
            const now = new Date();
            document.getElementById('clinical-exam-date').value = now.toISOString().slice(0, 16);
            
            // Load existing PDF if any
            loadExistingPdf(appointmentId, serviceName);
        }

        function createDefaultResultForm(appointmentId, patientId, serviceName) {
            const contentDiv = document.getElementById('clinical-result-content');
            contentDiv.innerHTML = `
                <form id="clinical-result-form">
                    <input type="hidden" id="clinical-appointment-id" value="${appointmentId}" />
                    <input type="hidden" id="clinical-patient-id" value="${patientId}" />
                    <input type="hidden" id="clinical-service-name" value="${serviceName}" />
                    
                    <div style="margin-bottom:15px;">
                        <label><strong>Dịch vụ:</strong> ${serviceName}</label>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label for="clinical-exam-date">Ngày khám *</label>
                        <input type="datetime-local" id="clinical-exam-date" required style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;" />
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label for="clinical-result-text">Kết quả <span style="color:#999; font-size:0.9em;">(hoặc tải file PDF)</span></label>
                        <textarea id="clinical-result-text" rows="3" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-family:'Times New Roman', Times, serif;" placeholder="Nhập kết quả cận lâm sàng..."></textarea>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label for="clinical-notes">Ghi chú</label>
                        <textarea id="clinical-notes" rows="2" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-family:'Times New Roman', Times, serif;" placeholder="Ghi chú thêm..."></textarea>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label>File PDF kết quả</label>
                        <div id="clinical-pdf-upload-area" style="border:2px dashed #ddd; border-radius:8px; padding:15px; text-align:center; background:#f9f9f9;">
                            <input type="file" id="clinical-pdf-file" accept=".pdf" style="display:none;" onchange="handlePdfUpload(event)" />
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('clinical-pdf-file').click()" style="margin-bottom:10px;">
                                <i class="fas fa-upload"></i> Tải lên PDF
                            </button>
                            <div id="clinical-pdf-preview" style="margin-top:10px;"></div>
                        </div>
                    </div>
                    
                    <div class="modal-actions" style="display:flex; gap:10px; justify-content:flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeClinicalResultModal()">Hủy</button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('clinical-pdf-file').click()">
                            <i class="fas fa-file-pdf"></i> Tải lên PDF
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Lưu kết quả
                        </button>
                    </div>
                </form>
            `;
            
            // Set default date
            const now = new Date();
            document.getElementById('clinical-exam-date').value = now.toISOString().slice(0, 16);
            
            // Attach form submit handler
            document.getElementById('clinical-result-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveClinicalResult(appointmentId, patientId, serviceName);
            });
            
            // Load existing PDF if any
            loadExistingPdf(appointmentId, serviceName);
        }

        function closeClinicalResultModal() {
            document.getElementById('clinical-result-modal').classList.add('hidden');
            uploadedPdfFile = null;
            uploadedPdfUrl = null;
        }

        // Xử lý upload PDF
        async function handlePdfUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type !== 'application/pdf') {
                alert('Vui lòng chọn file PDF!');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) { // 10MB
                alert('File PDF không được vượt quá 10MB!');
                return;
            }
            
            try {
                // Tạo URL để preview
                uploadedPdfFile = file;
                uploadedPdfUrl = URL.createObjectURL(file);
                
                // Hiển thị preview
                const previewDiv = document.getElementById('clinical-pdf-preview');
                previewDiv.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; padding:10px; background:#fff; border-radius:4px; border:1px solid #ddd;">
                        <i class="fas fa-file-pdf" style="font-size:24px; color:#dc3545;"></i>
                        <div style="flex:1;">
                            <div style="font-weight:bold;">${file.name}</div>
                            <div style="font-size:0.9rem; color:#666;">${(file.size / 1024).toFixed(2)} KB</div>
                        </div>
                        <button type="button" class="btn btn-danger btn-small" onclick="removePdfUpload()" style="padding:6px 12px; cursor:pointer;">
                            <i class="fas fa-times"></i> Xóa
                        </button>
                    </div>
                `;
            } catch (error) {
                console.error('Error handling PDF upload:', error);
                alert('Lỗi khi xử lý file PDF: ' + error.message);
            }
        }

        // Xóa PDF đã upload
        function removePdfUpload() {
            if (uploadedPdfUrl) {
                URL.revokeObjectURL(uploadedPdfUrl);
            }
            uploadedPdfFile = null;
            uploadedPdfUrl = null;
            document.getElementById('clinical-pdf-file').value = '';
            document.getElementById('clinical-pdf-preview').innerHTML = '';
        }

        // Load PDF đã có sẵn
        async function loadExistingPdf(appointmentId, serviceName) {
            try {
                const response = await fetch(`/api/clinical-results?appointment_id=${appointmentId}&service_name=${encodeURIComponent(serviceName)}`);
                if (response.ok) {
                    const results = await response.json();
                    if (results && results.length > 0) {
                        const result = results[0];
                        if (result.pdf_file_path) {
                            // Hiển thị PDF đã có
                            const previewDiv = document.getElementById('clinical-pdf-preview');
                            const fileName = result.pdf_file_path.split('/').pop() || 'File PDF đã lưu';
                            const pdfViewUrl = `/api/clinical-results/pdf/${result.id}`;
                            previewDiv.innerHTML = `
                                <div style="display:flex; align-items:center; gap:10px; padding:10px; background:#fff; border-radius:4px; border:1px solid #ddd;">
                                    <i class="fas fa-file-pdf" style="font-size:24px; color:#dc3545;"></i>
                                    <div style="flex:1;">
                                        <div style="font-weight:bold;">${fileName}</div>
                                        <div style="font-size:0.9rem; color:#666;">Click để xem</div>
                                    </div>
                                    <a href="${pdfViewUrl}" target="_blank" class="btn btn-secondary btn-small" style="padding:6px 12px;">
                                        <i class="fas fa-eye"></i> Xem
                                    </a>
                                </div>
                            `;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading existing PDF:', error);
            }
        }

        async function saveClinicalResult(appointmentId, patientId, serviceName, templateId) {
            try {
                const examDate = document.getElementById('clinical-exam-date').value;
                const form = document.getElementById('clinical-result-form');
                
                // Kiểm tra: phải có nội dung trong ô kết quả HOẶC có file PDF
                let hasResultText = false;
                let hasFields = false;
                
                // Kiểm tra ô kết quả (default form)
                const resultTextEl = document.getElementById('clinical-result-text');
                if (resultTextEl && resultTextEl.value.trim()) {
                    hasResultText = true;
                }
                
                // Kiểm tra các field từ template
                form.querySelectorAll('input[name], textarea[name], select[name]').forEach(el => {
                    if (el.id !== 'clinical-appointment-id' && el.id !== 'clinical-patient-id' && el.id !== 'clinical-service-name' && el.id !== 'clinical-template-id') {
                        if (el.value && el.value.trim()) {
                            hasFields = true;
                        }
                    }
                });
                
                // Kiểm tra file PDF
                const hasPdf = uploadedPdfFile !== null;
                
                // Nếu không có nội dung và không có PDF, không cho phép lưu
                if (!hasResultText && !hasFields && !hasPdf) {
                    alert('Vui lòng nhập kết quả hoặc tải lên file PDF!');
                    return;
                }
                
                // Collect all field values
                const resultData = {
                    appointment_id: appointmentId,
                    patient_id: parseInt(patientId),
                    service_name: serviceName,
                    exam_date: examDate,
                    template_id: templateId || null,
                    fields: {}
                };
                
                // Get all input/textarea/select values
                form.querySelectorAll('input[name], textarea[name], select[name]').forEach(el => {
                    if (el.id !== 'clinical-appointment-id' && el.id !== 'clinical-patient-id' && el.id !== 'clinical-service-name' && el.id !== 'clinical-template-id') {
                        resultData.fields[el.name] = el.value;
                    }
                });
                
                // For default form
                if (document.getElementById('clinical-result-text')) {
                    resultData.result_text = document.getElementById('clinical-result-text').value || '';
                    resultData.notes = document.getElementById('clinical-notes').value || '';
                }
                
                // Upload PDF if exists
                if (uploadedPdfFile) {
                    const formData = new FormData();
                    formData.append('pdf_file', uploadedPdfFile);
                    formData.append('result_data', JSON.stringify(resultData));
                    
                    const response = await fetch('/api/clinical-results/with-pdf', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        alert('Đã lưu kết quả và file PDF thành công!');
                        closeClinicalResultModal();
                        // Refresh services and results
                        await refreshClinicalResults();
                        // Clean up
                        if (uploadedPdfUrl) {
                            URL.revokeObjectURL(uploadedPdfUrl);
                        }
                        uploadedPdfFile = null;
                        uploadedPdfUrl = null;
                    } else {
                        const error = await response.json();
                        alert('Lỗi khi lưu kết quả: ' + (error.message || 'Lỗi không xác định'));
                    }
                } else {
                    // Save without PDF
                    const response = await fetch('/api/clinical-results', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(resultData)
                    });
                    
                    if (response.ok) {
                        alert('Đã lưu kết quả thành công!');
                        closeClinicalResultModal();
                        // Refresh services and results
                        await refreshClinicalResults();
                    } else {
                        const error = await response.json();
                        alert('Lỗi khi lưu kết quả: ' + (error.message || 'Lỗi không xác định'));
                    }
                }
            } catch (error) {
                console.error('Error saving clinical result:', error);
                alert('Lỗi khi lưu kết quả: ' + error.message);
            }
        }
        
        // Ultrasound Result Functions (reuse logic from examination-list.html)
        async function openUltrasoundResultModal(appointmentId, serviceName) {
            try {
                const appointmentResponse = await fetch(`/api/appointments/${appointmentId}`);
                if (!appointmentResponse.ok) {
                    throw new Error('Không thể lấy thông tin lịch hẹn');
                }
                const appointment = await appointmentResponse.json();
                const patientId = appointment.patient_id;

                document.getElementById('ultrasound-appointment-id').value = appointmentId;
                document.getElementById('ultrasound-patient-id').value = patientId;
                document.getElementById('ultrasound-result-id').value = '';

                const now = new Date();
                const examDateInput = document.getElementById('ultrasound-exam-date');
                examDateInput.value = now.toISOString().slice(0, 16);

                let existingResults = [];
                try {
                    const existingResponse = await fetch(`/api/ultrasound-results?appointment_id=${appointmentId}`);
                    if (existingResponse.ok) {
                        existingResults = await existingResponse.json();
                    }
                } catch (error) {
                    console.warn('Không thể tải kết quả siêu âm hiện có:', error);
                }

                if (existingResults && existingResults.length > 0) {
                    const result = existingResults[0];
                    document.getElementById('ultrasound-result-id').value = result.id;
                    loadUltrasoundResultData(result);
                    document.getElementById('print-ultrasound-btn').style.display = 'inline-block';
                } else {
                    document.getElementById('ultrasound-result-form').reset();
                    document.getElementById('ultrasound-appointment-id').value = appointmentId;
                    document.getElementById('ultrasound-patient-id').value = patientId;
                    document.getElementById('ultrasound-exam-date').value = now.toISOString().slice(0, 16);
                    document.getElementById('print-ultrasound-btn').style.display = 'none';

                    if (serviceName) {
                        await loadUltrasoundTemplateDataToForm(serviceName);
                    }
                }

                document.getElementById('ultrasound-result-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error opening ultrasound modal:', error);
                alert('Lỗi khi mở form nhập kết quả siêu âm: ' + error.message);
            }
        }

        async function loadUltrasoundTemplateDataToForm(serviceName) {
            try {
                let template = null;
                let response = await fetch(`/api/lab-result-templates/by-name?name=${encodeURIComponent(serviceName)}`);
                if (response.ok) {
                    template = await response.json();
                } else {
                    const allTemplatesResponse = await fetch('/api/lab-result-templates');
                    if (allTemplatesResponse.ok) {
                        const allTemplates = await allTemplatesResponse.json();
                        const serviceNameLower = serviceName.toLowerCase().trim();
                        template = allTemplates.find(t => {
                            const templateNameLower = (t.name || '').toLowerCase().trim();
                            return templateNameLower === serviceNameLower ||
                                   templateNameLower.includes(serviceNameLower) ||
                                   serviceNameLower.includes(templateNameLower);
                        });
                    }
                }

                if (!template || !template.content_html) {
                    return;
                }

                const parser = new DOMParser();
                const doc = parser.parseFromString(template.content_html, 'text/html');
                const templateData = {};

                doc.querySelectorAll('[data-field]').forEach(el => {
                    const field = el.getAttribute('data-field');
                    const value = el.textContent.trim();
                    if (value && field) {
                        templateData[field] = value;
                    }
                });
                doc.querySelectorAll('input[data-field], select[data-field], textarea[data-field]').forEach(el => {
                    const field = el.getAttribute('data-field');
                    const value = el.value || el.textContent.trim();
                    if (value && field) {
                        templateData[field] = value;
                    }
                });

                const fieldMapping = {
                    'gestational_age': ['gestational_age', 'tuoi_thai', 'tuổi_thai', 'ga'],
                    'bpd': ['bpd', 'duong_kinh_luong_dinh'],
                    'hc': ['hc', 'chu_vi_dau', 'head_circumference'],
                    'ac': ['ac', 'chu_vi_bung', 'abdominal_circumference'],
                    'fl': ['fl', 'chieu_dai_xuong_dui', 'femur_length'],
                    'estimated_weight': ['estimated_weight', 'can_nang', 'cân_nặng', 'weight'],
                    'fetal_position': ['fetal_position', 'ngoi_thai', 'ngôi_thai'],
                    'placenta_position': ['placenta_position', 'vi_tri_nhau', 'vị_trí_nhau'],
                    'amniotic_fluid': ['amniotic_fluid', 'nuoc_oi', 'nước_ối'],
                    'afi': ['afi'],
                    'cervical_length': ['cervical_length', 'chieu_dai_co_tu_cung'],
                    'ri_umbilical': ['ri_umbilical', 'ri_dong_mach_ron'],
                    'sd_ratio': ['sd_ratio'],
                    'mca_pi': ['mca_pi'],
                    'findings': ['findings', 'nhan_xet', 'nhận_xét', 'ket_qua', 'kết_quả'],
                    'recommendations': ['recommendations', 'khuyen_nghi', 'khuyến_nghị']
                };

                Object.keys(fieldMapping).forEach(formField => {
                    const possibleKeys = fieldMapping[formField];
                    for (const key of possibleKeys) {
                        if (templateData[key]) {
                            const formElement = document.getElementById(`ultrasound-${formField}`);
                            if (formElement) {
                                if (['gestational_age', 'bpd', 'hc', 'ac', 'fl', 'estimated_weight', 'afi', 'cervical_length', 'ri_umbilical', 'sd_ratio', 'mca_pi'].includes(formField)) {
                                    const numValue = parseFloat(templateData[key]);
                                    if (!isNaN(numValue)) {
                                        formElement.value = numValue;
                                        break;
                                    }
                                } else {
                                    formElement.value = templateData[key];
                                    break;
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading template data:', error);
            }
        }

        function loadUltrasoundResultData(result) {
            if (result.exam_date) {
                const examDate = new Date(result.exam_date);
                document.getElementById('ultrasound-exam-date').value = examDate.toISOString().slice(0, 16);
            }
            document.getElementById('ultrasound-gestational-age').value = result.gestational_age || '';
            document.getElementById('ultrasound-bpd').value = result.bpd || '';
            document.getElementById('ultrasound-hc').value = result.hc || '';
            document.getElementById('ultrasound-ac').value = result.ac || '';
            document.getElementById('ultrasound-fl').value = result.fl || '';
            document.getElementById('ultrasound-ri-umbilical').value = result.ri_umbilical || '';
            document.getElementById('ultrasound-sd-ratio').value = result.sd_ratio || '';
            document.getElementById('ultrasound-mca-pi').value = result.mca_pi || '';
            document.getElementById('ultrasound-cervical-length').value = result.cervical_length || '';
            document.getElementById('ultrasound-afi').value = result.afi || '';
            document.getElementById('ultrasound-estimated-weight').value = result.estimated_weight || '';
            document.getElementById('ultrasound-fetal-position').value = result.fetal_position || '';
            document.getElementById('ultrasound-placenta-position').value = result.placenta_position || '';
            document.getElementById('ultrasound-amniotic-fluid').value = result.amniotic_fluid || '';
            document.getElementById('ultrasound-findings').value = result.findings || '';
            document.getElementById('ultrasound-recommendations').value = result.recommendations || '';
        }

        function closeUltrasoundModal() {
            document.getElementById('ultrasound-result-modal').classList.add('hidden');
        }

        document.getElementById('ultrasound-result-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                const appointmentId = document.getElementById('ultrasound-appointment-id').value;
                const patientId = document.getElementById('ultrasound-patient-id').value;
                const resultId = document.getElementById('ultrasound-result-id').value;

                const formData = {
                    patient_id: parseInt(patientId),
                    appointment_id: parseInt(appointmentId),
                    exam_date: document.getElementById('ultrasound-exam-date').value,
                    gestational_age: parseFloat(document.getElementById('ultrasound-gestational-age').value) || null,
                    bpd: parseFloat(document.getElementById('ultrasound-bpd').value) || null,
                    hc: parseFloat(document.getElementById('ultrasound-hc').value) || null,
                    ac: parseFloat(document.getElementById('ultrasound-ac').value) || null,
                    fl: parseFloat(document.getElementById('ultrasound-fl').value) || null,
                    ri_umbilical: parseFloat(document.getElementById('ultrasound-ri-umbilical').value) || null,
                    sd_ratio: parseFloat(document.getElementById('ultrasound-sd-ratio').value) || null,
                    mca_pi: parseFloat(document.getElementById('ultrasound-mca-pi').value) || null,
                    cervical_length: parseFloat(document.getElementById('ultrasound-cervical-length').value) || null,
                    afi: parseFloat(document.getElementById('ultrasound-afi').value) || null,
                    estimated_weight: parseFloat(document.getElementById('ultrasound-estimated-weight').value) || null,
                    fetal_position: document.getElementById('ultrasound-fetal-position').value || null,
                    placenta_position: document.getElementById('ultrasound-placenta-position').value || null,
                    amniotic_fluid: document.getElementById('ultrasound-amniotic-fluid').value || null,
                    findings: document.getElementById('ultrasound-findings').value || null,
                    recommendations: document.getElementById('ultrasound-recommendations').value || null,
                    analysis_source: 'manual_input'
                };

                let response;
                if (resultId) {
                    response = await fetch(`/api/ultrasound-results/${resultId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                } else {
                    response = await fetch('/api/ultrasound-results', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                }

                if (response.ok) {
                    const result = await response.json().catch(() => ({}));
                    if (result && result.id) {
                        document.getElementById('ultrasound-result-id').value = result.id;
                    }
                    document.getElementById('print-ultrasound-btn').style.display = 'inline-block';
                    alert('Đã lưu kết quả siêu âm thành công!');
                    await refreshClinicalResults();
                } else {
                    const error = await response.json().catch(() => ({ message: 'Lỗi không xác định' }));
                    alert('Lỗi khi lưu kết quả: ' + (error.message || 'Lỗi không xác định'));
                }
            } catch (error) {
                console.error('Error saving ultrasound result:', error);
                alert('Lỗi khi lưu kết quả siêu âm: ' + error.message);
            }
        });

        async function printUltrasoundResult() {
            const resultId = document.getElementById('ultrasound-result-id').value;
            const appointmentId = document.getElementById('ultrasound-appointment-id').value;
            if (!resultId) {
                alert('Vui lòng lưu kết quả trước khi in!');
                return;
            }
            try {
                window.open(`/api/print_ultrasound/${appointmentId}?result_id=${resultId}`, '_blank');
            } catch (error) {
                console.error('Error printing ultrasound result:', error);
                alert('Lỗi khi in kết quả: ' + error.message);
            }
        }

        function toggleResultDetails(event, resultId) {
            const card = document.querySelector(`.clinical-result-card[data-result-id="${resultId}"]`);
            if (!card) return;
            const isActive = card.classList.contains('active');
            document.querySelectorAll('.clinical-result-card').forEach(c => c.classList.remove('active'));
            if (!isActive) {
                card.classList.add('active');
            }
        }

        function toggleGroup(slug) {
            const content = document.getElementById(`group-content-${slug}`);
            const icon = document.getElementById(`group-icon-${slug}`);
            if (!content) return;
            const isOpen = !content.classList.contains('hidden');
            if (isOpen) {
                content.classList.add('hidden');
                content.style.display = 'none';
            } else {
                content.classList.remove('hidden');
                content.style.display = 'block';
            }
            if (icon) {
                icon.className = isOpen ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
            }
        }

        async function saveClinicalResultEdit(event) {
            event.preventDefault();
            if (!editingResultId || !currentResultsRecord) {
                alert('Vui lòng chọn kết quả cần chỉnh sửa.');
                return;
            }

            const payload = {};
            const examDateValue = document.getElementById('edit-exam-date').value;
            if (examDateValue) {
                payload.exam_date = examDateValue;
            }
            payload.result_text = document.getElementById('edit-result-text').value || '';
            payload.notes = document.getElementById('edit-notes').value || '';

            const fieldsInputs = document.querySelectorAll('#dynamic-field-list [data-field-name]');
            if (fieldsInputs.length) {
                const fields = {};
                fieldsInputs.forEach(input => {
                    fields[input.dataset.fieldName] = input.value;
                });
                payload.fields = fields;
            }

            try {
                const response = await fetch(`/api/clinical-results/${editingResultId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const err = await response.json().catch(() => ({ message: 'Không thể lưu kết quả' }));
                    throw new Error(err.message || 'Không thể lưu kết quả');
                }
                await loadClinicalResultsForRecord(currentResultsRecord.id);
                alert('Đã cập nhật kết quả thành công!');
                cancelClinicalResultEdit();
            } catch (error) {
                console.error('Lỗi lưu kết quả:', error);
                alert('Lỗi lưu kết quả: ' + error.message);
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('record-modal').style.display = 'none';
        }

        // Handle form submission
        document.getElementById('record-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                patient_name: document.getElementById('patient-name').value,
                patient_phone: document.getElementById('patient-phone').value,
                appointment_date: document.getElementById('appointment-date').value,
                doctor_name: document.getElementById('doctor-name').value,
                service_type: document.getElementById('service-type').value,
                status: document.getElementById('status').value,
                notes: document.getElementById('notes').value
            };

            try {
                let response;
                if (currentEditId) {
                    // Edit existing record
                    response = await fetch(`/api/patient-records/${currentEditId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                } else {
                    // Add new record
                    response = await fetch('/api/patient-records', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                }

                if (response.ok) {
                    await loadRecords();
                    closeModal();
                    alert(currentEditId ? 'Đã cập nhật hồ sơ thành công!' : 'Đã thêm hồ sơ thành công!');
                } else {
                    const result = await response.json();
                    alert('Lỗi: ' + result.message);
                }
            } catch (error) {
                console.error('Lỗi lưu hồ sơ:', error);
                alert('Lỗi lưu hồ sơ!');
            }
        });

        document.getElementById('clinical-result-edit-form').addEventListener('submit', saveClinicalResultEdit);

        // Listen for clinical results sync events
        function setupClinicalResultsSyncListener() {
            // Use BroadcastChannel for cross-tab communication
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('clinical-results-sync');
                channel.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'service-deleted') {
                        // Refresh clinical results if modal is open
                        if (currentResultsRecord) {
                            refreshClinicalResults();
                        }
                    }
                });
            }
            
            // Fallback: use localStorage event
            window.addEventListener('storage', (e) => {
                if (e.key === 'clinical-results-sync-trigger') {
                    try {
                        const data = JSON.parse(e.newValue || '{}');
                        if (data.type === 'service-deleted' && currentResultsRecord) {
                            refreshClinicalResults();
                        }
                    } catch (err) {
                        console.error('Error parsing sync data:', err);
                    }
                }
            });
            
            // Also listen to custom event (for same-tab communication)
            window.addEventListener('clinical-results-sync', () => {
                if (currentResultsRecord) {
                    refreshClinicalResults();
                }
            });
        }

        // Initialize
        async function initializePage() {
            try {
                // Tạo bảng nếu chưa tồn tại
                await fetch('/api/patient-records/init-table', { method: 'POST' });
                // Load dữ liệu
                await loadRecords();
                // Setup sync listener
                setupClinicalResultsSyncListener();
            } catch (error) {
                console.error('Lỗi khởi tạo trang:', error);
            }
        }
        
        initializePage();
    </script>
    
    <!-- Footer -->
    <footer class="footer" style="background: #333; color: white; text-align: center; padding: 2rem; margin-top: 3rem;">
        <div class="container">
            <p>&copy; 2025 Phòng khám chuyên khoa Phụ Sản Đại Anh. All rights reserved.</p>
        </div>
    </footer>

    <!-- AI Assistant - Luôn hiển thị trên mọi trang -->
    <script src="ai-assistant.js"></script>
    <script src="footer-loader.js"></script>
</body>
</html>
