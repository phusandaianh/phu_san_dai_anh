<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ng∆∞·ªùi d√πng v√† ph√¢n quy·ªÅn - Ph√≤ng kh√°m Ph·ª• S·∫£n ƒê·∫°i Anh</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="utilities.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .user-table th,
        .user-table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .user-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }

        .user-table tr:hover {
            background-color: #f9f9f9;
        }

        .role-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin: 2px;
        }

        .role-admin {
            background-color: #dc3545;
            color: white;
        }

        .role-doctor {
            background-color: #28a745;
            color: white;
        }

        .role-nurse {
            background-color: #17a2b8;
            color: white;
        }

        .role-receptionist {
            background-color: #ffc107;
            color: black;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }

        .role-checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .role-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .status-active {
            color: #28a745;
        }

        .status-inactive {
            color: #dc3545;
        }

        /* Style cho n√∫t hi·ªÉn th·ªã m·∫≠t kh·∫©u */
        #togglePassword {
            transition: color 0.3s ease;
        }

        #togglePassword:hover {
            color: #007bff !important;
        }

        #togglePassword:focus {
            outline: none;
            color: #007bff;
        }

        #passwordIcon {
            transition: transform 0.2s ease;
        }

        #togglePassword:hover #passwordIcon {
            transform: scale(1.1);
        }

        /* Style cho n√∫t hi·ªÉn th·ªã m·∫≠t kh·∫©u trong form ng∆∞·ªùi d√πng */
        #toggleUserPassword {
            transition: color 0.3s ease;
        }

        #toggleUserPassword:hover {
            color: #007bff !important;
        }

        #toggleUserPassword:focus {
            outline: none;
            color: #007bff;
        }

        #userPasswordIcon {
            transition: transform 0.2s ease;
        }

        #toggleUserPassword:hover #userPasswordIcon {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Qu·∫£n l√Ω ng∆∞·ªùi d√πng v√† ph√¢n quy·ªÅn</h1>
        
        <!-- Ph·∫ßn ƒëƒÉng nh·∫≠p -->
        <div id="loginSection" class="login-section" style="max-width: 400px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
            <h3 style="text-align: center; margin-bottom: 20px;">ƒêƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c</h3>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">T√™n ƒëƒÉng nh·∫≠p:</label>
                    <input type="text" id="loginUsername" required class="form-control" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p">
                </div>
                <div class="form-group">
                    <label for="loginPassword">M·∫≠t kh·∫©u:</label>
                    <div style="position: relative;">
                        <input type="password" id="loginPassword" required class="form-control" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" style="padding-right: 45px;">
                        <button type="button" id="togglePassword" onclick="togglePasswordVisibility()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #666; font-size: 16px;">
                            <i class="fas fa-eye" id="passwordIcon"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn primary-btn" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
                </button>
            </form>
            <div style="text-align: center; margin-top: 15px;">
                <button onclick="forgotPassword()" class="btn secondary-btn" style="font-size: 0.9em;">
                    <i class="fas fa-key"></i> Qu√™n m·∫≠t kh·∫©u?
            </button>
            </div>
        </div>

        <!-- Ph·∫ßn qu·∫£n l√Ω ng∆∞·ªùi d√πng (·∫©n ban ƒë·∫ßu) -->
        <div id="userManagementSection" style="display: none;">
			<div class="actions" style="margin: 20px 0; display: flex; justify-content: space-between; align-items: center;">
				<div style="display:flex; gap:8px; align-items:center;">
					<button id="tabUsers" onclick="setActiveTab('users')" class="btn secondary-btn">
						<i class="fas fa-list"></i> Danh s√°ch ng∆∞·ªùi d√πng
					</button>
					<button id="tabAddUser" onclick="handleAddUserTab()" class="btn primary-btn">
						<i class="fas fa-plus"></i> Th√™m ng∆∞·ªùi d√πng m·ªõi
					</button>
					<button id="tabPermissions" onclick="setActiveTab('permissions')" class="btn secondary-btn">
						<i class="fas fa-user-shield"></i> Ph√¢n quy·ªÅn
					</button>
				</div>
				<button onclick="logout()" class="btn secondary-btn">
					<i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
				</button>
			</div>

		<div class="table-container" id="userManagementTable">
            <table class="user-table">
                <thead>
                    <tr>
                        <th>T√™n ƒëƒÉng nh·∫≠p</th>
                        <th>H·ªç t√™n</th>
                        <th>Email</th>
                        <th>Vai tr√≤</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <!-- D·ªØ li·ªáu ng∆∞·ªùi d√πng s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JavaScript -->
                </tbody>
            </table>
        </div>

		<!-- Ph√¢n quy·ªÅn theo vai tr√≤ -->
		<div id="permissionsSection" style="display: none; margin-top: 20px;">
			<div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 12px;">
				<h2 style="margin:0; font-size: 1.2rem;">Ph√¢n quy·ªÅn theo vai tr√≤</h2>
				<div class="btn-group">
					<button type="button" class="btn secondary-btn" onclick="resetPermissionsToDefault()">
						M·∫∑c ƒë·ªãnh
					</button>
					<button type="button" class="btn primary-btn" onclick="savePermissions()">
						L∆∞u ph√¢n quy·ªÅn
					</button>
				</div>
			</div>
			<div class="table-container">
				<table class="user-table">
					<thead>
						<tr>
							<th>Quy·ªÅn</th>
							<th>Admin</th>
							<th>B√°c sƒ©</th>
							<th>Y t√°</th>
							<th>L·ªÖ t√¢n</th>
						</tr>
					</thead>
					<tbody id="permissionsTableBody">
						<!-- D√≤ng quy·ªÅn s·∫Ω render b·∫±ng JS -->
					</tbody>
				</table>
			</div>
			<small style="display:block; margin-top:8px; color:#666;">L∆∞u √Ω: Ph√¢n quy·ªÅn ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô v√† c√≥ th·ªÉ t√≠ch h·ª£p backend sau.</small>
		</div>
        </div>
    </div>

    <!-- Modal qu√™n m·∫≠t kh·∫©u -->
    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <h2>Qu√™n m·∫≠t kh·∫©u</h2>
            
            <!-- Tab t·ª± ƒë·ªông reset -->
            <div id="autoResetTab">
                <p>Nh·∫≠p th√¥ng tin t√†i kho·∫£n ƒë·ªÉ t·ª± ƒë·ªông reset m·∫≠t kh·∫©u:</p>
                <form id="forgotPasswordForm" onsubmit="handleForgotPassword(event)">
                    <div class="form-group">
                        <label for="resetUsername">T√™n ƒëƒÉng nh·∫≠p:</label>
                        <input type="text" id="resetUsername" required class="form-control" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p">
                    </div>
                    <div class="form-group">
                        <label for="resetEmail">Email ƒëƒÉng k√Ω:</label>
                        <input type="email" id="resetEmail" required class="form-control" placeholder="Nh·∫≠p email ƒëƒÉng k√Ω t√†i kho·∫£n">
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn primary-btn">
                            <i class="fas fa-key"></i> Reset m·∫≠t kh·∫©u
                        </button>
                        <button type="button" onclick="showManualReset()" class="btn secondary-btn">
                            <i class="fas fa-envelope"></i> Li√™n h·ªá th·ªß c√¥ng
                        </button>
                    </div>
                </form>
            </div>

            <!-- Tab li√™n h·ªá th·ªß c√¥ng -->
            <div id="manualResetTab" style="display: none;">
                <p>N·∫øu kh√¥ng th·ªÉ reset t·ª± ƒë·ªông, vui l√≤ng li√™n h·ªá v·ªõi qu·∫£n tr·ªã vi√™n:</p>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0;">
                    <p><strong>üìß Email h·ªó tr·ª£:</strong> <a href="mailto:hangocdai.kq3@gmail.com" style="color: #007bff;">hangocdai.kq3@gmail.com</a></p>
                    <p><strong>üìû Li√™n h·ªá:</strong> Vui l√≤ng g·ª≠i email v·ªõi ti√™u ƒë·ªÅ "Qu√™n m·∫≠t kh·∫©u - Ph√≤ng kh√°m ƒê·∫°i Anh"</p>
                    <p><strong>üìù N·ªôi dung c·∫ßn cung c·∫•p:</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>T√™n ƒëƒÉng nh·∫≠p c·ªßa b·∫°n</li>
                        <li>H·ªç t√™n ƒë·∫ßy ƒë·ªß</li>
                        <li>Email ƒëƒÉng k√Ω t√†i kho·∫£n</li>
                        <li>L√Ω do c·∫ßn reset m·∫≠t kh·∫©u</li>
                    </ul>
                </div>
                <div class="btn-group">
                    <button onclick="closeForgotPasswordModal()" class="btn primary-btn">ƒê√£ hi·ªÉu</button>
                    <button onclick="sendResetEmail()" class="btn secondary-btn">
                        <i class="fas fa-envelope"></i> G·ª≠i email ngay
                    </button>
                    <button onclick="showAutoReset()" class="btn secondary-btn">
                        <i class="fas fa-arrow-left"></i> Quay l·∫°i
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal th√™m/s·ª≠a ng∆∞·ªùi d√πng -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Th√™m ng∆∞·ªùi d√πng m·ªõi</h2>
            <form id="userForm" onsubmit="handleUserSubmit(event)">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label for="username">T√™n ƒëƒÉng nh·∫≠p:</label>
                    <input type="text" id="username" required class="form-control">
                </div>
                <div class="form-group">
                    <label for="fullName">H·ªç t√™n:</label>
                    <input type="text" id="fullName" required class="form-control">
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" required class="form-control">
                </div>
                <div class="form-group">
                    <label for="password">M·∫≠t kh·∫©u:</label>
                    <div style="position: relative;">
                        <input type="password" id="password" class="form-control" style="padding-right: 45px;">
                        <button type="button" id="toggleUserPassword" onclick="toggleUserPasswordVisibility()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #666; font-size: 16px;">
                            <i class="fas fa-eye" id="userPasswordIcon"></i>
                        </button>
                    </div>
                    <small>ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi m·∫≠t kh·∫©u</small>
                </div>
                <div class="form-group">
                    <label>Vai tr√≤:</label>
                    <div class="role-checkbox-group">
                        <div class="role-checkbox-item">
                            <input type="checkbox" id="roleAdmin" value="admin">
                            <label for="roleAdmin">Admin</label>
                        </div>
                        <div class="role-checkbox-item">
                            <input type="checkbox" id="roleDoctor" value="doctor">
                            <label for="roleDoctor">B√°c sƒ©</label>
                        </div>
                        <div class="role-checkbox-item">
                            <input type="checkbox" id="roleNurse" value="nurse">
                            <label for="roleNurse">Y t√°</label>
                        </div>
                        <div class="role-checkbox-item">
                            <input type="checkbox" id="roleReceptionist" value="receptionist">
                            <label for="roleReceptionist">L·ªÖ t√¢n</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="status">Tr·∫°ng th√°i:</label>
                    <select id="status" required class="form-control">
                        <option value="active">Ho·∫°t ƒë·ªông</option>
                        <option value="inactive">Kh√¥ng ho·∫°t ƒë·ªông</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn primary-btn">L∆∞u</button>
                    <button type="button" onclick="closeUserModal()" class="btn secondary-btn">H·ªßy</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Kh·ªüi t·∫°o state
        const state = {
            users: [],
            currentUser: null,
            isLoggedIn: false,
            rolePermissions: {}
        };

        // H√†m ƒëƒÉng nh·∫≠p
        async function login(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    state.currentUser = data.user;
                    state.isLoggedIn = true;
                    
                    // L∆∞u token v√†o localStorage
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    
                    // ·∫®n form ƒëƒÉng nh·∫≠p, hi·ªán ph·∫ßn qu·∫£n l√Ω
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('userManagementSection').style.display = 'block';
                    setActiveTab('users');
                    // Load danh s√°ch ng∆∞·ªùi d√πng
                    await loadUsers();
                    
                    alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
                } else {
                    alert('T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
                }
            } catch (error) {
                console.error('L·ªói ƒëƒÉng nh·∫≠p:', error);
                alert('C√≥ l·ªói x·∫£y ra khi ƒëƒÉng nh·∫≠p. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        // H√†m ƒëƒÉng xu·∫•t
        function logout() {
            state.currentUser = null;
            state.isLoggedIn = false;
            
            // X√≥a token kh·ªèi localStorage
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            
            // ·∫®n ph·∫ßn qu·∫£n l√Ω, hi·ªán form ƒëƒÉng nh·∫≠p
            document.getElementById('userManagementSection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            
            // Reset form ƒëƒÉng nh·∫≠p
            document.getElementById('loginForm').reset();
            
            alert('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!');
        }

        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p khi t·∫£i trang
        function checkLoginStatus() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('currentUser');
            
            if (token && user) {
                try {
                    state.currentUser = JSON.parse(user);
                    state.isLoggedIn = true;
                    
                    // ·∫®n form ƒëƒÉng nh·∫≠p, hi·ªán ph·∫ßn qu·∫£n l√Ω
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('userManagementSection').style.display = 'block';
                    
                    // Load danh s√°ch ng∆∞·ªùi d√πng
                    loadUsers();
                } catch (error) {
                    console.error('L·ªói khi ki·ªÉm tra ƒëƒÉng nh·∫≠p:', error);
                    logout();
                }
            }
        }

        // H√†m hi·ªÉn th·ªã/·∫©n m·∫≠t kh·∫©u ƒëƒÉng nh·∫≠p
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('loginPassword');
            const passwordIcon = document.getElementById('passwordIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                passwordIcon.className = 'fas fa-eye-slash';
                passwordIcon.title = '·∫®n m·∫≠t kh·∫©u';
            } else {
                passwordInput.type = 'password';
                passwordIcon.className = 'fas fa-eye';
                passwordIcon.title = 'Hi·ªÉn th·ªã m·∫≠t kh·∫©u';
            }
        }

        // H√†m hi·ªÉn th·ªã/·∫©n m·∫≠t kh·∫©u trong form ng∆∞·ªùi d√πng
        function toggleUserPasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const passwordIcon = document.getElementById('userPasswordIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                passwordIcon.className = 'fas fa-eye-slash';
                passwordIcon.title = '·∫®n m·∫≠t kh·∫©u';
            } else {
                passwordInput.type = 'password';
                passwordIcon.className = 'fas fa-eye';
                passwordIcon.title = 'Hi·ªÉn th·ªã m·∫≠t kh·∫©u';
            }
        }

        // H√†m hi·ªÉn th·ªã modal qu√™n m·∫≠t kh·∫©u
        function forgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'block';
        }

        // H√†m ƒë√≥ng modal qu√™n m·∫≠t kh·∫©u
        function closeForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').style.display = 'none';
        }

        // H√†m x·ª≠ l√Ω form qu√™n m·∫≠t kh·∫©u
        async function handleForgotPassword(event) {
            event.preventDefault();
            
            const username = document.getElementById('resetUsername').value;
            const email = document.getElementById('resetEmail').value;
            
            try {
                const response = await fetch('/api/forgot-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ ${data.message}\n\nM·∫≠t kh·∫©u m·ªõi: ${data.new_password}\n\nVui l√≤ng ƒëƒÉng nh·∫≠p v√† thay ƒë·ªïi m·∫≠t kh·∫©u ngay!`);
                    closeForgotPasswordModal();
                } else {
                    alert(`‚ùå ${data.error}`);
                }
            } catch (error) {
                console.error('Error resetting password:', error);
                alert('‚ùå C√≥ l·ªói x·∫£y ra khi reset m·∫≠t kh·∫©u. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        // H√†m chuy·ªÉn sang tab li√™n h·ªá th·ªß c√¥ng
        function showManualReset() {
            document.getElementById('autoResetTab').style.display = 'none';
            document.getElementById('manualResetTab').style.display = 'block';
        }

        // H√†m chuy·ªÉn v·ªÅ tab t·ª± ƒë·ªông reset
        function showAutoReset() {
            document.getElementById('manualResetTab').style.display = 'none';
            document.getElementById('autoResetTab').style.display = 'block';
        }

        // H√†m g·ª≠i email reset m·∫≠t kh·∫©u
        function sendResetEmail() {
            const email = 'hangocdai.kq3@gmail.com';
            const subject = 'Qu√™n m·∫≠t kh·∫©u - Ph√≤ng kh√°m ƒê·∫°i Anh';
            const body = `Xin ch√†o qu·∫£n tr·ªã vi√™n,

T√¥i c·∫ßn h·ªó tr·ª£ reset m·∫≠t kh·∫©u cho t√†i kho·∫£n c·ªßa m√¨nh.

Th√¥ng tin t√†i kho·∫£n:
- T√™n ƒëƒÉng nh·∫≠p: [Vui l√≤ng ƒëi·ªÅn t√™n ƒëƒÉng nh·∫≠p c·ªßa b·∫°n]
- H·ªç t√™n: [Vui l√≤ng ƒëi·ªÅn h·ªç t√™n ƒë·∫ßy ƒë·ªß]
- Email ƒëƒÉng k√Ω: [Vui l√≤ng ƒëi·ªÅn email ƒëƒÉng k√Ω t√†i kho·∫£n]
- L√Ω do: [Vui l√≤ng ƒëi·ªÅn l√Ω do c·∫ßn reset m·∫≠t kh·∫©u]

C·∫£m ∆°n b·∫°n ƒë√£ h·ªó tr·ª£!

Tr√¢n tr·ªçng,
[Vui l√≤ng ƒëi·ªÅn t√™n c·ªßa b·∫°n]`;

            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);
            
            // ƒê√≥ng modal sau khi m·ªü email client
            setTimeout(() => {
                closeForgotPasswordModal();
            }, 1000);
        }

        // Helper th√™m Authorization header
        function getAuthHeaders() {
            const token = localStorage.getItem('authToken') || '';
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        // H√†m ƒë·ªÉ load danh s√°ch ng∆∞·ªùi d√πng
        async function loadUsers() {
            try {
                const response = await fetch('/api/users', { headers: { ...getAuthHeaders() } });
                if (!response.ok) throw new Error('Failed to load users');
                state.users = await response.json();
                renderUsers();
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ng∆∞·ªùi d√πng. Vui l√≤ng th·ª≠ l·∫°i sau.');
            }
        }

        // ====== Ph√¢n quy·ªÅn theo vai tr√≤ ======
        // Danh s√°ch quy·ªÅn s·∫Ω l·∫•y ƒë·ªông t·ª´ backend
        let DYNAMIC_PERMISSIONS = [];
        const PERMISSION_LABELS = {
            'manage_users': 'Qu·∫£n l√Ω ng∆∞·ªùi d√πng',
            'manage_worklist': 'Qu·∫£n l√Ω Worklist (DICOM MWL)',
            'manage_appointments': 'Qu·∫£n l√Ω l·ªãch h·∫πn',
            'view_patients': 'Xem h·ªì s∆° b·ªánh nh√¢n',
            'manage_patients': 'Qu·∫£n l√Ω b·ªánh nh√¢n',
            'manage_diagnosis': 'Qu·∫£n l√Ω ch·∫©n ƒëo√°n',
            'view_reports': 'Xem b√°o c√°o',
            'system_config': 'C·∫•u h√¨nh h·ªá th·ªëng',
            'manage_voluson_sync': 'ƒê·ªìng b·ªô Voluson'
        };

        const ROLES = ['admin','doctor','nurse','receptionist'];

        async function loadPermissionsFromStorage() {
            try {
                const token = localStorage.getItem('authToken') || '';
                const res = await fetch('/api/role-permissions', { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) {
                    const data = await res.json();
                    if (data && typeof data === 'object') {
                        state.rolePermissions = data;
                        return;
                    }
                }
                const saved = localStorage.getItem('rolePermissions');
                if (saved) { state.rolePermissions = JSON.parse(saved); return; }
            } catch (e) {}
            // M·∫∑c ƒë·ªãnh
            state.rolePermissions = {
                admin: DEFAULT_PERMISSIONS.map(p => p.key),
                doctor: ['view_patients','manage_appointments','manage_diagnosis','view_reports'],
                nurse: ['view_patients','manage_appointments'],
                receptionist: ['manage_appointments']
            };
        }

        async function savePermissions() {
            try {
                const token = localStorage.getItem('authToken') || '';
                const res = await fetch('/api/role-permissions', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(state.rolePermissions)
                });
                if (!res.ok) throw new Error('L∆∞u l√™n server th·∫•t b·∫°i');
                localStorage.setItem('rolePermissions', JSON.stringify(state.rolePermissions));
                alert('ƒê√£ l∆∞u ph√¢n quy·ªÅn th√†nh c√¥ng');
            } catch (e) {
                console.error(e);
                alert('Kh√¥ng th·ªÉ l∆∞u l√™n server, ƒë√£ l∆∞u t·∫°m tr√™n tr√¨nh duy·ªát');
                localStorage.setItem('rolePermissions', JSON.stringify(state.rolePermissions));
            }
        }

        function resetPermissionsToDefault() {
            localStorage.removeItem('rolePermissions');
            loadPermissionsFromStorage();
            renderPermissionsTable();
        }

        async function renderPermissionsTable() {
            const tbody = document.getElementById('permissionsTableBody');
            if (!tbody) return;
            // L·∫•y danh s√°ch quy·ªÅn ƒë·ªông n·∫øu ch∆∞a c√≥
            if (DYNAMIC_PERMISSIONS.length === 0) {
                try {
                    const res = await fetch('/api/permissions');
                    const data = await res.json();
                    DYNAMIC_PERMISSIONS = (data.permissions || []);
                } catch (e) { DYNAMIC_PERMISSIONS = []; }
            }
            tbody.innerHTML = DYNAMIC_PERMISSIONS.map(key => {
                const label = PERMISSION_LABELS[key] || key;
                return `
                    <tr>
                        <td>${label}</td>
                        ${ROLES.map(role => `
                            <td style="text-align:center;">
                                <input type="checkbox" ${state.rolePermissions[role]?.includes(key) ? 'checked' : ''}
                                       onchange="togglePermission('${role}','${key}', this.checked)">
                            </td>
                        `).join('')}
                    </tr>
                `;
            }).join('');
        }

        function togglePermission(role, permKey, isChecked) {
            const current = new Set(state.rolePermissions[role] || []);
            if (isChecked) current.add(permKey); else current.delete(permKey);
            state.rolePermissions[role] = Array.from(current);
        }

        async function showPermissionsTab() {
            // ·∫®n qu·∫£n l√Ω ng∆∞·ªùi d√πng, hi·ªán ph√¢n quy·ªÅn
            document.getElementById('userManagementTable').style.display = 'none';
            document.getElementById('permissionsSection').style.display = 'block';
            await loadPermissionsFromStorage();
            await renderPermissionsTable();
        }

        function showUsersTab() {
            document.getElementById('permissionsSection').style.display = 'none';
            document.getElementById('userManagementTable').style.display = 'block';
        }

        // Tabs helper
        function setActiveTab(tab) {
            const tabUsers = document.getElementById('tabUsers');
            const tabAdd = document.getElementById('tabAddUser');
            const tabPerm = document.getElementById('tabPermissions');
            [tabUsers, tabAdd, tabPerm].forEach(btn => btn && btn.classList.remove('primary-btn'));
            [tabUsers, tabAdd, tabPerm].forEach(btn => btn && btn.classList.add('secondary-btn'));
            if (tab === 'users') {
                showUsersTab();
                tabUsers.classList.remove('secondary-btn');
                tabUsers.classList.add('primary-btn');
            } else if (tab === 'permissions') {
                showPermissionsTab();
                tabPerm.classList.remove('secondary-btn');
                tabPerm.classList.add('primary-btn');
            }
        }

        function handleAddUserTab() {
            setActiveTab('users');
            showAddUserModal();
        }

        // H√†m render danh s√°ch ng∆∞·ªùi d√πng
        function renderUsers() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = state.users.map(user => `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.fullName}</td>
                    <td>${user.email}</td>
                    <td>${renderRoleBadges(user.roles)}</td>
                    <td>
                        <span class="status-${user.status}">
                            <i class="fas fa-circle"></i>
                            ${user.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group">
                            <button onclick="editUser('${user.id}')" class="btn primary-btn">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteUser('${user.id}')" class="btn danger-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // H√†m render badges cho vai tr√≤
        function renderRoleBadges(roles) {
            const roleLabels = {
                admin: 'Admin',
                doctor: 'B√°c sƒ©',
                nurse: 'Y t√°',
                receptionist: 'L·ªÖ t√¢n'
            };
            
            return roles.map(role => `
                <span class="role-badge role-${role}">
                    ${roleLabels[role]}
                </span>
            `).join('');
        }

        // H√†m hi·ªán modal th√™m ng∆∞·ªùi d√πng
        function showAddUserModal() {
            document.getElementById('modalTitle').textContent = 'Th√™m ng∆∞·ªùi d√πng m·ªõi';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('password').required = true;
            document.getElementById('userModal').style.display = 'block';
        }

        // H√†m ƒë√≥ng modal
        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        // H√†m x·ª≠ l√Ω submit form
        async function handleUserSubmit(event) {
            event.preventDefault();
            
            const userId = document.getElementById('userId').value;
            const formData = {
                username: document.getElementById('username').value,
                fullName: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                roles: getRoleSelection(),
                status: document.getElementById('status').value
            };

            try {
                const url = userId ? `/api/users/${userId}` : '/api/users';
                const method = userId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) throw new Error('Failed to save user');
                
                await loadUsers();
                closeUserModal();
                alert(userId ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m ng∆∞·ªùi d√πng th√†nh c√¥ng!');
            } catch (error) {
                console.error('Error saving user:', error);
                alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        // H√†m l·∫•y danh s√°ch vai tr√≤ ƒë∆∞·ª£c ch·ªçn
        function getRoleSelection() {
            const roles = ['admin', 'doctor', 'nurse', 'receptionist'];
            return roles.filter(role => 
                document.getElementById(`role${role.charAt(0).toUpperCase() + role.slice(1)}`).checked
            );
        }

        // H√†m s·ª≠a ng∆∞·ªùi d√πng
        async function editUser(userId) {
            try {
                const response = await fetch(`/api/users/${userId}`, { headers: { ...getAuthHeaders() } });
                if (!response.ok) throw new Error('Failed to load user');
                const user = await response.json();
                
                document.getElementById('modalTitle').textContent = 'S·ª≠a th√¥ng tin ng∆∞·ªùi d√πng';
                document.getElementById('userId').value = user.id;
                document.getElementById('username').value = user.username;
                document.getElementById('fullName').value = user.fullName;
                document.getElementById('email').value = user.email;
                document.getElementById('password').required = false;
                document.getElementById('password').value = '';
                document.getElementById('status').value = user.status;
                
                // Reset v√† set vai tr√≤
                const roles = ['admin', 'doctor', 'nurse', 'receptionist'];
                roles.forEach(role => {
                    document.getElementById(`role${role.charAt(0).toUpperCase() + role.slice(1)}`).checked = 
                        user.roles.includes(role);
                });
                
                document.getElementById('userModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading user:', error);
                alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        // H√†m x√≥a ng∆∞·ªùi d√πng
        async function deleteUser(userId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?')) return;
            
            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: { ...getAuthHeaders() }
                });
                
                if (!response.ok) throw new Error('Failed to delete user');
                
                await loadUsers();
                alert('X√≥a ng∆∞·ªùi d√πng th√†nh c√¥ng!');
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Kh√¥ng th·ªÉ x√≥a ng∆∞·ªùi d√πng. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        // Load danh s√°ch ng∆∞·ªùi d√πng khi trang ƒë∆∞·ª£c t·∫£i
        document.addEventListener('DOMContentLoaded', function() {
            // Th√™m event listener cho form ƒëƒÉng nh·∫≠p
            document.getElementById('loginForm').addEventListener('submit', login);
            
            // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
            checkLoginStatus();

            // M·∫∑c ƒë·ªãnh tab danh s√°ch s√°ng khi ƒë√£ v√†o khu v·ª±c qu·∫£n l√Ω
            if (document.getElementById('userManagementSection').style.display === 'block') {
                setActiveTab('users');
            }
        });

        // ƒê√≥ng modal khi click b√™n ngo√†i
        window.onclick = function(event) {
            const userModal = document.getElementById('userModal');
            const forgotPasswordModal = document.getElementById('forgotPasswordModal');
            
            if (event.target === userModal) {
                closeUserModal();
            }
            if (event.target === forgotPasswordModal) {
                closeForgotPasswordModal();
            }
        };
    </script>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2026 Ph√≤ng kh√°m chuy√™n khoa Ph·ª• S·∫£n ƒê·∫°i Anh. All rights reserved.</p>
        </div>
    </footer>

    <!-- AI Assistant - Lu√¥n hi·ªÉn th·ªã tr√™n m·ªçi trang -->
    <script src="ai-assistant.js"></script>
    <script src="footer-loader.js"></script>
</body>
</html>