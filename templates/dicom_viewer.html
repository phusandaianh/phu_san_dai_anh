<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>DICOM Interactive Viewer</title>
  <style>
    body { margin: 0; font-family: Arial; background: #0f172a; color: #e2e8f0; }
    .topbar { display:flex; align-items:center; gap:8px; padding:10px; background:#111827; position:sticky; top:0; z-index:2; }
    .topbar button { background:#1f2937; color:#e5e7eb; border:1px solid #374151; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .topbar button.active { background:#2563eb; border-color:#2563eb; }
    .viewport { width: 100vw; height: calc(100vh - 56px); background:black; display:flex; align-items:center; justify-content:center; }
    #dicomViewport { width: 100%; height: 100%; outline: none; position: relative; }
  </style>
  <!-- Cornerstone v2 + Tools v4 + WADO Image Loader + dicomParser via CDN -->
  <script src="https://unpkg.com/cornerstone-core@2.6.2/dist/cornerstone.js"></script>
  <script src="https://unpkg.com/dicom-parser@1.8.19/dist/dicomParser.js"></script>
  <script src="https://unpkg.com/cornerstone-wado-image-loader@4.13.1/dist/cornerstoneWADOImageLoader.js"></script>
  <script src="https://unpkg.com/cornerstone-math@0.1.9/dist/cornerstoneMath.js"></script>
  <script src="https://unpkg.com/cornerstone-tools@4.23.3/dist/cornerstoneTools.js"></script>
  {% if cors_proxy %}
  <script>
    // Optional: configure CORS proxy if needed
    cornerstoneWADOImageLoader.configure({
      useWebWorkers: true,
      beforeSend: function(xhr) {
        // custom headers if needed
      }
    });
  </script>
  {% endif %}
</head>
<body>
  <div class="topbar">
    <span>üë§ {{ patient }}</span>
    <span>|</span>
    <span>üìÑ {{ filename }}</span>
    <span style="flex:1"></span>
    <button id="btnWindow">Window/Level</button>
    <button id="btnPan">Pan</button>
    <button id="btnZoom">Zoom</button>
    <button id="btnLength">Length</button>
    <button id="btnAngle">Angle</button>
    <button id="btnElliptical">Elliptical ROI</button>
    <button id="btnRectangle">Rectangle ROI</button>
    <button id="btnProbe">Probe</button>
    <button id="btnClear">Clear</button>
  </div>
  <div class="viewport">
    <div id="dicomViewport"></div>
  </div>

  <script>
    // Kh·ªüi t·∫°o Cornerstone & WADO
    const imageId = 'wadouri:' + window.location.origin + '/dicom/{{ patient }}/{{ filename }}';
    cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
    cornerstoneWADOImageLoader.external.dicomParser = dicomParser;
    cornerstoneTools.external.cornerstone = cornerstone;
    cornerstoneTools.external.cornerstoneMath = cornerstoneMath;

    // C·∫•u h√¨nh web worker ƒë·ªÉ parse DICOM
    cornerstoneWADOImageLoader.webWorkerManager.initialize({
      maxWebWorkers: 1,
      startWebWorkersOnDemand: true,
      webWorkerPath: 'https://unpkg.com/cornerstone-wado-image-loader@4.13.1/dist/cornerstoneWADOImageLoaderWebWorker.js',
      taskConfiguration: {
        decodeTask: {
          codecsPath: 'https://unpkg.com/cornerstone-wado-image-loader@4.13.1/dist/cornerstoneWADOImageLoaderCodecs.js'
        }
      }
    });

    const element = document.getElementById('dicomViewport');
    cornerstone.enable(element);

    // B·∫≠t c√°c annotation tool
    const { PanTool, ZoomTool, WindowLevelTool, LengthTool, AngleTool, EllipticalRoiTool, RectangleRoiTool, ProbeTool } = cornerstoneTools;
    cornerstoneTools.init();
    cornerstoneTools.addTool(PanTool);
    cornerstoneTools.addTool(ZoomTool, { configuration: { invert: false } });
    cornerstoneTools.addTool(WindowLevelTool);
    cornerstoneTools.addTool(LengthTool);
    cornerstoneTools.addTool(AngleTool);
    cornerstoneTools.addTool(EllipticalRoiTool);
    cornerstoneTools.addTool(RectangleRoiTool);
    cornerstoneTools.addTool(ProbeTool);

    function setActiveTool(name) {
      // Clear active
      document.querySelectorAll('.topbar button').forEach(b => b.classList.remove('active'));
      // Activate
      cornerstoneTools.setToolActive(name + 'Tool', { mouseButtonMask: 1 });
      const id = 'btn' + (name === 'Window' ? 'Window' : name);
      const btn = document.getElementById(id);
      if (btn) btn.classList.add('active');
    }

    document.getElementById('btnWindow').onclick = () => setActiveTool('Window');
    document.getElementById('btnPan').onclick = () => setActiveTool('Pan');
    document.getElementById('btnZoom').onclick = () => setActiveTool('Zoom');
    document.getElementById('btnLength').onclick = () => setActiveTool('Length');
    document.getElementById('btnAngle').onclick = () => setActiveTool('Angle');
    document.getElementById('btnElliptical').onclick = () => setActiveTool('Elliptical');
    document.getElementById('btnRectangle').onclick = () => setActiveTool('Rectangle');
    document.getElementById('btnProbe').onclick = () => setActiveTool('Probe');
    document.getElementById('btnClear').onclick = () => {
      const toolState = cornerstoneTools.globalImageIdSpecificToolStateManager.toolState;
      Object.keys(toolState).forEach(key => delete toolState[key]);
      cornerstone.updateImage(element);
    };

    // T·∫£i ·∫£nh v√† hi·ªÉn th·ªã
    cornerstone.loadAndCacheImage(imageId).then(image => {
      const defaultViewport = cornerstone.getDefaultViewportForImage(element, image);
      cornerstone.displayImage(element, image, defaultViewport);
      // M·∫∑c ƒë·ªãnh m·ªü Window/Level
      setActiveTool('Window');
    }).catch(err => {
      console.error('L·ªói t·∫£i ·∫£nh:', err);
      alert('L·ªói t·∫£i DICOM: ' + err);
    });
  </script>
    
    <!-- Footer -->
    <footer class="footer" style="background: #333; color: white; text-align: center; padding: 2rem; margin-top: 3rem;">
        <div class="container">
            <p>&copy; 2025 Ph√≤ng kh√°m chuy√™n khoa Ph·ª• S·∫£n ƒê·∫°i Anh. All rights reserved.</p>
        </div>
    </footer>

    <!-- AI Assistant - Lu√¥n hi·ªÉn th·ªã tr√™n m·ªçi trang -->
    <script src="ai-assistant.js"></script>
</body>
</html>


