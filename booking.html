<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>L·ªãch l√†m vi·ªác - Ph√≤ng kh√°m Ph·ª• S·∫£n ƒê·∫°i Anh</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { background: #f8fafc; margin: 0; font-family: 'Roboto', Arial, sans-serif; }
        .header { background: #fff; box-shadow: 0 2px 8px rgba(44,62,80,0.04); }
        .header .container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            padding: 2rem 1rem 1.5rem 1rem;
        }
        .logo-text { text-align: left; }
        .logo { 
            font-size: 1.5rem; 
            color: #0000FF; 
            margin: 0; 
            font-weight: bold;
            white-space: nowrap; /* Ensure text stays on one line */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Add ellipsis if text overflows */
        }
        .slogan { margin: 0; font-size: 1rem; color: #888; }
        .work-schedule-section {
            max-width: 900px;
            margin: 2rem auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(33,150,243,0.08);
            padding: 2rem 1rem 2.5rem 1rem;
        }
        .work-schedule-title {
            text-align: center;
            font-size: 1.4rem;
            font-weight: bold;
            color: #e53935;
            margin-bottom: 2rem;
            letter-spacing: 1px;
        }
        .schedule-list {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }
        .schedule-card {
            background: #CCFFCC;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(33,150,243,0.07);
            padding: 1.2rem 1.2rem 1.2rem 1.2rem;
            display: flex;
            flex-direction: row;
            align-items: center;
            min-height: 120px;
            position: relative;
            gap: 1.2rem;
        }
        .schedule-card.today { border: 2px solid #e53935; }
        .schedule-card.tomorrow { border: 2px solid #ffb300; }
        .schedule-register {
            min-width: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .register-btn {
            background: #e53935;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0.7rem 1.2rem;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 0.5rem;
        }
        .register-btn:hover {
            background: #b71c1c;
        }
        .schedule-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .schedule-date {
            font-size: 1.1rem;
            font-weight: bold;
            color: #2196f3;
            margin-bottom: 0.3rem;
        }
        .schedule-status {
            font-size: 0.95rem;
            font-weight: bold;
            color: #e53935;
            margin-bottom: 0.5rem;
        }
        .schedule-status.tomorrow { color: #ff9800; }
        .schedule-time {
            font-size: 1.05rem;
            color: #388e3c;
            margin-bottom: 0.3rem;
        }
        .schedule-doctor {
            font-size: 1.05rem;
            color: #222;
        }
        @media (max-width: 600px) {
            .work-schedule-section { padding: 1rem 0.2rem; }
            .schedule-list { gap: 0.7rem; }
            .schedule-card { flex-direction: column; align-items: stretch; gap: 0.7rem; }
            .schedule-register { min-width: unset; flex-direction: row; justify-content: flex-start; }
        }
        .modal.hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container" style="display: flex; align-items: flex-start; gap: 1.5rem; padding: 2rem 1rem 1.5rem 1rem;">
            <img src="logo_phu_san_dai_anh.PNG" alt="Logo Ph√≤ng kh√°m ƒê·∫°i Anh" class="clinic-logo" style="height:60px; margin-top: 0; margin-bottom: 0; display: block;">
            <div class="logo-text">
                <h1 class="logo">Ph√≤ng kh√°m chuy√™n khoa Ph·ª• S·∫£n ƒê·∫°i Anh</h1>
                <div class="clinic-subtitle" id="clinic-summary" style="text-align:center;color:#0000FF;font-size:1rem;margin:4px 0;">Si√™u √¢m 5D, s√†ng l·ªçc d·ªã t·∫≠t, kh√°m ph·ª• khoa, v√¥ sinh</div>
                <p class="slogan" style="color: #e53935; text-align: center; font-weight: bold;">Uy T√≠n - Ch·∫•t L∆∞·ª£ng</p>
                <div style="text-align: center; margin-top: 10px;">
                    <div style="font-size: 0.9rem; color: #0000FF; line-height: 1.4;">
                        TDP Qu√°n Tr·∫Øng - T√¢n An - B·∫Øc Ninh - ƒêT: 0858.838.616
                    </div>
                    <div style="text-align:center; margin-top:8px;">
                        <span style="display:inline-block; background:#e53935; color:#fff; padding:6px 12px; border-radius:8px; font-weight:bold;">
                            L·ªäCH L√ÄM VI·ªÜC C·ª¶A PH√íNG KH√ÅM
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <div id="header-spacer"></div>
    <script>
    (function(){
      function adjustSpacer(){
        var header = document.querySelector('.header');
        var spacer = document.getElementById('header-spacer');
        if (!header || !spacer) return;
        spacer.style.height = (header.offsetHeight + 10) + 'px';
      }
      window.addEventListener('load', adjustSpacer);
      window.addEventListener('resize', adjustSpacer);
    })();
    </script>
    <section class="work-schedule-section">
        <div class="schedule-list" id="schedule-list"></div>
    </section>
    <!-- Popup ƒëƒÉng k√Ω kh√°m -->
    <div id="register-modal" class="modal hidden" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;z-index:1000;">
      <div class="modal-content" style="background:#fff;padding:2rem 1.5rem;border-radius:14px;min-width:320px;max-width:95vw;position:relative;">
        <button id="close-modal-btn" style="position:absolute;top:10px;right:10px;font-size:1.2rem;background:none;border:none;cursor:pointer;">&times;</button>
        <h2 style="margin-top:0">ƒêƒÉng k√Ω kh√°m</h2>
        <form id="register-form">
          <div id="register-type-group" style="display:flex;margin-bottom:16px;">
            <div id="register-type-first" style="flex:1;background:#0033ff;color:#fff;font-size:1.4rem;font-weight:500;text-align:center;padding:18px 0;cursor:pointer;border-radius:10px 0 0 10px;">ƒêƒÉng k√Ω l·∫ßn ƒë·∫ßu</div>
            <div id="register-type-repeat" style="flex:1;background:#0033ff;color:#fff;font-size:1.4rem;font-weight:500;text-align:center;padding:18px 0;cursor:pointer;border-left:2px solid #fff;border-radius:0 10px 10px 0;">Kh√°m l·∫°i theo s·ªë ƒêT</div>
          </div>
          <div><b id="modal-date"></b></div>
          <div><b id="modal-time"></b></div>
          <div><b id="modal-doctor"></b></div>
          <div style="margin:10px 0 0 0;">
            <input type="text" id="patient-name" placeholder="H·ªç v√† t√™n" required style="width:100%;margin-bottom:8px;padding:7px;border-radius:6px;border:1px solid #ccc;">
            <input type="date" id="patient-dob" placeholder="Ng√†y sinh (dd/mm/yyyy)" title="G·ª£i √Ω: Ch·ªçn ng√†y, th√°ng, nƒÉm sinh theo ƒë·ªãnh d·∫°ng dd/mm/yyyy" required style="width:100%;margin-bottom:4px;padding:7px;border-radius:6px;border:1px solid #ccc;">
            <div style="font-size:0.85rem;color:#666;margin:0 0 8px 2px;">G·ª£i √Ω: ch·ªçn ng√†y, th√°ng, nƒÉm sinh (v√≠ d·ª•: 31/12/1990)</div>
            <input type="tel" id="patient-phone" placeholder="S·ªë ƒëi·ªán tho·∫°i" required style="width:100%;margin-bottom:8px;padding:7px;border-radius:6px;border:1px solid #ccc;">
            <input type="text" id="patient-address" placeholder="ƒê·ªãa ch·ªâ" required style="width:100%;margin-bottom:8px;padding:7px;border-radius:6px;border:1px solid #ccc;">
            <input type="text" id="patient-reason" placeholder="L√Ω do kh√°m/D·ªãch v·ª•" list="reasons-list" style="width:100%;margin-bottom:8px;padding:7px;border-radius:6px;border:1px solid #ccc;">
            <datalist id="reasons-list"></datalist>
            <div style="margin-bottom:8px;">
              <label for="appointment-time" style="display:block;font-size:0.9rem;color:#555;margin-bottom:6px;">Ch·ªçn gi·ªù ƒëƒÉng k√Ω kh√°m :</label>
              <select id="appointment-time" required style="width:100%;padding:7px;border-radius:6px;border:1px solid #ccc;">
                <option value="" disabled selected>Vui l√≤ng ch·ªçn</option>
              </select>
              <div style="font-size:0.85rem;color:#666;margin-top:6px;">G·ª£i √Ω: gi·ªù hi·ªÉn th·ªã l√† c√°c khung gi·ªù c√≤n tr·ªëng trong ca kh√°m c·ªßa b√°c sƒ©.</div>
            </div>
          </div>
          <button type="submit" class="register-btn" style="width:100%;margin-top:8px;">X√°c nh·∫≠n ƒëƒÉng k√Ω</button>
        </form>
      </div>
    </div>
    <div id="ws-copy-week-modal" class="modal hidden" ...>
    </div>
    <script>
    // H√†m l·∫•y th·ª© ti·∫øng Vi·ªát
    function getVietnameseDay(dateStr) {
      const d = new Date(dateStr);
      const days = ['Ch·ªß nh·∫≠t', 'Th·ª© hai', 'Th·ª© ba', 'Th·ª© t∆∞', 'Th·ª© nƒÉm', 'Th·ª© s√°u', 'Th·ª© b·∫£y'];
      return days[d.getDay()];
    }
    // H√†m format ng√†y dd-mm-yyyy
    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString('vi-VN');
    }
    // H√†m so s√°nh gi·ªù (hh:mm)
    function isPast(endTime, dateStr) {
      const now = new Date();
      const d = new Date(dateStr);
      if (now < d.setHours(0,0,0,0)) return false; // ng√†y t∆∞∆°ng lai
      const [h, m] = endTime.split(':');
      d.setHours(+h, +m, 0, 0);
      return now > d;
    }
    // Render l·ªãch l√†m vi·ªác ƒë·ªông
    async function renderSchedule() {
  const scheduleList = document.getElementById('schedule-list');
  scheduleList.innerHTML = '';
  const res = await fetch('/api/work-schedule');
  const data = await res.json();

  // L·∫•y ng√†y h√¥m nay
  const todayDate = new Date();
  const todayStr = todayDate.toISOString().split('T')[0];

  // Ki·ªÉm tra API c√≥ tr·∫£ ng√†y h√¥m nay ch∆∞a
  const hasToday = data.some(day => {
    const d = new Date(day.date);
    return d.toDateString() === todayDate.toDateString();
  });

  // N·∫øu ch∆∞a c√≥, th√™m ng√†y h√¥m nay v·ªõi m·∫£ng shifts r·ªóng
  if (!hasToday) {
    data.unshift({
      date: todayStr,
      shifts: []
    });
  }

  data.forEach(day => {
    const card = document.createElement('div');
    card.className = 'schedule-card';

    const current = new Date(day.date);
    const isToday = todayDate.toDateString() === current.toDateString();

    let html = `<div class='schedule-info'>`;

    if (isToday) {
      html += `<div style="font-size:1.1rem;background:#ffe0e0;color:#1565c0;padding:6px 10px;border-radius:8px;font-weight:bold;margin-bottom:6px;">
        üìÖ H√¥m nay, ${getVietnameseDay(day.date)}, ng√†y ${formatDate(day.date)}
      </div>`;
    } else {
      html += `<div class='schedule-date' style="color:#1565c0;">
        ${getVietnameseDay(day.date)}, Ng√†y <span style="color:#1565c0;font-weight:bold;">${formatDate(day.date)}</span>
      </div>`;
    }

    if (!day.shifts.length) {
      html += `<div style='color:#e53935;font-weight:bold;margin-top:8px;'>Hi·ªán t·∫°i ch∆∞a c√≥ l·ªãch kh√°m</div>`;
    } else {
      day.shifts.forEach((shift, idx) => {
        const hetGio = isPast(shift.end_time, day.date);
        html += `<div style='margin:10px 0 0 0;padding:10px 0;border-top:1px dashed #b3e5fc;'>
          ${shift.is_closed ? `
            <button class='register-btn' disabled style='opacity:1;background:#9e9e9e;cursor:not-allowed;'>Ph√≤ng kh√°m ngh·ªâ l√†m vi·ªác</button>
          ` : `
            <div class='schedule-time'><b>Gi·ªù kh√°m:</b> <b>${shift.start_time} ƒë·∫øn ${shift.end_time}</b></div>
            <div class='schedule-doctor'>B√°c sƒ© kh√°m: <b>${shift.doctor_name}</b></div>
            ${shift.is_locked ? `
              <button class='register-btn' disabled style='opacity:1;background:#9e9e9e;cursor:not-allowed;'>Ph√≤ng kh√°m ƒë√£ ƒë·∫ßy l·ªãch kh√°m. Kh√¥ng nh·∫≠n ƒëƒÉng k√≠ kh√°m m·ªõi</button>
            ` : (hetGio ? `
              <div style='color:#e53935;font-weight:bold;'>H·∫øt gi·ªù kh√°m ca n√†y</div>
            ` : `
              <button class='register-btn' data-date='${day.date}' data-start='${shift.start_time}' data-end='${shift.end_time}' data-doctor='${shift.doctor_name}'>ƒêƒÉng k√Ω kh√°m</button>
            `)}
          `}
        </div>`;
      });
    }

    html += `</div>`;
    card.innerHTML = html;
    scheduleList.appendChild(card);
  });

  // G·∫Øn s·ª± ki·ªán n√∫t ƒëƒÉng k√Ω
  document.querySelectorAll('.register-btn[data-date]').forEach(btn => {
    btn.onclick = async function() {
      document.getElementById('register-modal').classList.remove('hidden');
      // Hi·ªÉn th·ªã ng√†y th√°ng nƒÉm ƒë√∫ng ƒë·ªãnh d·∫°ng nh∆∞ √¥ l·ªãch
      const dateStr = this.dataset.date;
      const weekday = getVietnameseDay(dateStr);
      const dateFormatted = formatDate(dateStr);
      document.getElementById('modal-date').textContent = `${weekday}, ng√†y ${dateFormatted}`;
      document.getElementById('modal-time').textContent = `Gi·ªù: ${this.dataset.start} ƒë·∫øn ${this.dataset.end}`;
      document.getElementById('modal-doctor').textContent = `B√°c sƒ©: ${this.dataset.doctor}`;
      document.getElementById('register-form').dataset.date = this.dataset.date;
      document.getElementById('register-form').dataset.start = this.dataset.start;
      document.getElementById('register-form').dataset.end = this.dataset.end;
      document.getElementById('register-form').dataset.doctor = this.dataset.doctor;
      // T·∫£i danh s√°ch slot tr·ªëng
      try {
        // T√¨m slot_minutes t·ª´ l·ªãch trong data ƒë√£ render (kh√¥ng c√≥ s·∫µn tr√™n DOM), n√™n g·ªçi API admin theo ng√†y ƒë·ªÉ t√¨m ca kh·ªõp
        const res = await fetch(`/api/admin/work-schedule?date=${dateStr}`);
        const shifts = await res.json();
        const matched = shifts.find(s => s.start_time === this.dataset.start && s.end_time === this.dataset.end && s.doctor_name === this.dataset.doctor);
        const slotMinutes = matched && matched.slot_minutes ? matched.slot_minutes : 10;
        const slotRes = await fetch(`/api/available-slots?date=${dateStr}&start=${this.dataset.start}&end=${this.dataset.end}&slot_minutes=${slotMinutes}`);
        const slotData = await slotRes.json();
        const select = document.getElementById('appointment-time');
        select.innerHTML = '<option value="" disabled selected>Vui l√≤ng ch·ªçn</option>';
        if (slotData.slots && slotData.slots.length) {
          slotData.slots.forEach(hhmm => {
            const opt = document.createElement('option');
            opt.value = hhmm;
            opt.textContent = hhmm;
            select.appendChild(opt);
          });
        } else {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'Kh√¥ng c√≤n khung gi·ªù tr·ªëng';
          select.appendChild(opt);
          select.value = '';
        }
      } catch (e) {
        console.error('Kh√¥ng t·∫£i ƒë∆∞·ª£c slot:', e);
      }
    };
  });

  // √Åp d·ª•ng tr·∫°ng th√°i ·∫©n/hi·ªán n√∫t ƒëƒÉng k√Ω sau khi render
  checkRegisterButtonsVisibility();
}

    // T·∫£i danh s√°ch l√Ω do kh√°m t·ª´ trang qu·∫£n tr·ªã
    async function loadReasons() {
      try {
        const res = await fetch('/api/booking-content');
        const data = await res.json();
        const reasons = Array.isArray(data.reasons) ? data.reasons : [];
        const dl = document.getElementById('reasons-list');
        dl.innerHTML = '';
        reasons.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r;
          dl.appendChild(opt);
        });
      } catch (e) {
        console.error('Kh√¥ng th·ªÉ t·∫£i l√Ω do kh√°m:', e);
      }
    }
    // Load clinic summary from API
    async function loadClinicSummary() {
        try {
            const response = await fetch('/api/home-content');
            const data = await response.json();
            if (data.clinicSummary) {
                document.getElementById('clinic-summary').textContent = data.clinicSummary;
            }
        } catch (error) {
            console.error('Error loading clinic summary:', error);
        }
    }

    // Auto-refresh clinic summary every 30 seconds
    function startClinicSummaryRefresh() {
        setInterval(loadClinicSummary, 30000); // Refresh every 30 seconds
    }

    document.addEventListener('DOMContentLoaded',()=>{
      renderSchedule();
      loadReasons();
      loadClinicSummary(); // Load clinic summary from API
      startClinicSummaryRefresh(); // Start auto-refresh
      setupSuccessTicket(); // Kh·ªüi t·∫°o modal phi·∫øu x√°c nh·∫≠n
      const dob = document.getElementById('patient-dob');
      const today = new Date().toISOString().split('T')[0];
      dob.max = today;
      
      // Ki·ªÉm tra v√† √°p d·ª•ng tr·∫°ng th√°i ·∫©n/hi·ªán n√∫t ƒëƒÉng k√Ω
      checkRegisterButtonsVisibility();
    });

    // H√†m ki·ªÉm tra v√† √°p d·ª•ng tr·∫°ng th√°i ·∫©n/hi·ªán n√∫t ƒëƒÉng k√Ω
    function checkRegisterButtonsVisibility() {
      const isHidden = localStorage.getItem('hideRegisterButtons') === 'true';
      
      if (isHidden) {
        // ·∫®n t·∫•t c·∫£ n√∫t ƒëƒÉng k√Ω kh√°m
        const style = document.createElement('style');
        style.id = 'hide-register-buttons-style';
        style.textContent = `
          .register-btn[data-date] {
            display: none !important;
          }
        `;
        document.head.appendChild(style);
      } else {
        // Hi·ªán t·∫•t c·∫£ n√∫t ƒëƒÉng k√Ω kh√°m (x√≥a style ·∫©n n·∫øu c√≥)
        const existingStyle = document.getElementById('hide-register-buttons-style');
        if (existingStyle) {
          existingStyle.remove();
        }
      }
    }

    // Theo d√µi thay ƒë·ªïi localStorage t·ª´ trang kh√°c
    window.addEventListener('storage', function(e) {
      if (e.key === 'hideRegisterButtons') {
        checkRegisterButtonsVisibility();
      }
    });

    // Theo d√µi thay ƒë·ªïi localStorage trong c√πng tab (khi ng∆∞·ªùi d√πng chuy·ªÉn tab)
    window.addEventListener('focus', function() {
      checkRegisterButtonsVisibility();
    });
    // ƒê√≥ng popup
    document.getElementById('close-modal-btn').onclick = function() {
      document.getElementById('register-modal').classList.add('hidden');
    };
    // G·ª≠i form ƒëƒÉng k√Ω
    document.getElementById('register-form').onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById('patient-name').value;
      const phone = document.getElementById('patient-phone').value;
      const dob = document.getElementById('patient-dob').value;
      const address = document.getElementById('patient-address').value;
      const reason = document.getElementById('patient-reason').value;
      const time = document.getElementById('appointment-time').value;
      const date = this.dataset.date;
      const start = this.dataset.start;
      const end = this.dataset.end;
      const doctor = this.dataset.doctor;
      if (!dob) { alert('Vui l√≤ng ch·ªçn ng√†y sinh!'); return; }
      // G·ª≠i v·ªÅ API /api/appointments (b·∫°n c√≥ th·ªÉ m·ªü r·ªông backend ƒë·ªÉ nh·∫≠n th√™m tr∆∞·ªùng gi·ªù, b√°c sƒ©)
      const res = await fetch('/api/appointments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          phone,
          date_of_birth: dob,
          address,
          service_type: reason,
          appointment_date: date,
          appointment_time: time,
          doctor_name: doctor
        })
      });
      if (res.ok) {
        const dataRes = await res.json();
        console.log('ƒêƒÉng k√Ω kh√°m th√†nh c√¥ng, hi·ªÉn th·ªã popup...');
        // Hi·ªÉn th·ªã phi·∫øu ƒëƒÉng k√Ω th√†nh c√¥ng
        if (window.showSuccessTicket) {
          console.log('G·ªçi h√†m showSuccessTicket...');
          window.showSuccessTicket({
            name,
            phone,
            date,
            time,
            doctor,
            appointmentId: dataRes.appointment_id
          });
        } else {
          console.log('H√†m showSuccessTicket kh√¥ng t·ªìn t·∫°i, hi·ªÉn th·ªã alert...');
          alert('ƒêƒÉng k√Ω th√†nh c√¥ng! T√™n: ' + name + ', SƒêT: ' + phone + ', Ng√†y: ' + date + ', Gi·ªù: ' + time + ', B√°c sƒ©: ' + doctor);
        }
      } else {
        const data = await res.json();
        alert(data.message || 'C√≥ l·ªói khi ƒëƒÉng k√Ω');
      }
    };

    // Ch·∫ø ƒë·ªô ƒëƒÉng k√Ω: l·∫ßn ƒë·∫ßu vs kh√°m l·∫°i theo s·ªë ƒêT
    (function setupRegisterModes(){
      const btnFirst = document.getElementById('register-type-first');
      const btnRepeat = document.getElementById('register-type-repeat');
      const nameEl = document.getElementById('patient-name');
      const dobEl = document.getElementById('patient-dob');
      const phoneEl = document.getElementById('patient-phone');
      const addrEl = document.getElementById('patient-address');
      const reasonEl = document.getElementById('patient-reason');
      const timeEl = document.getElementById('appointment-time');
      const timeWrap = timeEl.parentElement; // contains label + select + hint
      const dobHint = dobEl.nextElementSibling; // small hint line under DOB
      const submitBtn = document.querySelector('#register-form .register-btn');

      function setReadonlyPersonal(readonly) {
        nameEl.readOnly = readonly;
        phoneEl.readOnly = false; // always allow editing phone
        addrEl.readOnly = readonly;
        dobEl.disabled = readonly;
      }
      function setFieldsVisible(visible) {
        const display = visible ? '' : 'none';
        // Keep phone ALWAYS visible
        phoneEl.style.display = '';
        // Toggle only the following fields
        nameEl.style.display = display;
        dobEl.style.display = display;
        if (dobHint && dobHint.tagName === 'DIV') dobHint.style.display = display;
        addrEl.style.display = display;
        reasonEl.style.display = display;
        timeWrap.style.display = display;
        if (submitBtn) submitBtn.style.display = display;
      }
      function activateFirst() {
        btnFirst.style.filter = 'brightness(1)';
        btnRepeat.style.filter = 'brightness(0.8)';
        setReadonlyPersonal(false);
        nameEl.value = '';
        dobEl.value = '';
        addrEl.value = '';
        // Show all fields for first-time registration
        setFieldsVisible(true);
      }
      async function lookupByPhone(){
        const phone = phoneEl.value.trim();
        if (!/^\d{10,11}$/.test(phone)) return;
        try {
          const res = await fetch(`/api/patients/by-phone?phone=${encodeURIComponent(phone)}`);
          const data = await res.json();
          if (data && data.found) {
            if (data.name) nameEl.value = data.name;
            if (data.date_of_birth) dobEl.value = data.date_of_birth;
            if (data.phone) phoneEl.value = data.phone;
            if (data.address) addrEl.value = data.address;
            setReadonlyPersonal(true);
            // Reveal fields for user to complete reason/time and submit
            setFieldsVisible(true);
          } else {
            // Keep other fields hidden until we have a match
            setReadonlyPersonal(false);
            setFieldsVisible(false);
          }
        } catch (e) { console.warn('lookup phone failed', e); }
      }
      function activateRepeat() {
        btnRepeat.style.filter = 'brightness(1)';
        btnFirst.style.filter = 'brightness(0.8)';
        // Lock personal fields after lookup; phone remains editable for search
        setReadonlyPersonal(true);
        // Hide all fields except phone until a successful lookup
        setFieldsVisible(false);
        phoneEl.readOnly = false;
        phoneEl.removeEventListener('change', lookupByPhone);
        phoneEl.removeEventListener('blur', lookupByPhone);
        phoneEl.addEventListener('change', lookupByPhone);
        phoneEl.addEventListener('blur', lookupByPhone);
      }
      btnFirst.onclick = activateFirst;
      btnRepeat.onclick = activateRepeat;
    })();

    // Bi·∫øn ƒë·ªÉ l∆∞u tr·∫°ng th√°i n√∫t ƒëang ch·ªçn
    let currentFilter = null;

    // H√†m x·ª≠ l√Ω khi click n√∫t quay l·∫°i
    document.querySelector('.back-link').addEventListener('click', function(e) {
        if (document.getElementById('addClinicalServiceForm').elements.length > 0) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën r·ªùi kh·ªèi trang? C√°c thay ƒë·ªïi ch∆∞a l∆∞u s·∫Ω b·ªã m·∫•t.')) {
                e.preventDefault();
            }
        }
    });

    // H√†m x·ª≠ l√Ω khi click c√°c n√∫t l·ªçc
    document.querySelectorAll('.header-nav-btn[data-type]').forEach(btn => {
        btn.addEventListener('click', function() {
            // B·ªè highlight t·∫•t c·∫£ c√°c n√∫t
            document.querySelectorAll('.header-nav-btn').forEach(b => {
                b.classList.remove('active');
            });
            
            // Highlight n√∫t ƒë∆∞·ª£c ch·ªçn
            this.classList.add('active');
            
            // L∆∞u tr·∫°ng th√°i l·ªçc hi·ªán t·∫°i
            currentFilter = this.dataset.type;
            
            // L·ªçc v√† hi·ªÉn th·ªã d·ªãch v·ª•
            const filteredServices = allClinicalServices.filter(service => 
                service.service_group.toLowerCase() === currentFilter.toLowerCase()
            );
            renderClinicalServicesTable(filteredServices);
        });
    });

    // X·ª≠ l√Ω n√∫t "T·∫•t c·∫£ c√°c d·ªãch v·ª•"
    document.querySelector('.header-nav-btn:not([data-type]):not(#add-package-btn)').addEventListener('click', function() {
        // B·ªè highlight t·∫•t c·∫£ c√°c n√∫t
        document.querySelectorAll('.header-nav-btn').forEach(b => {
            b.classList.remove('active');
        });
        
        // Highlight n√∫t n√†y
        this.classList.add('active');
        
        // Reset b·ªô l·ªçc
        currentFilter = null;
        
        // Hi·ªÉn th·ªã t·∫•t c·∫£ d·ªãch v·ª•
        renderClinicalServicesTable(allClinicalServices);
    });

    // X·ª≠ l√Ω n√∫t "G√≥i c·∫≠n l√¢m s√†ng"
    document.getElementById('add-package-btn').addEventListener('click', function() {
        // ·∫®n tab qu·∫£n l√Ω d·ªãch v·ª•
        document.getElementById('clinical-services-management').classList.remove('active');
        
        // Hi·ªán tab qu·∫£n l√Ω g√≥i
        document.getElementById('package-management').classList.add('active');
        
        // B·ªè highlight t·∫•t c·∫£ c√°c n√∫t
        document.querySelectorAll('.header-nav-btn').forEach(b => {
            b.classList.remove('active');
        });
        
        // Highlight n√∫t n√†y
        this.classList.add('active');
        
        // Load danh s√°ch g√≥i n·∫øu ch∆∞a c√≥
        if (document.getElementById('existing-packages-list').children.length === 0) {
            loadExistingPackages();
        }
    });

    // Th√™m CSS cho n√∫t active
    const style = document.createElement('style');
    style.textContent = `
        .header-nav-btn.active {
            background-color: #1976D2;
            color: white;
        }
    `;
    document.head.appendChild(style);

    // H√†m load danh s√°ch g√≥i
    async function loadExistingPackages() {
        try {
            const response = await fetch('/api/clinical-packages');
            const packages = await response.json();
            
            const container = document.getElementById('existing-packages-list');
            container.innerHTML = '';
            
            if (packages.length === 0) {
                container.innerHTML = '<p>Ch∆∞a c√≥ g√≥i d·ªãch v·ª• n√†o.</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'admin-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>T√™n g√≥i</th>
                        <th>M√¥ t·∫£</th>
                        <th>Gi√°</th>
                        <th>D·ªãch v·ª•</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            packages.forEach(pkg => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${pkg.name}</td>
                    <td>${pkg.description || ''}</td>
                    <td>${pkg.price.toLocaleString('vi-VN')} VNƒê</td>
                    <td>${pkg.services.map(s => s.name).join(', ')}</td>
                    <td>
                        <button class="btn small-btn edit-package" data-id="${pkg.id}">S·ª≠a</button>
                        <button class="btn small-btn delete-package" data-id="${pkg.id}">X√≥a</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            container.appendChild(table);
            
            // Th√™m s·ª± ki·ªán cho c√°c n√∫t s·ª≠a/x√≥a
            attachPackageEventListeners();
        } catch (error) {
            console.error('Error loading packages:', error);
            showNotification('L·ªói khi t·∫£i danh s√°ch g√≥i d·ªãch v·ª•', 'error');
        }
    }

    // H√†m g·∫Øn s·ª± ki·ªán cho c√°c n√∫t trong danh s√°ch g√≥i
    function attachPackageEventListeners() {
        // X·ª≠ l√Ω n√∫t s·ª≠a
        document.querySelectorAll('.edit-package').forEach(btn => {
            btn.addEventListener('click', function() {
                const packageId = this.dataset.id;
                // TODO: Implement edit package functionality
                showNotification('Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
            });
        });
        
        // X·ª≠ l√Ω n√∫t x√≥a
        document.querySelectorAll('.delete-package').forEach(btn => {
            btn.addEventListener('click', async function() {
                const packageId = this.dataset.id;
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a g√≥i d·ªãch v·ª• n√†y?')) {
                    try {
                        const response = await fetch(`/api/clinical-packages/${packageId}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            showNotification('ƒê√£ x√≥a g√≥i d·ªãch v·ª• th√†nh c√¥ng', 'success');
                            loadExistingPackages(); // Reload danh s√°ch
                        } else {
                            throw new Error('Failed to delete package');
                        }
                    } catch (error) {
                        console.error('Error deleting package:', error);
                        showNotification('L·ªói khi x√≥a g√≥i d·ªãch v·ª•', 'error');
                    }
                }
            });
        });
    }
    // Modal phi·∫øu ƒëƒÉng k√Ω th√†nh c√¥ng + s·ª≠a gi·ªù
    function setupSuccessTicket(){
      const modal = document.createElement('div');
      modal.id = 'success-ticket-modal';
      modal.className = 'modal hidden';
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;z-index:1100;';
      modal.innerHTML = `
        <div class="modal-content" style="background:#fff;padding:2rem;border-radius:16px;min-width:400px;max-width:95vw;position:relative;box-shadow:0 8px 32px rgba(0,0,0,0.12);">
          <div style="position:absolute;top:15px;right:15px;display:flex;align-items:center;gap:10px;z-index:2;">
            <button id="capture-ticket-btn" title="Ch·ª•p ·∫£nh" style="background:#2196f3;border:none;color:white;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.2rem;transition:background 0.2s;"><i class="fas fa-camera"></i></button>
            <button id="close-success-ticket" title="ƒê√≥ng" style="background:#dc3545;border:none;color:white;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.2rem;transition:background 0.2s;"><i class="fas fa-times"></i></button>
          </div>
          <!-- Header v·ªõi logo v√† th√¥ng tin ph√≤ng kh√°m -->
          <div style="display:flex;align-items:center;justify-content:center;gap:18px;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #e3f2fd;">
            <img src="logo_phu_san_dai_anh.PNG" alt="Logo" style="height:50px;flex-shrink:0;">
            <div style="flex:1;text-align:center;display:block;">
              <div style="font-size:1.2rem;color:#1565c0;font-weight:700;">Ph√≤ng kh√°m chuy√™n khoa Ph·ª• S·∫£n ƒê·∫°i Anh</div>
              <div style="font-size:1rem;color:#e53935;font-weight:600;">Uy T√≠n - Ni·ªÅm Tin - Ch·∫•t L∆∞·ª£ng</div>
            </div>
          </div>
          <!-- Phi·∫øu x√°c nh·∫≠n -->
          <div id="ticket-body" style="background:#fafafa;border:2px solid #e0e0e0;border-radius:8px;padding:15px;margin-bottom:20px;"></div>
          
          <!-- N√∫t ch·ª©c nƒÉng -->
          <div style="margin-top:15px;">
            <button id="edit-booking-btn" class="register-btn" style="width:100%;background:#2196f3;color:white;border:none;padding:12px;border-radius:8px;font-size:1rem;cursor:pointer;">S·ª≠a th√¥ng tin ƒëƒÉng k√Ω kh√°m</button>
          </div>
          <div id="edit-time-wrap" style="display:none;margin-top:15px;padding:15px;background:#f5f5f5;border-radius:8px;">
            <label style="display:block;margin-bottom:8px;color:#555;font-weight:600;">Ch·ªçn gi·ªù m·ªõi:</label>
            <select id="edit-time-select" style="width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;font-size:1rem;"></select>
            <button id="save-new-time" class="register-btn" style="width:100%;margin-top:10px;background:#4caf50;color:white;border:none;padding:10px;border-radius:6px;cursor:pointer;">L∆∞u gi·ªù m·ªõi</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // X·ª≠ l√Ω n√∫t ch·ª•p ·∫£nh
      const captureBtn = document.getElementById('capture-ticket-btn');
      if (captureBtn) {
        captureBtn.addEventListener('click', async function() {
          // Ki·ªÉm tra html2canvas ƒë√£ ƒë∆∞·ª£c load ch∆∞a
          if (typeof html2canvas === 'undefined') {
            alert('Th∆∞ vi·ªán ch·ª•p ·∫£nh ch∆∞a s·∫µn s√†ng. Vui l√≤ng t·∫£i l·∫°i trang.');
            return;
          }
          
          try {
            const modalContent = modal.querySelector('.modal-content');
            if (!modalContent) {
              alert('Kh√¥ng t√¨m th·∫•y n·ªôi dung ƒë·ªÉ ch·ª•p ·∫£nh');
              return;
            }
            
            // Hi·ªÉn th·ªã th√¥ng b√°o ƒëang x·ª≠ l√Ω
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            this.disabled = true;
            
            // Ch·ª•p ·∫£nh b·∫±ng html2canvas
            const canvas = await html2canvas(modalContent, {
              backgroundColor: '#ffffff',
              scale: 2,
              logging: false,
              useCORS: true,
              allowTaint: false
            });
            
            // Chuy·ªÉn canvas th√†nh blob v√† t·∫£i xu·ªëng
            canvas.toBlob(function(blob) {
              if (!blob) {
                alert('Kh√¥ng th·ªÉ t·∫°o file ·∫£nh');
                captureBtn.innerHTML = originalText;
                captureBtn.disabled = false;
                return;
              }
              
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.download = `phieu-dang-ky-kham-${new Date().getTime()}.png`;
              link.href = url;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
              
              // Kh√¥i ph·ª•c n√∫t
              captureBtn.innerHTML = originalText;
              captureBtn.disabled = false;
            }, 'image/png');
          } catch (error) {
            console.error('L·ªói khi ch·ª•p ·∫£nh:', error);
            alert('C√≥ l·ªói x·∫£y ra khi ch·ª•p ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.');
            captureBtn.innerHTML = '<i class="fas fa-camera"></i>';
            captureBtn.disabled = false;
          }
        });
      }

      function formatVNDate(dStr){
        const d = new Date(dStr);
        return d.toLocaleDateString('vi-VN');
      }
      
      // ƒê·ªãnh nghƒ©a h√†m showSuccessTicket
      window.showSuccessTicket = async ({name, phone, date, time, doctor, appointmentId}) => {
        console.log('H√†m showSuccessTicket ƒë∆∞·ª£c g·ªçi v·ªõi:', {name, phone, date, time, doctor, appointmentId});
        document.getElementById('register-modal').classList.add('hidden');
        
        // Hi·ªÉn th·ªã t√™n b√°c sƒ© ·ªü ƒë·∫ßu phi·∫øu
        // X√ìA d√≤ng hi·ªÉn th·ªã t√™n b√°c sƒ© ph√≠a tr√™n d√≤ng ƒêƒÇNG K√ù TH√ÄNH C√îNG (kh√¥ng c·∫ßn set ticket-doctor-name)
        
        const ticket = document.getElementById('ticket-body');
        ticket.innerHTML = `
          <div style="text-align:center;margin-bottom:15px;">
            <div style="font-size:1.3rem;color:#2e7d32;font-weight:700;padding:10px;background:#e8f5e8;border-radius:6px;border:2px solid #4caf50;">
              ‚úì ƒêƒÇNG K√ù TH√ÄNH C√îNG
            </div>
          </div>
          <table style="width:100%;border-collapse:collapse;font-size:1rem;">
            <tr style="background:#f5f5f5;">
              <td style="padding:12px;border:1px solid #ddd;font-weight:600;width:40%;color:#333;">H·ªç v√† t√™n:</td>
              <td style="padding:12px;border:1px solid #ddd;font-weight:600;color:#d32f2f;">${name}</td>
            </tr>
            <tr>
              <td style="padding:12px;border:1px solid #ddd;font-weight:600;color:#333;">S·ªë ƒëi·ªán tho·∫°i:</td>
              <td style="padding:12px;border:1px solid #ddd;font-weight:600;color:#1976d2;">${phone}</td>
            </tr>
            <tr style="background:#f5f5f5;">
              <td style="padding:12px;border:1px solid #ddd;font-weight:600;color:#333;">Ng√†y ƒëƒÉng k√Ω:</td>
              <td style="padding:12px;border:1px solid #ddd;font-weight:600;color:#2e7d32;">${formatVNDate(date)}</td>
            </tr>
            <tr>
              <td style="padding:12px;border:1px solid #ddd;font-weight:600;color:#333;">Gi·ªù h·∫πn kh√°m:</td>
              <td style="padding:12px;border:1px solid #ddd;font-weight:600;color:#f57c00;">${time}</td>
            </tr>
            <tr style="background:#f5f5f5;">
              <td style="padding:12px;border:1px solid #ddd;font-weight:600;color:#333;">B√°c sƒ© kh√°m:</td>
              <td style="padding:12px;border:1px solid #ddd;font-weight:600;color:#1565c0;">${doctor}</td>
            </tr>
          </table>
          <div style="text-align:center;margin-top:15px;padding:10px;background:#e3f2fd;border-radius:6px;color:#1565c0;font-weight:600;">
            C·∫£m ∆°n b·∫°n ƒë√£ tin t∆∞·ªüng ph√≤ng kh√°m ch√∫ng t√¥i!
          </div>
        `;
        console.log('Hi·ªÉn th·ªã modal...');
        modal.classList.remove('hidden');
        console.log('Modal ƒë√£ ƒë∆∞·ª£c hi·ªÉn th·ªã');

        // Setup edit action
        const btnEdit = document.getElementById('edit-booking-btn');
        const closeBtn = document.getElementById('close-success-ticket');
        const editWrap = document.getElementById('edit-time-wrap');
        const editSelect = document.getElementById('edit-time-select');
        const saveBtn = document.getElementById('save-new-time');
        closeBtn.onclick = () => { modal.classList.add('hidden'); };
        btnEdit.onclick = async () => {
          editWrap.style.display = '';
          // L·∫•y slot tr·ªëng c·ªßa c√πng ca ƒë·ªÉ ch·ªânh
          try {
            const wsRes = await fetch(`/api/admin/work-schedule?date=${date}`);
            const shifts = await wsRes.json();
            const matched = shifts.find(s => s.doctor_name === doctor && s.start_time <= time && time < s.end_time);
            const slotMinutes = matched && matched.slot_minutes ? matched.slot_minutes : 10;
            const r = await fetch(`/api/available-slots?date=${date}&start=${matched.start_time}&end=${matched.end_time}&slot_minutes=${slotMinutes}&exclude_appointment_id=${appointmentId}`);
            const data = await r.json();
            editSelect.innerHTML = '';
            const cur = document.createElement('option');
            cur.value = time; cur.textContent = `${time} (hi·ªán t·∫°i)`;
            editSelect.appendChild(cur);
            (data.slots||[]).forEach(h => { const o = document.createElement('option'); o.value=h; o.textContent=h; editSelect.appendChild(o); });
            editSelect.value = time;
          } catch (e) { console.warn('load edit slots failed', e); }
        };
        saveBtn.onclick = async () => {
          const newTime = editSelect.value;
          if (!newTime) return;
          try {
            const resp = await fetch(`/api/appointments/${appointmentId}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ appointment_date: date, appointment_time: newTime }) });
            if (!resp.ok) { const d = await resp.json(); alert(d.message||'Kh√¥ng l∆∞u ƒë∆∞·ª£c gi·ªù m·ªõi'); return; }
            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
            const tds = ticket.querySelectorAll('td');
            // row 4 value cell (order above) contains time
            tds[7].textContent = newTime;
            alert('ƒê√£ c·∫≠p nh·∫≠t gi·ªù kh√°m');
          } catch (e) { alert('L·ªói khi c·∫≠p nh·∫≠t gi·ªù'); }
        };
      };
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    
    <!-- Footer -->
    <footer class="footer" style="background: #333; color: white; text-align: center; padding: 2rem; margin-top: 3rem;">
        <div class="container">
            <p>&copy; 2025 Ph√≤ng kh√°m chuy√™n khoa Ph·ª• S·∫£n ƒê·∫°i Anh. All rights reserved.</p>
        </div>
    </footer>

    <!-- AI Assistant - Lu√¥n hi·ªÉn th·ªã tr√™n m·ªçi trang -->
    <script src="ai-assistant.js"></script>
</body>
</html>