<!-- Worklist Sync Section for Admin Panel -->
<div id="worklistSyncSection" style="margin: 20px 0; padding: 20px; background: #f5f5f5; border-radius: 8px; display: none;">
    <h3>üîÑ ƒê·ªìng b·ªô Worklist DICOM</h3>
    <p style="color: #666;">ƒê·ªìng b·ªô th√¥ng tin ch·ªâ ƒë·ªãnh si√™u √¢m t·ª´ h·ªá th·ªëng ch√≠nh sang Worklist c·ªßa m√°y si√™u √¢m</p>
    
    <div style="margin: 15px 0;">
        <button id="syncWorklistBtn" class="btn btn-primary" style="margin-right: 10px;">
            <i class="icon">‚Üª</i> ƒê·ªìng b·ªô Worklist Ngay
        </button>
        <span id="syncStatus" style="display: none; margin-left: 10px;">
            <i class="spinner" style="display: inline-block; animation: spin 1s linear infinite;">‚ü≥</i>
            <span id="syncMessage"></span>
        </span>
    </div>
    
    <div id="syncResult" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;">
        <p id="syncResultText"></p>
    </div>
    
    <div style="margin-top: 10px; font-size: 12px; color: #999;">
        <p>‚ÑπÔ∏è Worklist s·∫Ω t·ª± ƒë·ªông ƒë·ªìng b·ªô m·ªói 5 ph√∫t</p>
        <p>L·∫ßn ƒë·ªìng b·ªô cu·ªëi: <span id="lastSyncTime">Ch∆∞a c·∫≠p nh·∫≠t</span></p>
    </div>
</div>

<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.spinner {
    animation: spin 1s linear infinite;
}
</style>

<script>
// Ki·ªÉm tra quy·ªÅn manage_worklist v√† hi·ªÉn th·ªã section
async function initWorklistSync() {
    try {
        const token = localStorage.getItem('auth_token');
        if (!token) return;
        
        // L·∫•y danh s√°ch permissions
        const res = await fetch('/api/permissions', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await res.json();
        const permissions = data.permissions || [];
        
        // Hi·ªÉn th·ªã n·∫øu c√≥ quy·ªÅn manage_worklist
        if (permissions.includes('manage_worklist')) {
            document.getElementById('worklistSyncSection').style.display = 'block';
            setupWorklistSyncHandlers();
        }
    } catch (e) {
        console.log('Could not initialize worklist sync:', e);
    }
}

function setupWorklistSyncHandlers() {
    const syncBtn = document.getElementById('syncWorklistBtn');
    
    if (!syncBtn) return;
    
    syncBtn.addEventListener('click', async () => {
        await performWorklistSync();
    });
    
    // Load last sync time
    updateLastSyncTime();
}

async function performWorklistSync() {
    const syncBtn = document.getElementById('syncWorklistBtn');
    const syncStatus = document.getElementById('syncStatus');
    const syncResult = document.getElementById('syncResult');
    const syncMessage = document.getElementById('syncMessage');
    const syncResultText = document.getElementById('syncResultText');
    
    try {
        syncBtn.disabled = true;
        syncStatus.style.display = 'inline';
        syncResult.style.display = 'none';
        syncMessage.textContent = 'ƒêang ƒë·ªìng b·ªô...';
        
        const token = localStorage.getItem('auth_token');
        const response = await fetch('/api/mwl-sync', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        syncStatus.style.display = 'none';
        syncResult.style.display = 'block';
        
        if (data.success) {
            syncResult.style.backgroundColor = '#d4edda';
            syncResult.style.color = '#155724';
            syncResult.style.borderLeft = '4px solid #28a745';
            syncResultText.innerHTML = `<strong>‚úì Th√†nh c√¥ng:</strong> ${data.message}<br>${data.details || ''}`;
            updateLastSyncTime();
        } else {
            syncResult.style.backgroundColor = '#f8d7da';
            syncResult.style.color = '#721c24';
            syncResult.style.borderLeft = '4px solid #dc3545';
            syncResultText.innerHTML = `<strong>‚úó L·ªói:</strong> ${data.message}<br>${data.error || ''}`;
        }
        
        // T·ª± ƒë·ªông ·∫©n result sau 5 gi√¢y
        setTimeout(() => {
            syncResult.style.display = 'none';
        }, 5000);
        
    } catch (error) {
        syncStatus.style.display = 'none';
        syncResult.style.display = 'block';
        syncResult.style.backgroundColor = '#f8d7da';
        syncResult.style.color = '#721c24';
        syncResult.style.borderLeft = '4px solid #dc3545';
        syncResultText.innerHTML = `<strong>‚úó L·ªói:</strong> ${error.message}`;
    } finally {
        syncBtn.disabled = false;
    }
}

function updateLastSyncTime() {
    const lastTime = localStorage.getItem('lastWorklistSync');
    if (lastTime) {
        const date = new Date(lastTime);
        document.getElementById('lastSyncTime').textContent = date.toLocaleString('vi-VN');
    }
}

// Kh·ªüi t·∫°o khi admin panel load
document.addEventListener('DOMContentLoaded', initWorklistSync);
</script>
